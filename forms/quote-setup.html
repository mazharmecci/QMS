<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ISTOS Medical Private Limited</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at 25% 25%, #3b82f6 0, #3f5a91 40%, #020617 100%);
      --card-bg: #ffffff; /* white main window */
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.18);
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-soft: 0 24px 70px rgba(15, 23, 42, 0.45);
      --border-subtle: 1px solid rgba(148, 163, 184, 0.26);
    }
    
    /* ===== Base layout ===== */
    
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color: var(--text-main);
      background: #020617; /* dark base behind gradient */
    }
    
    .quote-setup-gradient {
      position: fixed;
      inset: 0;
      background: var(--bg-gradient);
      opacity: 0.9;
      filter: blur(2px);
      z-index: -2;
    }
    
    /* ===== Header ===== */
    
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(15, 23, 42, 0.94);
      border-bottom: var(--border-subtle);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: #e5e7eb;
    }
    
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0.7rem 1.5rem;
    }
    
    .back-btn {
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease-out;
    }
    
    .back-btn:hover {
      background: rgba(15, 23, 42, 1);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.7);
      transform: translateY(-1px);
    }
    
    .header-title {
      flex: 1;
      text-align: center;
      font-weight: 600;
      font-size: 1.35rem;
      letter-spacing: 0.04em;
    }
    
    /* ===== Shell + main card ===== */
    
    .quote-setup-shell {
      min-height: calc(100vh - 56px);
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 24px 20px;
      background: var(--card-bg); /* white window */
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      border: var(--border-subtle);
      color: var(--text-main);
    }
    
    /* ===== Headings ===== */
    
    h2 {
      color: var(--text-main);
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.55rem;
    }
    
    h2::after {
      content: "";
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, rgba(148, 163, 184, 0.6), transparent);
    }
    
    /* ===== Form layout ===== */
    
    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem 1.1rem;
    }
    
    form input,
    form select {
      padding: 0.7rem 0.95rem;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.9rem;
      background: rgba(248, 250, 252, 0.9);
      color: var(--text-main);
      transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
    }
    
    form input::placeholder {
      color: var(--text-muted);
    }
    
    form input:focus,
    form select:focus {
      outline: none;
      border-color: var(--accent);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
    }
    
    form button {
      grid-column: span 2;
      padding: 0.9rem 1.2rem;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      color: #fff;
      border: none;
      border-radius: 999px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s ease-out;
      box-shadow: 0 12px 26px rgba(37, 99, 235, 0.6);
    }
    
    form button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(37, 99, 235, 0.75);
    }
    
    /* Subtle per-field tones, now on light inputs */
    
    input[type="text"],
    input[type="email"] {
      background-color: rgba(37, 99, 235, 0.06);
    }
    
    input[type="number"] {
      background-color: rgba(148, 163, 184, 0.1);
    }
    
    select {
      background-color: rgba(248, 113, 113, 0.06);
    }
    
    input[readonly] {
      background-color: #f3f4f6;
      border: 1px solid rgba(148, 163, 184, 0.6);
      cursor: not-allowed;
      color: #6b7280;
    }
    
    /* Helpers / layout rows */
    
    .tooltip {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.18rem;
      margin-bottom: 0.7rem;
    }
    
    .form-row {
      grid-column: span 2;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .form-row > * {
      flex: 1 1 0;
    }
    
    .date-field {
      display: flex;
      flex-direction: column;
      flex: 1 1 0;
    }
    
    #yourReference {
      min-width: 250px;
    }
    
    /* ===== Kind Attn highlight ===== */
    
    .kind-attn-box {
      grid-column: span 2;
      margin: 0.8rem 0 0.3rem;
      background: rgba(37, 99, 235, 0.08);
      padding: 0.6rem 0.85rem;
      border-radius: var(--radius-sm);
      font-weight: 600;
      color: var(--accent);
      border: 1px solid rgba(59, 130, 246, 0.5);
    }
    
    .kind-attn-box input {
      background: transparent;
      border: none;
      font-weight: 600;
      color: var(--accent);
      width: 80%;
      outline: none;
    }
    
    /* ===== Sales note (white block) ===== */
    
    .sales-note-block {
      grid-column: span 2;
      margin-top: 1rem;
    }
    
    .sales-note-label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    
    #salesNote {
      width: 100%;
      min-height: 90px;
      padding: 0.6rem 0.75rem;
      font-size: 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      border-radius: var(--radius-sm);
      resize: vertical;
      background: #ffffff;                 /* white background */
      font-family: system-ui, sans-serif;
      white-space: pre-wrap;
      color: var(--text-main);             /* dark text */
    }
    
    #salesNote::placeholder {
      color: var(--text-muted);
      white-space: pre-line;               /* keep your multiline placeholder formatting */
    }
    
    #salesNote:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.35);
    }
    
    /* ===== Terms block (white panel) ===== */
    
    .terms-heading {
      grid-column: span 2;
      font-size: 0.9rem;
      font-weight: 700;
      margin-top: 1.2rem;
      margin-bottom: 0.4rem;
      color: var(--text-main);
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      padding-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    
    #termsTextBlock {
      grid-column: span 2;
      margin-top: 0.4rem;
      padding: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      border-radius: var(--radius-md);
      background: #ffffff;                 /* white background */
      font-size: 0.8rem;
      line-height: 1.5;
      color: var(--text-main);             /* dark text */
      max-height: 360px;
      overflow-y: auto;
    }
    
    #termsTextBlock p {
      margin: 0.5rem 0;
    }
    
    #termsTextBlock strong {
      color: var(--text-main);
      font-weight: 700;
    }
    
    .terms-indent {
      margin: 0.5rem 0 1rem 1.25rem;
    }
    
    .terms-indent ol {
      padding-left: 1rem;
      margin: 0;
    }
    
    .terms-indent li {
      margin-bottom: 0.45rem;
      font-size: 0.8rem;
      line-height: 1.5;
    }
    
    .terms-indent li::marker {
      font-weight: 600;
      color: var(--text-muted);
    }

    /* Quote signer highlight preserved */
    
    .quote-sender-highlight {
      background-color: #ffc94d;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      color: #1e293b;
      border: 1px solid #fbbf24;
      display: inline-block;
      margin-top: 8px;
    }
    
    /* ===== Responsive ===== */
    
    @media (max-width: 768px) {
      .quote-setup-shell {
        padding: 16px;
      }
    
      .container {
        padding: 18px 14px;
        border-radius: 16px;
      }
    
      form {
        grid-template-columns: 1fr;
      }
    
      form button {
        grid-column: span 1;
      }
    }

  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <button type="button" class="back-btn" id="backBtn">← Back</button>
      <div class="header-title">ISTOS Medical - Quote setup</div>
    </div>
  </header>

<div class="container">
  <h2>Quote Builder</h2>

  <form id="quoteSetupForm">
    <div class="form-row">
      <select id="hospitalSelect" required>
        <option value="">Select Hospital</option>
      </select>
    </div>

    <input
      type="text"
      id="quoteNo"
      placeholder="Quote No. (auto)"
      readonly
      title="Read-only auto-generated Quote No."
    >

    <div class="form-row">
      <div class="date-field">
        <input type="date" id="quoteDate" required>
        <div class="tooltip">Quotation Date</div>
      </div>

      <div class="date-field">
        <input type="date" id="refDate" required>
        <div class="tooltip">Reference Date</div>
      </div>
    </div>

    <select id="yourReference" required>
      <option value="">Select Reference Type</option>
      <option value="Telephonic">Telephonic</option>
      <option value="Email">Email</option>
      <option value="Email">Personal visit</option>
    </select>

    <input type="text" id="hospitalName" placeholder="Hospital / Client Name" readonly required>
    <input type="text" id="hospitalAddress" placeholder="Hospital Address" readonly required>

    <div class="kind-attn-box">
      KIND ATTN:
      <input type="text" id="kindAttn" placeholder="Name" required>
    </div>

    <input type="text" id="contactPerson" placeholder="Contact Person" required>
    <input type="text" id="contactPhone" placeholder="Handphone" required>
    <input type="text" id="officePhone" placeholder="Office Phone">
    <input type="email" id="contactEmail" placeholder="Email" required>

    <div class="sales-note-block">
      <label for="salesNote" class="sales-note-label">Personal message to customer</label>
      <textarea
        id="salesNote"
        rows="4"
        placeholder="Dear Sir,

As discussed with Mr. Sarfaraz Khan, please find below the budgetary list prices for your kind perusal, upon confirmation of the ancillary equipment’s required we will submit a very special package price."></textarea>
    </div>

    <div id="termsTextBlock" contenteditable="true">
      <div class="terms-section">
        <p>
          These terms and conditions govern the sale of Products (“Product or Products”) and provisions of services (“Services”) by <strong>ISTOS Medical Pvt Ltd.</strong> (IMPL). These terms and conditions (“Agreement”) take precedence over Buyer’s supplemental or conflicting terms and conditions.
        </p>

        <p><strong>Validity:</strong> This offer is valid for 60 days from the date of the offer.</p>

        <p><strong>Purchase Order:</strong> Favouring <strong>ISTOS Medical Private Limited</strong>, # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area, Bikasipura Main Road, Yelachenahalli, BANGALORE, Karnataka, INDIA 560 062.</p>

        <p><strong>Delivery and Title:</strong></p>
        <div class="terms-indent">
          <ol>
            <li>All deliveries will be made “F.O.R Basis” to the place of shipment as mentioned in the order.</li>
            <li>Delivery Period: 6–8 weeks from the date of receipt of a valid purchase order.</li>
            <li>The seller will not be responsible for any delay in delivery beyond its control but will do its utmost to ensure speedy delivery. Delayed delivery of any part of an order does not entitle the buyer to cancel other deliveries.</li>
            <li>The ownership of the goods will be transferred to the buyer after receipt of full payment.</li>
          </ol>
        </div>

        <p><strong>Payment:</strong> 100% in advance along with a valid purchase order. Our bankers’ details will be mentioned in our invoice / proforma invoice. Payment may be made by RTGS | NEFT | IMPS | Cheque | Draft.</p>

        <p><strong>Warranty:</strong> 12 months from the date of installation against any manufacturing defects. The consumables, other accessories, glass parts and other easily damageable items do not carry any warranty. Unauthorized usage and mishandling of the equipment will void the warranty.</p>

        <p><strong>Government Levies:</strong> GST EXTRA @ 18% on all offered products.</p>
      </div>

      <div style="margin-top:40px; text-align:left;">
        <p>------------------------------</p>
        <p><strong>For ISTOS Medical Private Limited</strong></p>
        <br><br>
        <div class="quote-sender-highlight">Guest</div>
      </div>
    </div>

    <button type="submit">Proceed to Quote</button>
  </form>
</div>

<script type="module">
  import { auth, db } from "../js/firebase.js";
  import { 
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { 
    collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  // ===== Go back handler =====
  function goBack() {
    if (window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = 'index.html';
    }
  }

  // ===== Fetch last quoteNo from Firestore =====
  async function fetchLastQuoteNo() {
    try {
      const q = query(collection(db, "quoteHistory"), orderBy("quoteNo", "desc"), limit(1));
      const snap = await getDocs(q);

      if (!snap.empty) {
        const lastDoc = snap.docs[0].data();
        return lastDoc.quoteNo || "EQ/SQ/25-26/00000";
      }
      return "EQ/SQ/25-26/00000";
    } catch (err) {
      console.error("[fetchLastQuoteNo] Error fetching last quote:", err);
      return "EQ/SQ/25-26/00000";
    }
  }

  // ===== Generate next quoteNo =====
  async function generateQuoteNo() {
    const lastNo = await fetchLastQuoteNo();
    const parts = lastNo.split("/");
    const num = parseInt(parts[parts.length - 1], 10) + 1;
    return `EQ/SQ/25-26/${String(num).padStart(5, "0")}`;
  }

  // ===== Populate hospital dropdown =====
  function populateHospitalDropdown() {
    const hospitals = JSON.parse(localStorage.getItem('hospitals') || '[]');
    const select = document.getElementById('hospitalSelect');
    select.innerHTML = ""; // clear old options
    hospitals.forEach((hosp, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = `${hosp.clientCode} - ${hosp.clientName}`;
      select.appendChild(opt);
    });
  }

  // ===== Fill hospital details =====
  function fillHospitalDetails() {
    const hospitals = JSON.parse(localStorage.getItem('hospitals') || '[]');
    const idx = document.getElementById('hospitalSelect').value;
    if (idx === '') return;
    const hosp = hospitals[idx];
    if (!hosp) return;

    document.getElementById('hospitalName').value = hosp.clientName || '';
    document.getElementById('hospitalAddress').value = hosp.address || '';
    document.getElementById('contactPhone').value = hosp.mobile || '';
    document.getElementById('contactEmail').value = hosp.email || '';
  }

  // ===== Dynamic quote sender name from auth email =====
  const quoteSenderEl = document.getElementById("quoteSender");
  onAuthStateChanged(auth, (user) => {
    if (!quoteSenderEl) return;
    if (!user || !user.email) {
      quoteSenderEl.textContent = "Guest";
      return;
    }
    const email = user.email;
    const prefix = email.split("@")[0] || "User";
    const prettyName = prefix
      .replace(/[._-]+/g, " ")
      .split(" ")
      .map(p => p.charAt(0).toUpperCase() + p.slice(1))
      .join(" ");
    quoteSenderEl.textContent = prettyName;
  });

  // ===== Submit handler =====
  document.getElementById('quoteSetupForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const termsBlock = document.getElementById('termsTextBlock');
    const headerData = {
      quoteNo: document.getElementById('quoteNo').value || '',
      quoteDate: document.getElementById('quoteDate').value || '',
      yourReference: document.getElementById('yourReference').value || '',
      refDate: document.getElementById('refDate').value || '',
      hospitalName: document.getElementById('hospitalName').value || '',
      hospitalAddress: document.getElementById('hospitalAddress').value || '',
      kindAttn: document.getElementById('kindAttn').value || '',
      contactPerson: document.getElementById('contactPerson').value || '',
      contactPhone: document.getElementById('contactPhone').value || '',
      contactEmail: document.getElementById('contactEmail').value || '',
      officePhone: document.getElementById('officePhone').value || '',
      salesNote: document.getElementById('salesNote').value || '',
      termsHtml: termsBlock.innerHTML,
      quoteLines: [],
      status: "DRAFT"
    };

    try {
      const user = auth.currentUser;
      if (!user) {
        alert("You must be signed in to save quotes.");
        return;
      }

      // Save to Firestore immediately
      const colRef = collection(db, "quoteHistory");
      const newDoc = await addDoc(colRef, {
        ...headerData,
        createdAt: serverTimestamp(),
        createdBy: user.uid,
        createdByLabel: user.displayName || user.email || user.uid
      });

      console.log("[quoteSetupForm] New quote saved to Firestore with id:", newDoc.id);

      // Save to localStorage for continuity in quotes.html
      localStorage.setItem('quoteHeader', JSON.stringify({
        ...headerData,
        docId: newDoc.id
      }));

      // Redirect to quotes.html with docId in URL
      window.location.href = `quotes.html?id=${newDoc.id}`;
    } catch (err) {
      console.error("[quoteSetupForm] Error saving quote to Firestore:", err);
      alert("Failed to save quote. Please try again.");
    }
  });

  // ===== Initial values =====
  (async () => {
    const newQuoteNo = await generateQuoteNo();
    document.getElementById('quoteNo').value = newQuoteNo;

    const todayISO = new Date().toISOString().slice(0, 10);
    document.getElementById('quoteDate').value = todayISO;
    document.getElementById('refDate').value = todayISO;

    populateHospitalDropdown();
    document.getElementById('hospitalSelect').addEventListener('change', fillHospitalDetails);
  })();
</script>

</body>
</html>
