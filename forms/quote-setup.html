<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ISTOS Medical Private Limited</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Aptos Display', system-ui, 'Inter', sans-serif;
      background:#f5f7fa;
      margin:0;
    }
    header {
      background:#0d6efd;
      color:#fff;
      padding:0.75rem 1.5rem;
    }
    .header-inner {
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .back-btn {
      border:none;
      background:rgba(255,255,255,0.12);
      color:#fff;
      padding:0.45rem 0.9rem;
      border-radius:999px;
      cursor:pointer;
    }
    .header-title {
      flex:1;
      text-align:center;
      font-weight:600;
      font-size:1.5rem;
    }

    .container {
      max-width:1200px;
      margin:2rem auto;
      padding:2rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    h2 { color:#0d6efd; margin-bottom:1rem; }
    form {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
    }
    form input,
    form select {
      padding:0.75rem 1rem;
      border:1px solid #d0d4d9;
      border-radius:8px;
      font-size:0.95rem;
      background:#fff;
      transition:border-color 0.2s ease, box-shadow 0.2s ease;
    }
    form input:focus,
    form select:focus {
      border-color:#0d6efd;
      box-shadow:0 0 0 3px rgba(13,110,253,0.2);
      outline:none;
    }
    form button {
      grid-column:span 2;
      padding:0.9rem 1.2rem;
      background:#0d6efd;
      color:#fff;
      border:none;
      border-radius:8px;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:background 0.2s ease;
    }
    form button:hover { background:#084298; }

    input[type="text"],
    input[type="email"] { background-color:#e3f2fd; }
    input[type="number"] { background-color:#f0f0f0; }
    select { background-color:#ffe4e1; }
    input[readonly] {
      background-color:#fff;
      border:1px solid #ccc;
      cursor:not-allowed;
    }

    .tooltip {
      font-size:0.75rem;
      color:#555;
      margin-top:0.25rem;
      margin-bottom:0.75rem;
    }
    .form-row {
      grid-column:span 2;
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
    }
    .form-row > * { flex:1 1 0; }
    .date-field { display:flex; flex-direction:column; flex:1 1 0; }

    .kind-attn-box {
      grid-column:span 2;
      margin:1rem 0;
      background:#e0f0ff;
      padding:0.75rem 1rem;
      border-radius:8px;
      font-weight:600;
      color:#0d6efd;
    }
    .kind-attn-box input {
      background:transparent;
      border:none;
      font-weight:600;
      color:#0d6efd;
      width:80%;
      outline:none;
    }

    #instrumentPreview {
      grid-column:span 2;
      display:none;
      font-size:0.85rem;
      color:#333;
      background:#f8fafc;
      border-radius:8px;
      padding:0.5rem 0.75rem;
      border:1px dashed #cbd5e1;
    }
    #instrumentSelect,
    #yourReference { min-width:250px; }

    .sales-note-block {
      grid-column:span 2;
      margin-top:1rem;
    }
    .sales-note-label {
      display:block;
      font-size:12px;
      font-weight:600;
      margin-bottom:0.25rem;
      color:#444;
    }
    #salesNote {
      width:100%;
      min-height:90px;
      padding:0.6rem 0.75rem;
      font-size:13px;
      border:1px solid #d0d4d9;
      border-radius:6px;
      resize:vertical;
      background:#fff;
      font-family:'Inter',sans-serif;
      white-space:pre-wrap;
    }
    #salesNote:focus {
      outline:none;
      border-color:#0d6efd;
      box-shadow:0 0 0 3px rgba(13,110,253,0.15);
    }

    /* Terms & Conditions block */
    .terms-heading {
      font-size:16px;
      font-weight:700;
      margin-bottom:0.5rem;
      color:#000;
      border-bottom:1px solid #ccc;
      padding-bottom:0.25rem;
    }
    #termsTextBlock p {
      margin:0.5rem 0;
    }
    #termsTextBlock {
      grid-column:span 2;
      margin-top:1rem;
      padding:1rem;
      border:1px solid #ccc;
      border-radius:6px;
      background:#f9f9f9;
      font-size:13px;
      line-height:1.4;
      color:#222;
    }
    #termsTextBlock strong {
      color:#000;
      font-weight:700;
    }
    .terms-indent {
      margin:0.5rem 0 1rem 1.25rem;
    }
    .terms-indent ol {
      padding-left:1rem;
      margin:0;
    }
    .terms-indent li {
      margin-bottom:0.5rem;
      font-size:13px;
      line-height:1.4;
    }
    .terms-indent li::marker {
      font-weight:600;
      color:#444;
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <button type="button" class="back-btn" onclick="goBack()">← Back</button>
    <div class="header-title">ISTOS Medical - Quote Setup</div>
  </div>
</header>

<div class="container">
  <h2>Quote Builder</h2>

  <form id="quoteSetupForm">
    <div class="form-row">
      <select id="hospitalSelect" required>
        <option value="">Select Hospital</option>
      </select>

      <select id="instrumentSelect" required>
        <option value="">Select Instrument</option>
      </select>
    </div>

    <div id="instrumentPreview">
      <strong>Selected Instrument:</strong>
      <span id="instrumentDetails"></span>
    </div>

    <input
      type="text"
      id="quoteNo"
      placeholder="Quote No. (auto)"
      readonly
      title="Read-only auto-generated Quote No."
    >

    <div class="form-row">
      <div class="date-field">
        <input type="date" id="quoteDate" required>
        <div class="tooltip">Quotation Date</div>
      </div>

      <div class="date-field">
        <input type="date" id="refDate" required>
        <div class="tooltip">Reference Date</div>
      </div>
    </div>

    <select id="yourReference" required>
      <option value="">Select Reference Type</option>
      <option value="Telephonic">Telephonic</option>
      <option value="Email">Email</option>
      <option value="Email">Personal visit</option>
    </select>

    <input type="text" id="hospitalName" placeholder="Hospital / Client Name" readonly required>
    <input type="text" id="hospitalAddress" placeholder="Hospital Address" readonly required>

    <div class="kind-attn-box">
      KIND ATTN:
      <input type="text" id="kindAttn" placeholder="Name" required>
    </div>

    <input type="text" id="contactPerson" placeholder="Contact Person" required>
    <input type="text" id="contactPhone" placeholder="Handphone" required>
    <input type="text" id="officePhone" placeholder="Office Phone" required>
    <input type="email" id="contactEmail" placeholder="Email" required>

    <div class="sales-note-block">
      <label for="salesNote" class="sales-note-label">Personal message to customer</label>
      <textarea
        id="salesNote"
        rows="4"
        placeholder="Dear Sir,

As discussed with Mr. Sarfaraz Khan, please find below the budgetary list prices for your kind perusal, upon confirmation of the ancillary equipment’s required we will submit a very special package price."></textarea>
    </div>

    <!-- editable Terms & Conditions -->
    <div id="termsTextBlock" contenteditable="true">
      <div class="terms-section">
        <p>
          These terms and conditions govern the sale of Products (“Product or Products”) and provisions of services (“Services”) by <strong>ISTOS Medical Pvt Ltd.</strong> (IMPL). These terms and conditions (“Agreement”) take precedence over Buyer’s supplemental or conflicting terms and conditions.
        </p>

        <p><strong>Validity:</strong> This offer is valid for 60 days from the date of the offer.</p>

        <p><strong>Purchase Order:</strong> Favouring <strong>ISTOS Medical Private Limited</strong>, # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area, Bikasipura Main Road, Yelachenahalli, BANGALORE, Karnataka, INDIA 560 062.</p>

        <p><strong>Delivery and Title:</strong></p>
        <div class="terms-indent">
          <ol>
            <li>All deliveries will be made “F.O.R Basis” to the place of shipment as mentioned in the order.</li>
            <li>Delivery Period: 6–8 weeks from the date of receipt of a valid purchase order.</li>
            <li>The seller will not be responsible for any delay in delivery beyond its control but will do its utmost to ensure speedy delivery. Delayed delivery of any part of an order does not entitle the buyer to cancel other deliveries.</li>
            <li>The ownership of the goods will be transferred to the buyer after receipt of full payment.</li>
          </ol>
        </div>

        <p><strong>Payment:</strong> 100% in advance along with a valid purchase order. Our bankers’ details will be mentioned in our invoice / proforma invoice. Payment may be made by RTGS | NEFT | IMPS | Cheque | Draft.</p>

        <p><strong>Warranty:</strong> 12 months from the date of installation against any manufacturing defects. The consumables, other accessories, glass parts and other easily damageable items do not carry any warranty. Unauthorized usage and mishandling of the equipment will void the warranty.</p>

        <p><strong>Government Levies:</strong> GST EXTRA @ 18% on all offered products.</p>
      </div>
    </div>

    <button type="submit">Proceed to Quote</button>
  </form>
</div>

<script>
  function goBack(){ if (window.history.length > 1) window.history.back(); }

  function generateQuoteNo() {
    const lastNo = localStorage.getItem('lastQuoteNo') || 'EQ/SQ/25-26/00000';
    const parts = lastNo.split('/');
    const num = parseInt(parts[parts.length - 1], 10) + 1;
    const newNo = `EQ/SQ/25-26/${String(num).padStart(5, '0')}`;
    localStorage.setItem('lastQuoteNo', newNo);
    return newNo;
  }

  function populateHospitalDropdown() {
    const hospitals = JSON.parse(localStorage.getItem('hospitals') || '[]');
    const select = document.getElementById('hospitalSelect');
    hospitals.forEach((hosp, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = `${hosp.clientCode} - ${hosp.clientName}`;
      select.appendChild(opt);
    });
  }

  function fillHospitalDetails() {
    const hospitals = JSON.parse(localStorage.getItem('hospitals') || '[]');
    const idx = document.getElementById('hospitalSelect').value;
    if (idx === '') return;
    const hosp = hospitals[idx];
    if (!hosp) return;

    document.getElementById('hospitalName').value = hosp.clientName || '';
    document.getElementById('hospitalAddress').value = hosp.address || '';
    document.getElementById('contactPhone').value = hosp.mobile || '';
    document.getElementById('contactEmail').value = hosp.email || '';
  }

  function populateInstrumentDropdown() {
    const instruments = JSON.parse(localStorage.getItem('instruments') || '[]');
    const select = document.getElementById('instrumentSelect');
    instruments.forEach((inst, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      const name = inst.instrumentName || inst.description || '';
      opt.textContent = name; // e.g. "pfm Rotary 3006 EM (Fully-Electronic Microtome)"
      select.appendChild(opt);
    });
  }

  function setupInstrumentPreview() {
    const select = document.getElementById('instrumentSelect');
    const preview = document.getElementById('instrumentPreview');
    const details = document.getElementById('instrumentDetails');

    select.addEventListener('change', function () {
      const idx = this.value;
      const instruments = JSON.parse(localStorage.getItem('instruments') || '[]');
      const inst = instruments[idx];

      if (!inst) {
        preview.style.display = 'none';
        details.textContent = '';
        return;
      }

    const descLines = (inst.longDescription || inst.description || '')
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);
    
    const overview = descLines[0] || '';
    const extras = descLines.slice(1).join(' ');
    
    // show description only, not the title again
    const fullText = [overview, extras].filter(Boolean).join(' ');
    preview.style.display = 'block';
    details.textContent = fullText;

  document.getElementById('hospitalSelect').addEventListener('change', fillHospitalDetails);

  document.getElementById('quoteSetupForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const instrumentSelectEl = document.getElementById('instrumentSelect');
    const selectedInstrumentIndex = instrumentSelectEl.value;
    const instruments = JSON.parse(localStorage.getItem('instruments') || '[]');
    const inst = instruments[selectedInstrumentIndex] || null;

    const termsBlock = document.getElementById('termsTextBlock');
    const headerData = {
      quoteNo: document.getElementById('quoteNo').value || '',
      quoteDate: document.getElementById('quoteDate').value || '',
      yourReference: document.getElementById('yourReference').value || '',
      refDate: document.getElementById('refDate').value || '',
      hospitalName: document.getElementById('hospitalName').value || '',
      hospitalAddress: document.getElementById('hospitalAddress').value || '',
      kindAttn: document.getElementById('kindAttn').value || '',
      contactPerson: document.getElementById('contactPerson').value || '',
      contactPhone: document.getElementById('contactPhone').value || '',
      contactEmail: document.getElementById('contactEmail').value || '',
      officePhone: document.getElementById('officePhone').value || '',
      salesNote: document.getElementById('salesNote').value || '',
      termsHtml: termsBlock.innerHTML,
      selectedInstrumentIndex,
      instrumentCode: inst ? (inst.instrumentCode || inst.catalog || '') : ''
    };

    // initialize quoteLines for quotes.html (one main instrument line)
    headerData.quoteLines = [{
      lineType: 'instrument',
      instrumentIndex: selectedInstrumentIndex !== '' ? Number(selectedInstrumentIndex) : null,
      quantity: 1,
      configItems: [],
      additionalItems: []
    }];

    localStorage.setItem('quoteHeader', JSON.stringify(headerData));
    window.location.href = 'quotes.html';
  });

  document.getElementById('quoteNo').value = generateQuoteNo();
  const todayISO = new Date().toISOString().slice(0,10);
  document.getElementById('quoteDate').value = todayISO;
  document.getElementById('refDate').value = todayISO;

  populateHospitalDropdown();
  populateInstrumentDropdown();
  setupInstrumentPreview();
</script>

</body>
</html>
