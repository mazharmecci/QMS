<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Quotes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
body {
  font-family: 'Aptos Display', system-ui, 'Inter', sans-serif;
  background: linear-gradient(135deg, #f0f4f8, #e8eef5);
  margin: 0;
  color: #1a1a1a;
}

/* HEADER */
header {
  background: linear-gradient(135deg, #6ea8fe, #0d6efd);
  color: #fff;
  padding: 0.75rem 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.header-inner {
  max-width: 1320px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  gap: 12px;
}
.back-btn {
  border: none;
  background: rgba(255,255,255,0.25);
  color: #fff;
  padding: 0.45rem 0.9rem;
  border-radius: 999px;
  cursor: pointer;
  backdrop-filter: blur(6px);
  transition: background 0.2s ease;
}
.back-btn:hover { background: rgba(255,255,255,0.4); }
.header-title {
  flex: 1;
  text-align: center;
  font-weight: 600;
  font-size: 1.5rem;
}

/* MAIN FRAME */
.container {
  max-width: 1320px;
  margin: 2rem auto;
  padding: 2rem 2.5rem;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
}

/* QUOTE HEADER */
.quote-header {
  margin-bottom: 1.5rem;
  border: 1px solid rgba(200,200,200,0.4);
  border-radius: 12px;
  background: rgba(255,255,255,0.85);
  padding: 2rem 2.25rem;
  position: relative;
  backdrop-filter: blur(8px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
.quote-header-body { display: flex; gap: 1.5rem; }

/* COMPANY + SALES BOXES */
.company-box, .sales-box {
  background: rgba(240,243,248,0.8);
  border-radius: 8px;
  padding: 0.5rem 1rem;
  display: flex;
  align-items: center;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}
.company-box p { margin: 0; font-size: 10px; color: #333; }
.sales-title { margin-left: auto; font-weight: 700; font-size: 18px; color: #0d6efd; }

/* ATTENTION BOX */
.attn-box {
  background: rgba(173,216,230,0.7);
  padding: 0.75rem 1rem;
  border-radius: 10px;
  font-weight: 700;
  color: #0f172a;
  font-size: 12px;
  backdrop-filter: blur(6px);
}

/* META GRID */
.quote-meta-grid {
  margin-top: 0.75rem;
  background: rgba(255,255,255,0.9);
  border-radius: 8px;
  padding: 0.75rem 1rem;
  display: grid;
  grid-template-columns: minmax(0, auto) minmax(0, 2fr)
                        minmax(0, auto) minmax(0, 1.5fr);
  column-gap: 0.75rem;
  row-gap: 0.5rem;
  box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
}
.quote-meta-grid .label { font-size: 10px; font-weight: 500; color: #555; }
.quote-meta-grid .value { font-size: 13px; font-weight: 600; color: #111; }

/* TABLE */
table.quote-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1rem;
  background: rgba(255,255,255,0.95);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
table.quote-table th {
  background: linear-gradient(135deg, #e9f2ff, #d7e9ff);
  color: #0b1727;
  font-size: 12px;
  text-transform: capitalize;
}
table.quote-table td {
  font-size: 13px;
  border-bottom: 1px solid #eee;
}

/* BUTTONS */
/* BUTTONS with glow effect */
.btn-finalize {
  background: linear-gradient(135deg, #6ea8fe, #0d6efd);
  color: #fff;
  padding: 0.7rem 1.8rem;
  font-size: 0.95rem;
  font-weight: 700;
  border: none;
  border-radius: 999px;
  cursor: pointer;
  box-shadow: 0 4px 14px rgba(0,0,0,0.15);
  transition: all 0.25s ease;
}
.btn-finalize:hover {
  background: linear-gradient(135deg, #82b4ff, #2a7bff);
  transform: translateY(-2px);
  box-shadow: 0 0 12px rgba(13,110,253,0.6), 0 6px 18px rgba(0,0,0,0.2);
}
.btn-finalize:active {
  transform: translateY(0);
  box-shadow: 0 0 8px rgba(13,110,253,0.4);
}

/* Secondary quote buttons */
.btn-quote {
  background: linear-gradient(135deg, #f0f7ff, #d7e9ff);
  border: 1px solid #7fb6ff;
  color: #0b1727;
  font-weight: 600;
  border-radius: 999px;
  padding: 0.55rem 1.2rem;
  box-shadow: 0 3px 8px rgba(15,23,42,0.1);
  transition: all 0.25s ease;
}
.btn-quote:hover {
  background: linear-gradient(135deg, #ffffff, #e3f2ff);
  transform: translateY(-2px);
  box-shadow: 0 0 10px rgba(127,182,255,0.6), 0 5px 14px rgba(15,23,42,0.15);
}
.btn-quote:active {
  transform: translateY(0);
  box-shadow: 0 0 6px rgba(127,182,255,0.4);
}

/* Glow effect for interactive cards/panels */
.quote-header,
.quote-meta-grid,
.company-box,
.sales-box {
  transition: box-shadow 0.3s ease, transform 0.3s ease;
}
.quote-header:hover,
.quote-meta-grid:hover,
.company-box:hover,
.sales-box:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 12px rgba(173,216,230,0.4), 0 6px 16px rgba(0,0,0,0.08);
}   

/* PRINT-FRIENDLY OVERRIDES */
@media print {
  body {
    margin: 0;
    background: #ffffff !important;
    -webkit-print-color-adjust: exact;
    color-adjust: exact;
  }
  header { display: none !important; }
  .container {
    margin: 0;
    padding: 0;
    box-shadow: none;
    border-radius: 0;
    max-width: 100%;
  }
  .quote-header,
  .quote-meta-grid,
  table.quote-table {
    background: #fff !important;
    box-shadow: none !important;
    border: 1px solid #ccc;
  }
  .btn-finalize,
  .btn-quote,
  .no-print { display: none !important; }
}


  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <button type="button" class="back-btn" id="backBtn">← Back</button>
    <div class="header-title">ISTOS Medical Private Limited</div>
  </div>
</header>

<!-- ========= Instruments modals ========= -->
<div id="instrumentModalOverlay" class="overlay" style="display:none;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Instruments for this Quote</h3>
      <button type="button" class="overlay-close" id="closeInstrumentModalBtn">✕</button>
    </div>
    <div style="margin-bottom:0.75rem; display:flex; justify-content:space-between; align-items:center;">
      <div style="font-size:12px; color:#64748b;">Manage all instruments included in this quotation.</div>
      <button type="button" class="btn-quote" id="openInstrumentPickerBtn">+ Add Instrument</button>
    </div>
    <div class="overlay-body">
      <table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead>
          <tr style="background:#e5f0ff;">
            <th>Item#</th><th>Cat / Material No.</th><th>Description</th>
            <th>Qty</th><th>Unit Price (INR)</th><th>Total Price (INR)</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="instrumentModalList"></tbody>
      </table>
    </div>
    <div style="margin-top:0.75rem; text-align:right;">
      <button type="button" class="btn-quote btn-quote-secondary" id="closeInstrumentModalFooterBtn">Close</button>
    </div>
  </div>
</div>

<!-- Instrument picker -->
<div id="instrumentPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Instrument from Master</h3>
      <button type="button" class="overlay-close" id="closeInstrumentPickerBtn">✕</button>
    </div>
    <div id="instrumentPickerList" class="overlay-body"></div>
  </div>
</div>

<!-- Shared item modal -->
<div id="itemModalOverlay">
  <div id="itemModal">
    <div class="item-modal-header">
      <div>
        <h3 id="itemModalTitle" class="item-modal-title">Additional Items for this Instrument</h3>
        <span id="itemModalTag" class="item-modal-tag">Additional</span>
      </div>
      <button type="button" id="closeItemModalBtn" class="item-modal-close">×</button>
    </div>

    <form id="itemModalForm">
      <input type="hidden" id="itemModalType" value="config" />
      <input type="hidden" id="itemLineIndex" value="" />

      <div class="item-modal-grid">
        <div class="item-modal-field">
          <label for="itemCodeInput">Item code</label>
          <input id="itemCodeInput" type="text" placeholder="Auto if left blank" />
        </div>

        <div class="item-modal-field" id="itemQtyGroup">
          <label for="itemQty">Quantity</label>
          <input id="itemQty" type="text" placeholder="1 or Included" />
        </div>

        <div class="item-modal-field" id="itemPriceGroup">
          <label for="itemPrice">Unit price (INR)</label>
          <input id="itemPrice" type="text" placeholder="0.00" />
        </div>

        <div class="item-modal-field item-modal-details">
          <label for="itemDetails">Details</label>
          <textarea id="itemDetails" rows="4" placeholder="First line: main item name
Next lines: brief description"></textarea>
        </div>
      </div>

      <div class="item-modal-footer">
        <div id="itemModalHint" style="font-size:11px;color:#64748b;">
          No items yet for this instrument.
        </div>
        <div class="item-modal-actions">
          <button type="button" id="cancelItemModalBtn" class="btn-item-secondary">Cancel</button>
          <button type="submit" class="btn-item-primary">Save item</button>
        </div>
      </div>
    </form>

    <div id="itemModalList" class="item-modal-list"></div>
  </div>
</div>

<!-- Config/Additional pickers -->
<div id="configPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Configuration Item</h3>
      <button type="button" class="overlay-close" id="closeConfigPickerBtn">✕</button>
    </div>
    <div id="configPickerList" class="overlay-body">
      <div style="font-size:12px; color:#64748b;">Configuration item master is not implemented yet.</div>
    </div>
  </div>
</div>

<div id="additionalPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Additional Item</h3>
      <button type="button" class="overlay-close" id="closeAdditionalPickerBtn">✕</button>
    </div>
    <div id="additionalPickerList" class="overlay-body">
      <div style="font-size:12px; color:#64748b;">Additional item master is not implemented yet.</div>
    </div>
  </div>
</div>

<!-- Main container -->
<div class="container">
  <table class="print-frame">
    <thead class="print-header">
      <tr>
        <td>
          <div class="quote-header">
            <div class="quote-header-body">
              <!-- Left side: company + hospital -->
              <div class="quote-left">
                <div class="company-box">
                  <p>
                    <strong>ISTOS Medical Pvt Ltd.</strong>
                    BSTN Heights, 2nd Cr J.C Indl Area, Bikasipura Main Road,
                    Yelachenahalli, Bangalore-560062
                  </p>
                </div>

                <div class="hospital-box">
                  <p>
                    <strong>To:</strong><br>
                    <span id="toHospitalNameLine"></span><br>
                    <span id="toHospitalAddressLine1"></span><br>
                    <span id="toHospitalAddressLine2"></span>
                  </p>
                </div>

                <div class="attn-box">
                  <span><strong>Kind Attn:</strong></span>
                  <span id="toAttn"></span>
                </div>
              </div>

              <!-- Right side: logo + meta -->
              <div class="quote-right">
                <div class="quote-logo-wrap">
                  <img src="../images/istos-logo.jpg" alt="ISTOS Medical Logo">
                </div>

                <div class="sales-box">
                  <div class="sales-title">SALES QUOTATION</div>
                </div>

                <div class="quote-meta-grid">
                  <div class="label">Quote No.</div>
                  <div class="value" id="metaQuoteNo"></div>

                  <div class="label right">Quotation Date</div>
                  <div class="value value-small right" id="metaQuoteDate"></div>

                  <div class="label">Your Reference</div>
                  <div class="value value-small" id="metaYourRef"></div>

                  <div class="label right">Ref Date</div>
                  <div class="value value-small right" id="metaRefDate"></div>

                  <div class="label">Your Contact Person</div>
                  <div class="value value-small" id="metaContactPerson"></div>

                  <div class="label right">Handphone</div>
                  <div class="value value-small right" id="metaPhone"></div>

                  <div class="label">Email</div>
                  <div class="value value-small" id="metaEmail"></div>

                  <div class="label right">Office</div>
                  <div class="value value-small right" id="metaOffice"></div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </thead>

    <tbody class="print-body">
      <tr>
        <td>
          <!-- Sales note (free text) -->
          <div id="salesNoteBlock"></div>

          <!-- Quote builder controls (edit-only) -->
          <div id="quoteBuilder" class="no-print">
            <h3>Quote Builder</h3>
            <div class="quote-actions">
              <button type="button" class="btn-quote" id="openInstrumentModalBtn">
                Manage Instruments
              </button>
            </div>
          </div>

          <!-- Line items + summary -->
          <table id="quoteSummaryTable" class="quote-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Cat / Material No.<br>Description</th>
                <th>Quantity</th>
                <th>Unit Price (INR)</th>
                <th>Total Price (INR)</th>
              </tr>
            </thead>
            <tbody id="quoteBuilderBody"></tbody>
            <tbody id="quoteSummaryBody"></tbody>
          </table>

          <!-- Terms & Conditions -->
          <div id="termsBlock">
            <h2>Terms and Conditions of Sale</h2>
            <div id="termsTextBlock" contenteditable="true"></div>
          </div>
        </td>
      </tr>
    </tbody>

    <tfoot class="print-footer">
      <tr>
        <td>
          <div class="footer">
            ISTOS Medical Private Limited<br>
            # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area,
            Bikasipura Main Road, Yelachenahalli,<br>
            BANGALORE, Karnataka, INDIA 560 062<br>
            P: +91 80 2686 0607 | F: +91 80 2686 0668 |
            E: talktous@istos.in | www.istosmedical.com<br>
            CIN: U74999KA2016PTC096385 &nbsp; GST: 29AAECI2502G1ZV
          </div>
        </td>
      </tr>
    </tfoot>
  </table>

<!-- Finalize actions (edit-only) -->
<div class="no-print" style="margin-top:1.5rem; text-align:right;">
  <button type="button" class="btn-finalize" id="finalizeQuoteBtn">
    ✅ Finalize &amp; Save to History
  </button>
</div>

<script type="module">
  import {
    moneyINR,
    parseDetailsText,
    formatInstrumentCell,
    formatItemCell
  } from "../js/quoteUtils.js";

  import {
    getQuoteHeaderRaw,
    saveQuoteHeader,
    getInstrumentsMaster,
    getQuoteContext,
    validateHeader,
    finalizeQuote,
    buildQuoteObject
  } from "../js/quoteService.js";

  import {
    populateHeader,
    renderQuoteBuilder,
    openInstrumentModal,
    closeInstrumentModal,
    openInstrumentPicker,
    closeInstrumentPicker,
    addInstrumentToQuote,
    openConfigModal,
    openAdditionalModal,
    openItemModal,
    closeItemModal,
    renderItemModalList,
    editItemFromModal,
    removeItemFromModal,
    saveItemFromModal,
    addMasterItemToLine
  } from "../js/quoteUI.js";

  import { db, doc, getDoc } from "../js/firebase.js";

  let currentQuoteDocId = null;

  function goBack() {
    if (window.history.length > 1) {
      window.history.back();
    } else {
      window.location.href = "https://qms.istosmedical.com/index.html";
    }
  }

  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

   function hydrateLocalFromFirestoreDoc(docData, docId = null) {
    if (!docData || typeof docData !== "object") return;
    if (docId) currentQuoteDocId = docId;
  
    const hosp = docData.hospital || {};
  
    const header = {
      quoteNo: docData.quoteNo || "",
      quoteDate: toDateInputValue(docData.quoteDate),
      hospitalName: hosp.name || "",
      hospitalAddress: hosp.address || "",
      contactPerson: hosp.contactPerson || "",
      contactEmail: hosp.email || "",
      contactPhone: hosp.phone || "",
      officePhone: hosp.officePhone || "",
      yourReference: docData.yourReference || "",
      refDate: toDateInputValue(docData.refDate),
      kindAttn: hosp.kindAttn || "",
      salesNote: docData.salesNote || "",
      termsHtml: docData.termsHtml || "",
      termsText: docData.termsText || "",
      discount: Number(docData.discount || 0),
      status: docData.status || "Submitted",
      quoteLines: []
    };
  
    const instruments = getInstrumentsMaster();
    const items = Array.isArray(docData.items) ? docData.items : [];
  
    console.log("[hydrateLocalFromFirestoreDoc] items length:", items.length);
  
    const quoteLines = items.map(item => {
      const code = item.instrumentCode || item.code || "";
      const name = item.instrumentName || item.name || "";
  
      let idx = instruments.findIndex(inst =>
        inst.instrumentCode === code ||
        inst.catalog === code ||
        inst.instrumentName === name ||
        inst.name === name
      );
  
      if (idx < 0) {
        console.warn("[hydrateLocalFromFirestoreDoc] Instrument not found in master:", item);
        idx = 0;
      }
  
      return {
        lineType: "instrument",
        instrumentIndex: idx,
        quantity: item.quantity || 1,
        configItems: item.configItems || [],
        additionalItems: item.additionalItems || []
      };
    });
  
    header.quoteLines = quoteLines;
    saveQuoteHeader(header);
  }

  async function loadQuoteFromFirestoreIfNeeded() {
    const quoteId = getQueryParam("id");
    if (quoteId) {
      try {
        console.log("[quotes.html] Loading quote from Firestore for id:", quoteId);
        const ref = doc(db, "quoteHistory", quoteId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          hydrateLocalFromFirestoreDoc(snap.data(), snap.id);
        } else {
          console.warn("No quoteHistory document for id", quoteId);
        }
      } catch (err) {
        console.error("Error loading quote from Firestore:", err);
      }
      return;
    }

    if (currentQuoteDocId) {
      console.log("[quotes.html] Editing Firestore quote:", currentQuoteDocId);
    } else {
      console.log("[quotes.html] Using existing local header (no Firestore id).");
    }
  }

document.addEventListener("DOMContentLoaded", async () => {
  console.log("[quotes.html] DOMContentLoaded");

  await loadQuoteFromFirestoreIfNeeded();
  populateHeader();
  renderQuoteBuilder();

  // ✅ Sync terms block to header
  const termsEl = document.getElementById("termsTextBlock");
  if (termsEl) {
    const syncTermsToHeader = () => {
      const header = getQuoteHeaderRaw();
      header.termsHtml = termsEl.innerHTML;
      header.termsText = termsEl.innerText || "";
      saveQuoteHeader(header);
      console.log("[terms] Synced termsHtml length:", header.termsHtml.length);
    };
    ["input", "blur"].forEach(evt => termsEl.addEventListener(evt, syncTermsToHeader));
  }

  // ✅ Back button
  document.getElementById("backBtn")?.addEventListener("click", goBack);

  // ✅ Modal bindings
  const modalBindings = [
    ["openInstrumentModalBtn", openInstrumentModal],
    ["closeInstrumentModalBtn", closeInstrumentModal],
    ["closeInstrumentModalFooterBtn", closeInstrumentModal],
    ["openInstrumentPickerBtn", openInstrumentPicker],
    ["closeInstrumentPickerBtn", closeInstrumentPicker],
    ["closeItemModalBtn", closeItemModal],
    ["cancelItemModalBtn", closeItemModal]
  ];
  modalBindings.forEach(([id, handler]) => {
    document.getElementById(id)?.addEventListener("click", handler);
  });

  // ✅ Item modal form
  document.getElementById("itemModalForm")?.addEventListener("submit", saveItemFromModal);

  // ✅ Overlay closers
  const overlayClosers = {
    closeConfigPickerBtn: "configPickerOverlay",
    closeAdditionalPickerBtn: "additionalPickerOverlay"
  };
  Object.entries(overlayClosers).forEach(([btnId, overlayId]) => {
    document.getElementById(btnId)?.addEventListener("click", () => {
      const el = document.getElementById(overlayId);
      if (el) el.style.display = "none";
    });
  });

  // ✅ Finalize button → SUBMITTED (debounced)
  const finalizeBtn = document.getElementById("finalizeQuoteBtn");
  if (finalizeBtn) {
    let lastClickTime = 0;
    finalizeBtn.addEventListener("click", async () => {
      const now = Date.now();
      if (now - lastClickTime < 3000) {
        console.warn("[finalizeQuoteBtn] Ignored duplicate click.");
        return;
      }
      lastClickTime = now;

      finalizeBtn.disabled = true;
      console.log("[quotes.html] Finalize button clicked:", currentQuoteDocId);
      try {
        await finalizeQuote(currentQuoteDocId);
      } finally {
        finalizeBtn.disabled = false;
      }
    });
  }

  // ✅ Next buttons → APPROVED + MINOR
  const nextButtons = document.querySelectorAll(".btn-next");
  nextButtons.forEach(btn => {
    btn.addEventListener("click", async () => {
      const docId = btn.getAttribute("data-doc-id");
      if (!docId) {
        console.warn("[Next button] Missing data-doc-id");
        return;
      }
      console.log("[quotes.html] Next button clicked for docId:", docId);
      try {
        await approveQuoteRevision(docId);
      } catch (err) {
        console.error("[quotes.html] Error approving quote:", err);
        alert("Failed to approve quote. Please try again.");
      }
    });
  });
});

  // Expose only if inline HTML still uses onclick
  window.openConfigModal = openConfigModal;
  window.openAdditionalModal = openAdditionalModal;
  window.openItemModal = openItemModal;
  window.editItemFromModal = editItemFromModal;
  window.removeItemFromModal = removeItemFromModal;
  window.addInstrumentToQuote = addInstrumentToQuote;
  window.addMasterItemToLine = addMasterItemToLine;
</script>

</body>
</html>
