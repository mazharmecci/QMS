<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sales Quote | ISTOS Medical</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; font-size: 13px; color: #1f2937; margin:0; padding:0; }
    table { width: 100%; border-collapse: collapse; }
    .print-frame th, .print-frame td { border: 1px solid #d1d5db; padding: 0.4rem; vertical-align: top; }
    .quote-header { display: flex; justify-content: space-between; }
    .quote-left, .quote-right { width: 48%; }
    .quote-table th { background: #f3f4f6; font-weight: 600; text-align: left; }
    .btn-quote { padding: 0.3rem 0.6rem; background: #2563eb; color: #fff; border: none; border-radius: 3px; cursor: pointer; }
    .btn-quote-secondary { background: #94a3b8; }
    .no-print { display: none; }
    .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 9999; }
    .modal-content { background: #fff; padding: 1rem; border-radius: 6px; width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin:0; }
    .close-btn { cursor:pointer; font-weight:bold; }
  </style>
</head>
<body>

<div class="container">
  <table class="print-frame">
    <thead class="print-header">
      <tr>
        <td>
          <div class="quote-header">
            <div class="quote-left">
              <div class="company-box">
                <strong>ISTOS Medical Pvt Ltd.</strong><br>
                #51/5, 2nd Cross, J.C. Ind Area, Bikasipura Main Road, Yelachenahalli, Bangalore - 560062
              </div>
              <div class="hospital-box">
                <strong>To:</strong><br>
                <span id="toHospitalNameLine"></span><br>
                <span id="toHospitalAddressLine1"></span><br>
                <span id="toHospitalAddressLine2"></span>
              </div>
              <div class="attn-box">
                KIND ATTN: <span id="toAttn"></span>
              </div>
            </div>
            <div class="quote-right">
              <div class="quote-logo-wrap">
                <img src="../images/istos-logo.jpg" alt="ISTOS Medical Logo" style="max-width:150px;">
              </div>
              <div class="sales-box"><div class="sales-title">SALES QUOTATION</div></div>
              <div class="quote-meta-grid">
                <div class="label">Quote No.</div><div class="value" id="metaQuoteNo"></div>
                <div class="label right">Quotation Date</div><div class="value value-small right" id="metaQuoteDate"></div>
                <div class="label">Your Reference</div><div class="value value-small" id="metaYourRef"></div>
                <div class="label right">Ref Date</div><div class="value value-small right" id="metaRefDate"></div>
                <div class="label">Your Contact Person</div><div class="value value-small" id="metaContactPerson"></div>
                <div class="label right">Handphone</div><div class="value value-small right" id="metaPhone"></div>
                <div class="label">Email</div><div class="value value-small" id="metaEmail"></div>
                <div class="label right">Office</div><div class="value value-small right" id="metaOffice"></div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </thead>

    <tbody class="print-body">
      <tr>
        <td>
          <div id="salesNoteBlock"></div>

          <div id="quoteBuilder" class="no-print">
            <h3>Quote Builder</h3>
            <div class="quote-actions">
              <button class="btn-quote" onclick="openInstrumentModal()">Manage Instruments</button>
            </div>
          </div>

          <table id="quoteSummaryTable" class="quote-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Cat / Material No.<br>Description</th>
                <th>Quantity</th>
                <th>Unit Price (INR)</th>
                <th>Total Price (INR)</th>
              </tr>
            </thead>
            <tbody id="quoteBuilderBody"></tbody>
            <tbody id="quoteSummaryBody"></tbody>
          </table>

          <table style="width:100%; margin-top:1.5rem; border-collapse:collapse;">
            <tr>
              <td style="font-size:13px; line-height:1.5;">
                We will be happy to furnish any further information or assistance you may need and trust that you call on us to fill your order, which will receive our prompt and careful attention.
                <br><br><br>
                For ISTOS Medical Private Limited
                <br><br><br>
                Naushad
              </td>
            </tr>
          </table>

          <div id="termsBlock">
            <h2>Terms and Conditions of Sale</h2>
            <div id="termsTextBlock"></div>
          </div>
        </td>
      </tr>
    </tbody>

    <tfoot class="print-footer">
      <tr>
        <td>
          <div class="footer">
            ISTOS Medical Private Limited<br>
            # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area, Bikasipura Main Road, Yelachenahalli,<br>
            BANGALORE, Karnataka, INDIA 560 062<br>
            P: +91 80 2686 0607 | F: +91 80 2686 0668 | E: talktous@istos.in | www.istosmedical.com<br>
            CIN: U74999KA2016PTC096385 &nbsp; GST: 29AAECI2502G1ZV
          </div>
        </td>
      </tr>
    </tfoot>
  </table>

  <div style="margin-top:1.5rem; text-align:right;" class="no-print">
    <button class="btn-quote" onclick="finalizeQuote()">✅ Finalize & Save to History</button>
  </div>
</div>

<!-- ========= Modals ========= -->
<div id="instrumentModalOverlay" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Manage Instruments</h3>
      <span class="close-btn" onclick="closeInstrumentModal()">✖</span>
    </div>
    <table id="instrumentModalList" style="width:100%; margin-top:0.5rem;"></table>
    <button class="btn-quote" onclick="openInstrumentPicker()">Add Instrument from Master</button>
  </div>
</div>

<div id="instrumentPickerOverlay" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Instrument Master</h3>
      <span class="close-btn" onclick="closeInstrumentPicker()">✖</span>
    </div>
    <div id="instrumentPickerList"></div>
  </div>
</div>

<div id="itemModalOverlay" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="itemModalTitle">Item Modal</h3>
      <span class="close-btn" onclick="closeItemModal()">✖</span>
    </div>
    <form onsubmit="saveItemFromModal(event)">
      <input type="hidden" id="itemModalType">
      <input type="hidden" id="itemLineIndex">
      <div>
        <label>Code: </label>
        <input type="text" id="itemCodeInput">
      </div>
      <div>
        <label>Qty: </label>
        <input type="text" id="itemQty">
      </div>
      <div id="itemPriceGroup">
        <label>Unit Price: </label>
        <input type="text" id="itemPrice">
      </div>
      <div>
        <label>Description: </label><br>
        <textarea id="itemDetails" rows="4" style="width:100%;"></textarea>
      </div>
      <div style="margin-top:0.5rem;">
        <button type="submit" class="btn-quote">Save Item</button>
      </div>
      <div id="itemModalList" style="margin-top:1rem;"></div>
    </form>
  </div>
</div>

<script>
/* ========= Helpers ========= */
function formatISOToDMY(iso){if(!iso)return'';const [y,m,d]=iso.split('-');return`${d}-${m}-${y}`;}
function moneyINR(value){return(Number(value||0)).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});}
function splitAddress(addr){if(!addr)return['',''];const p=addr.split(',');if(p.length<2)return[addr.trim(),''];const l2=p.slice(-1)[0].trim();return[p.slice(0,-1).join(',').trim(),l2];}
function parseLines(raw){return raw?String(raw).split('\n').map(l=>l.trim()).filter(Boolean):[];}
function parseDetailsText(raw){const lines=String(raw||'').split('\n').map(l=>l.trim()).filter(Boolean);return{name:lines[0]||'',rest:lines.slice(1)};}
function getQuoteHeaderRaw(){return JSON.parse(localStorage.getItem('quoteHeader')||'{}');}
function saveQuoteHeader(header){localStorage.setItem('quoteHeader',JSON.stringify(header));}
function getInstrumentsMaster(){return JSON.parse(localStorage.getItem('instruments')||'[]');}
function validateHeader(header){const e=[];if(!header.quoteNo)e.push('Quote No is missing');if(!header.quoteDate)e.push('Quote Date is missing');if(!header.refDate)e.push('Reference Date is missing');if(!header.hospitalName)e.push('Hospital Name is missing');if(!header.hospitalAddress)e.push('Hospital Address is missing');if(e.length){alert('Validation errors:\\n'+e.join('\\n'));return false;}return true;}
function getQuoteContext(){const h=getQuoteHeaderRaw();const i=getInstrumentsMaster();if(!Array.isArray(h.quoteLines))h.quoteLines=[];return{header:h,instruments:i,lines:h.quoteLines};}

/* ========= Format Cells ========= */
function formatItemCell(item){
  const code=item.code||item.catalog||'';
  const descSource=item.description||item.longDescription||'';
  const lines=parseLines(descSource);
  const title=lines[0]||'';
  const rest=lines.slice(1);
  let suppliedRaw=item.suppliedCompleteWith||item.suppliedWith||item.supplied||rest.join('\n');
  let suppliedLines;
  if(Array.isArray(suppliedRaw)){suppliedLines=suppliedRaw.map(String).filter(Boolean);}else{suppliedLines=parseLines(String(suppliedRaw||''));}
  const origin=item.origin||item.country||item.countryOfOrigin||'';
  const hsn=item.hsn||item.hsnCode||'';
  let html=`<td style="white-space:pre-line; vertical-align:top; line-height:1.35;">`;
  if(code)html+=`<div class="cat-main" style="margin-bottom:2px;">${code}</div>`;
  if(title)html+=`<div style="font-weight:600; margin-bottom:4px;">${title}</div>`;
  if(suppliedLines.length){html+=`<div style="font-weight:600; margin-bottom:2px;">Supplied Complete with:</div>`;suppliedLines.forEach(line=>{html+=`<div style="padding-left:1.25rem;">- ${line}</div>`;});}
  if(origin||hsn)html+=`<div style="height:8px;"></div>`;
  if(origin)html+=`<div>Country of Origin: ${origin}</div>`;
  if(hsn)html+=`<div>HSN Code: ${hsn}</div>`;
  html+=`</td>`;return html;
}

function formatInstrumentCell(inst,lineIdx){
  const code=inst.catalog||inst.instrumentCode||'';
  const name=inst.instrumentName||inst.name||'Unnamed Instrument';
  const desc=inst.description||inst.longDescription||'';
  const lines=parseLines(desc);
  const title=lines[0]||'';
  const rest=lines.slice(1);
  let html=`<td style="white-space:pre-line; vertical-align:top; line-height:1.35;">`;
  if(code)html+=`<div class="cat-main" style="margin-bottom:2px;">${code}</div>`;
  if(title)html+=`<div style="font-weight:600; margin-bottom:4px;">${title}</div>`;
  if(rest.length){html+=`<div style="font-weight:600; margin-bottom:2px;">Description:</div>`;rest.forEach(line=>{html+=`<div style="padding-left:1.25rem;">- ${line}</div>`;});}
  const origin=inst.origin||inst.country||inst.countryOfOrigin||'';const hsn=inst.hsn||inst.hsnCode||'';if(origin||hsn)html+=`<div style="height:8px;"></div>`;if(origin)html+=`<div>Country of Origin: ${origin}</div>`;if(hsn)html+=`<div>HSN Code: ${hsn}</div>`;html+=`</td>`;return html;
}

/* ========= Render Quote Builder ========= */
let discountDraft=null;

function renderQuoteBuilder(){
  const {instruments,lines}=getQuoteContext();
  const body=document.getElementById('quoteBuilderBody');if(!body)return;
  if(!lines.length){body.innerHTML='';const sb=document.getElementById('quoteSummaryBody');if(sb)sb.innerHTML='';return;}
  const rows=[];let runningItemCode=1;let itemsTotal=0;
  lines.forEach((line,lineIdx)=>{
    const inst=instruments[line.instrumentIndex]||null;if(!inst)return;
    const qty=Number(line.quantity||1);
    const codeText=String(runningItemCode).padStart(3,'0');runningItemCode+=1;
    const instUnit=Number(inst.unitPrice||0);
    const instTotal=instUnit*qty;itemsTotal+=instTotal;
    rows.push(`<tr>
      <td>${codeText}</td>
      ${formatInstrumentCell(inst,lineIdx)}
      <td>${qty}</td>
      <td>${moneyINR(instUnit)}</td>
      <td>${moneyINR(instTotal)}</td>
    </tr>`);
    const configItems=line.configItems||[];
    if(configItems.length){rows.push(`<tr style="background:#00B0F0;color:#000;"><td colspan="5" style="font-weight:700;">Configuration Items</td></tr>`);
      configItems.forEach(item=>{
        const itemCode=String(runningItemCode).padStart(3,'0');runningItemCode+=1;
        const q=item.qty!=null?item.qty:'Included';
        const upRaw=item.upInr!=null?item.upInr:'Included';
        const tpRaw=item.tpInr!=null?item.tpInr:'Included';
        const upCell=typeof upRaw==='number'?moneyINR(upRaw):upRaw;
        const tpCell=typeof tpRaw==='number'?moneyINR(tpRaw):tpRaw;
        rows.push(`<tr><td>${itemCode}</td>${formatItemCell(item)}<td>${q}</td><td>${upCell}</td><td>${tpCell}</td></tr>`);
      });
    }
    const additionalItems=line.additionalItems||[];
    if(additionalItems.length){rows.push(`<tr style="background:#00B0F0;color:#000;"><td colspan="5" style="font-weight:700;">Additional Items</td></tr>`);
      additionalItems.forEach(item=>{
        const itemCode=String(runningItemCode).padStart(3,'0');runningItemCode+=1;
        const qtyNum=Number(item.qty||1);
        const unitNum=Number(item.price||item.unitPrice||0);
        const totalNum=unitNum*qtyNum;itemsTotal+=totalNum;
        rows.push(`<tr><td>${itemCode}</td>${formatItemCell(item)}<td>${qtyNum.toString().padStart(2,'0')}</td><td>${moneyINR(unitNum)}</td><td>${moneyINR(totalNum)}</td></tr>`);
      });
    }
  });
  body.innerHTML=rows.join('');
  renderSummaryRows(itemsTotal);
}

function renderSummaryRows(itemsTotal){
  const sb=document.getElementById('quoteSummaryBody');if(!sb)return;
  const header=getQuoteHeaderRaw();
  const gstPercent=18;
  const discount=Number(header.discount||0);
  const afterDisc=itemsTotal-discount;
  const gstAmount=(afterDisc*gstPercent)/100;
  const totalValue=afterDisc+gstAmount;
  const roundedTotal=Math.round(totalValue);
  const roundOff=roundedTotal-totalValue;
  sb.innerHTML=`
    <tr><td colspan="3"></td><td style="text-align:right;font-size:12px;color:#475569;">Items Total</td><td style="text-align:right;font-weight:600;">${moneyINR(itemsTotal)}</td></tr>
    <tr class="discount-row"><td colspan="3"></td><td style="text-align:right;font-size:12px;color:#475569;">Discount</td><td style="text-align:right;"><input style="width:70px;" type="number" value="${discount}" onchange="discountInputChanged(this)" onblur="discountInputCommitted(this)"></td></tr>
    <tr><td colspan="3"></td><td style="text-align:right;font-size:12px;color:#475569;">After Discount</td><td style="text-align:right;">${moneyINR(afterDisc)}</td></tr>
    <tr><td colspan="3"></td><td style="text-align:right;font-size:12px;color:#475569;">GST @${gstPercent}%</td><td style="text-align:right;">${moneyINR(gstAmount)}</td></tr>
    <tr><td colspan="3"></td><td style="text-align:right;font-size:12px;color:#475569;">Total Value</td><td style="text-align:right;font-weight:600;">${moneyINR(totalValue)}</td></tr>
    <tr><td colspan="3"></td><td style="text-align:right;font-size:12px;color:#475569;">Rounded Total</td><td style="text-align:right;font-weight:600;">${moneyINR(roundedTotal)}</td></tr>
  `;
}

function discountInputChanged(el){discountDraft=Number(el.value||0);}
function discountInputCommitted(el){if(discountDraft!=null){const h=getQuoteHeaderRaw();h.discount=discountDraft;saveQuoteHeader(h);discountDraft=null;renderQuoteBuilder();}}

/* ========= Instrument Modal ========= */
function openInstrumentModal(){document.getElementById('instrumentModalOverlay').style.display='flex';renderInstrumentModalList();}
function closeInstrumentModal(){document.getElementById('instrumentModalOverlay').style.display='none';}
function renderInstrumentModalList(){
  const {lines,instruments}=getQuoteContext();
  const table=document.getElementById('instrumentModalList');if(!table)return;
  const rows=[];
  lines.forEach((line,lineIdx)=>{
    const inst=instruments[line.instrumentIndex]||null;if(!inst)return;
    rows.push(`<tr>
      <td>${lineIdx+1}</td>
      ${formatInstrumentCell(inst,lineIdx)}
      <td><button onclick="editInstrumentLine(${lineIdx})" class="btn-quote-secondary">Edit</button></td>
      <td><button onclick="removeInstrumentLine(${lineIdx})" class="btn-quote-secondary">Remove</button></td>
    </tr>`);
  });
  table.innerHTML=rows.join('');
}

function editInstrumentLine(idx){const header=getQuoteHeaderRaw();const line=header.quoteLines[idx];if(!line)return;const qty=prompt('Edit quantity',line.quantity||1);if(qty!=null){line.quantity=Number(qty);header.quoteLines[idx]=line;saveQuoteHeader(header);renderQuoteBuilder();renderInstrumentModalList();}}
function removeInstrumentLine(idx){const header=getQuoteHeaderRaw();header.quoteLines.splice(idx,1);saveQuoteHeader(header);renderQuoteBuilder();renderInstrumentModalList();}
function openInstrumentPicker(){document.getElementById('instrumentPickerOverlay').style.display='flex';const listEl=document.getElementById('instrumentPickerList');const instruments=getInstrumentsMaster();listEl.innerHTML=instruments.map((inst,i)=>`<div><button class="btn-quote" onclick="addInstrumentToQuote(${i})">${inst.instrumentName||inst.name}</button></div>`).join('');}
function closeInstrumentPicker(){document.getElementById('instrumentPickerOverlay').style.display='none';}
function addInstrumentToQuote(instIdx){const {header,instruments}=getQuoteContext();const inst=instruments[instIdx];if(!inst)return;header.quoteLines.push({instrumentIndex:instIdx,quantity:1,configItems:[],additionalItems:[]});saveQuoteHeader(header);renderQuoteBuilder();renderInstrumentModalList();}

/* ========= Item Modal ========= */
let currentEditIndex=null;

function openItemModal(type,lineIndex){document.getElementById('itemModalType').value=type;document.getElementById('itemLineIndex').value=lineIndex;document.getElementById('itemModalOverlay').style.display='flex';renderItemModalList(getQuoteHeaderRaw().quoteLines[lineIndex],type);}
function closeItemModal(){document.getElementById('itemModalOverlay').style.display='none';currentEditIndex=null;}
function renderItemModalList(line,type){const listEl=document.getElementById('itemModalList');if(!listEl||!line)return;const arr=type==='config'?line.configItems:line.additionalItems;listEl.innerHTML=arr.map((item,i)=>`<div>${item.name} <button onclick="editItemFromModal('${type}',${i})">Edit</button> <button onclick="removeItemFromModal('${type}',${i})">Remove</button></div>`).join('');}

function editItemFromModal(type,idx){
  const { header } = getQuoteContext();
  const lineIndex = Number(document.getElementById('itemLineIndex').value || 0);
  const line = header.quoteLines[lineIndex] || { configItems: [], additionalItems: [] };
  const arr = type === 'config' ? (line.configItems || []) : (line.additionalItems || []);
  const item = arr[idx]; if(!item)return; currentEditIndex=idx;
  document.getElementById('itemModalType').value=type;
  const titleEl=document.getElementById('itemModalTitle');titleEl.textContent=type==='config'?'Edit Configuration Item':'Edit Additional Item';
  const codeEl=document.getElementById('itemCodeInput');
  const qtyEl=document.getElementById('itemQty');
  const priceEl=document.getElementById('itemPrice');
  const priceGroup=document.getElementById('itemPriceGroup');
  const detailsEl=document.getElementById('itemDetails');
  codeEl.value=item.code||''; qtyEl.value=item.qty!=null?item.qty:(type==='config'?'Included':'1');
  if(priceGroup)priceGroup.style.display=(type==='config')?'none':'block';
  if(type==='config'){if(priceEl)priceEl.value='';}else{let raw=item.price||item.unitPrice||item.upInr||item.tpInr||'';raw=String(raw).replace(/[^\d.]/g,'');if(priceEl)priceEl.value=raw;}
  detailsEl.value=item.description||'';document.getElementById('itemModalOverlay').style.display='flex';
}

function removeItemFromModal(type,idx){
  const { header } = getQuoteContext();
  const lineIndex = Number(document.getElementById('itemLineIndex').value || 0);
  const line = header.quoteLines[lineIndex] || { configItems: [], additionalItems: [] };
  const arrName=type==='config'?'configItems':'additionalItems';
  const arr=line[arrName]||[];arr.splice(idx,1);line[arrName]=arr;
  header.quoteLines[lineIndex]=line;saveQuoteHeader(header);
  renderQuoteBuilder();renderItemModalList(line,type);
}

function saveItemFromModal(e){
  e.preventDefault();const { header }=getQuoteContext();
  const typeEl=document.getElementById('itemModalType');const lineIndex=Number(document.getElementById('itemLineIndex').value||0);
  const codeEl=document.getElementById('itemCodeInput');const qtyEl=document.getElementById('itemQty');
  const priceEl=document.getElementById('itemPrice');const detailsEl=document.getElementById('itemDetails');
  const type=typeEl.value;const code=(codeEl.value||'').trim();const {name}=parseDetailsText(detailsEl.value);if(!name)return;
  const line=header.quoteLines[lineIndex]||{configItems:[],additionalItems:[]};const arrName=type==='config'?'configItems':'additionalItems';
  if(!Array.isArray(line[arrName]))line[arrName]=[];const isEdit=currentEditIndex!=null;const idx=isEdit?currentEditIndex:line[arrName].length;
  if(type==='config'){
    const existingCode=isEdit&&line.configItems[idx]?.code||null;
    const item={code:code||existingCode||`CFG-${String(line.configItems.length+1).padStart(2,'0')}`,name,description:detailsEl.value,qty:qtyEl.value||'Included',upInr:'Included',tpInr:'Included'};
    line.configItems[idx]=item;
  } else {
    const existingCode=isEdit&&line.additionalItems[idx]?.code||null;
    const rawPrice=priceEl?.value||'0';const cleanedPrice=rawPrice.replace(/[^\d.]/g,'');const priceNum=parseFloat(cleanedPrice)||0;
    const item={code:code||existingCode||`ADD-${String(line.additionalItems.length+1).padStart(2,'0')}`,name,description:detailsEl.value,qty:Number(qtyEl.value||1),price:priceNum};
    line.additionalItems[idx]=item;
  }
  currentEditIndex=null;header.quoteLines[lineIndex]=line;saveQuoteHeader(header);
  renderQuoteBuilder();renderItemModalList(line,type);
}

/* ========= Finalize quote ========= */
function buildLineItemsFromCurrentQuote(){
  const {instruments,lines}=getQuoteContext();const items=[];
  lines.forEach(line=>{
    const inst=instruments[line.instrumentIndex]||null;if(inst){items.push({name:inst.instrumentName||inst.name||'',code:inst.catalog||inst.instrumentCode||'',type:'Instrument',price:Number(inst.unitPrice||0)});}
    (line.configItems||[]).forEach(item=>{const price=item.tpInr!=null?Number(item.tpInr):Number(item.upInr||0);items.push({name:item.name||item.itemName||'',code:item.code||item.catalog||'',type:'Configuration',price});});
    (line.additionalItems||[]).forEach(item=>{const unitNum=Number(item.price||item.unitPrice||item.upInr||item.tpInr||0);items.push({name:item.name||item.itemName||'',code:item.code||item.catalog||'',type:'Additional',price:unitNum});});
  });
  return items;
}

function finalizeQuote(){
  const header=getQuoteHeaderRaw();if(!validateHeader(header))return;
  const {instruments,lines}=getQuoteContext();if(!lines.length){alert('No instruments in this quote. Please add at least one instrument.');return;}
  let itemsTotal=0;lines.forEach(line=>{const inst=instruments[line.instrumentIndex]||null;if(inst){const qty=Number(line.quantity||1);itemsTotal+=(Number(inst.unitPrice||0)*qty);} (line.additionalItems||[]).forEach(item=>{const qtyNum=Number(item.qty||1);const unitNum=Number(item.price||item.unitPrice||0);itemsTotal+=qtyNum*unitNum;});});
  const gstPercent=18;const discount=0;const afterDisc=itemsTotal-discount;const gstAmount=(afterDisc*gstPercent)/100;const totalValue=afterDisc+gstAmount;const roundedTotal=Math.round(totalValue);
  const summary={itemsTotal,discount,afterDiscount:afterDisc,freight:'Included',gstPercent,gstAmount,totalValue,roundOff:roundedTotal-totalValue};
  const lineItems=buildLineItemsFromCurrentQuote();const existing=JSON.parse(localStorage.getItem('quotes')||'[]');
  const sameQuote=existing.filter(q=>q.header&&q.header.quoteNo===header.quoteNo);const lastRev=sameQuote.length?Math.max(...sameQuote.map(q=>Number(q.revision||1))):0;const nextRev=lastRev+1;
  const now=new Date();const quote={header,lineItems,summary,quoteNo:header.quoteNo,revision:nextRev,status:'submitted',history:[{status:'submitted',date:now.toISOString().slice(0,10),time:now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit'})}]};
  existing.push(quote);localStorage.setItem('quotes',JSON.stringify(existing));alert('Quote finalized and saved!');
}

/* ========= Hydrate Quote ========= */
(function hydrateQuoteFromSetup(){
  const raw=localStorage.getItem('quoteHeader');if(!raw){console.warn('No quoteHeader found, redirecting back');window.location.href='forms/quote-setup.html';return;}
  const data=JSON.parse(raw);
  document.getElementById('metaQuoteNo').textContent=data.quoteNo||'';
  document.getElementById('metaQuoteDate').textContent=data.quoteDate||'';
  document.getElementById('metaYourRef').textContent=data.yourReference||'';
  document.getElementById('metaRefDate').textContent=data.refDate||'';
  document.getElementById('metaContactPerson').textContent=data.contactPerson||'';
  document.getElementById('metaPhone').textContent=data.contactPhone||'';
  document.getElementById('metaEmail').textContent=data.contactEmail||'';
  document.getElementById('metaOffice').textContent=data.officePhone||'';
  document.getElementById('toHospitalNameLine').textContent=data.hospitalName||'';
  document.getElementById('toHospitalAddressLine1').textContent=data.hospitalAddress||'';
  document.getElementById('toAttn').textContent=data.kindAttn||'';
  if(data.salesNote)document.getElementById('salesNoteBlock').innerText=data.salesNote;
  if(data.termsHtml)document.getElementById('termsTextBlock').innerHTML=data.termsHtml;
  window.currentQuoteItems=data.quoteLines||[];
  window.currentQuoteTotals={};
})();

document.addEventListener('DOMContentLoaded',function(){renderQuoteBuilder();});
</script>

</body>
</html>
