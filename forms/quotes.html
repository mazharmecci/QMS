<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Quotes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Aptos Display', system-ui, 'Inter', sans-serif;
      background:#f5f7fa;
      margin:0;
    }

    header {
      background:#0d6efd;
      color:#fff;
      padding:0.75rem 1.5rem;
    }
    .header-inner {
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .back-btn {
      border:none;
      background:rgba(255,255,255,0.12);
      color:#fff;
      padding:0.45rem 0.9rem;
      border-radius:999px;
      cursor:pointer;
    }
    .header-title {
      flex:1;
      text-align:center;
      font-weight:600;
      font-size:1.5rem;
    }

    .container {
      max-width:1200px;
      margin:2rem auto;
      padding:2rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }

    /* Quote header (letterhead) */
    .quote-header {
      margin-bottom:1.5rem;
      border:1px solid #ccc;
      border-radius:8px;
      background:#fff;
      padding:2rem;
      position:relative;
    }
    .quote-header-body {
      display:flex;
      gap:1rem;
    }
    .quote-left,
    .quote-right {
      flex:1 1 0;
      min-width:0;
      display:flex;
      flex-direction:column;
    }
    .quote-logo-wrap {
      align-self:flex-end;
      margin-bottom:0.5rem;
    }
    .quote-logo-wrap img {
      max-height:70px;
      width:auto;
      display:block;
    }
    .company-box {
      flex:0 0 auto;
      background:#d0d4d9;
      border-radius:4px;
      padding:0.4rem 1rem;
      display:flex;
      align-items:center;
      margin-top:4.85rem;
    }
    .company-box p {
      margin:0;
      font-size:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sales-box {
      flex:0 0 auto;
      background:#d0d4d9;
      border-radius:4px;
      padding:0.3rem 1rem;
      display:flex;
      align-items:center;
    }
    .sales-title {
      margin-left:auto;
      font-weight:900;
      font-size:18px;
      line-height:1;
      padding-top:0.1rem;
      letter-spacing:0.03em;
    }
    .hospital-box,
    .attn-box {
      margin-top:0.5rem;
    }
    .attn-box {
      background:#add8e6;
      padding:0.75rem 1rem;
      border-radius:8px;
      font-weight:800;
      color:#000;
      font-size:14px;
    }

    .quote-meta-grid {
      margin-top:0.5rem;
      background:#fff;
      border-radius:4px;
      padding:0.5rem 0.75rem;
      display:grid;
      grid-template-columns:auto 1fr auto 1fr;
      column-gap:0.75rem;
      row-gap:0.55rem;
    }
    .quote-meta-grid .label {
      font-size:9px;
      font-weight:500;
      color:#222;
      text-align:left;
    }
    .quote-meta-grid .value {
      font-size:16px;
      font-weight:700;
      color:#000;
      text-align:left;
      white-space:nowrap;
    }
    .quote-meta-grid .value-small {
      font-size:13px;
      font-weight:600;
    }
    .quote-meta-grid .label.right,
    .quote-meta-grid .value.right {
      text-align:right;
    }

    /* Sales note and builder wrapper */
    #salesNoteBlock {
      margin:0 0 1rem 0;
      font-size:13px;
      line-height:1.5;
      white-space:pre-line;
    }
    #quoteBuilder {
      margin-top:1.5rem;
      padding:1.5rem;
      background:#ffffff;
      border:1px solid #ddd;
      border-radius:12px;
    }
    #quoteBuilder h3 {
      margin-top:0;
      margin-bottom:0.75rem;
      color:#0d6efd;
    }

    /* Quote table */
    table.quote-table {
      width:100%;
      border-collapse:collapse;
      margin-bottom:1rem;
    }
    table.quote-table th,
    table.quote-table td {
      padding:0.25rem 0.6rem;
      border-bottom:1px solid #ddd;
      text-align:left;
      vertical-align:top;
      font-size:13px;
    }
    table.quote-table th {
      background:#e0e0e0;
      color:#000;
      font-size:12px;
      text-transform:capitalize;
      letter-spacing:0.03em;
    }
    table.quote-table th:nth-child(4),
    table.quote-table th:nth-child(5),
    table.quote-table td:nth-child(4),
    table.quote-table td:nth-child(5) {
      text-align:right;
      white-space:nowrap;
    }
    table.quote-table td:nth-child(3),
    table.quote-table th:nth-child(3) {
      text-align:center;
      white-space:nowrap;
    }
    table.quote-table td:nth-child(1),
    table.quote-table td:nth-child(2) {
      vertical-align:top;
    }
    table.quote-table .cat-sub b,
    table.quote-table .cat-sub strong {
      font-weight:500;
    }

    /* Buttons (finalize, config/additional) */
    .btn-finalize {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.3rem;
      background:linear-gradient(135deg, #0b3b91, #0d6efd);
      color:#ffffff;
      padding:0.7rem 1.8rem;
      font-size:0.95rem;
      font-weight:700;
      border:none;
      border-radius:999px;
      cursor:pointer;
      letter-spacing:0.04em;
      text-transform:uppercase;
      box-shadow:0 4px 14px rgba(0, 0, 0, 0.25);
      transition:background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease, filter 0.15s ease;
    }
    .btn-finalize:hover {
      background:linear-gradient(135deg, #0c46a8, #2a7bff);
      box-shadow:0 6px 18px rgba(0, 0, 0, 0.3);
      transform:translateY(-1px);
      filter:brightness(1.03);
    }
    .btn-finalize:active {
      transform:translateY(0);
      box-shadow:0 3px 10px rgba(0, 0, 0, 0.28);
      filter:brightness(0.98);
    }

    .quote-actions {
      margin-bottom:0.75rem;
    }
    .btn-quote {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.3rem;
      padding:0.55rem 1.2rem;
      border-radius:999px;
      border:1px solid #7fb6ff;
      background:linear-gradient(135deg, #e3f2ff, #cde5ff);
      color:#0b1727;
      font-size:0.85rem;
      font-weight:600;
      letter-spacing:0.02em;
      cursor:pointer;
      box-shadow:0 3px 8px rgba(15, 23, 42, 0.15);
      transition:background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
    }
    .btn-quote:hover {
      background:linear-gradient(135deg, #f0f7ff, #d7e9ff);
      border-color:#5b9bff;
      box-shadow:0 5px 14px rgba(15, 23, 42, 0.2);
      transform:translateY(-1px);
    }
    .btn-quote:active {
      transform:translateY(0);
      box-shadow:0 2px 6px rgba(15, 23, 42, 0.18);
    }
    .btn-quote-secondary {
      background:linear-gradient(135deg, #eef4ff, #dde7ff);
    }

    /* Terms block */
    #termsBlock {
      margin-top:1.5rem;
      background:#fff;
      border:1px solid #ccc;
      border-radius:8px;
      padding:1rem 1.25rem;
      font-size:12px;
      line-height:1.4;
    }
    #termsBlock h2 {
      margin-top:0;
      color:#0d6efd;
      font-size:13px;
    }
    #termsTextBlock {
      margin-top:0.25rem;
    }
    #termsTextBlock p {
      margin:0.35rem 0;
    }

    .section-header-label {
      font-weight:700;
    }

  /* Print helpers */
  .print-footer tr,
  .print-footer td {
    border-top: none !important;
  }
  .print-frame {
    width: 100%;
    border-collapse: collapse;
    border: none;
  }
  .print-header td,
  .print-body td,
  .print-footer td {
    padding: 0;
    border: none;
  }
  .footer {
    font-size: 10px;
    text-align: right;
    border-top: 1px solid #ccc;
    padding-top: 4px;
    margin-top: 4px;
  }
  
  /* visible on screen by default */
  .no-print { display: block; }
  
  @page {
    size: A4;
    margin: 15mm 15mm 20mm 15mm;
  }
  
  @media print {
    body {
      margin: 0;
      background: #ffffff;
      -webkit-print-color-adjust: exact;
      color-adjust: exact;
    }
  
    header { display: none !important; }
  
    .container {
      margin: 0;
      padding: 0;
      box-shadow: none;
      border-radius: 0;
    }
  
    thead.print-header { display: table-header-group; }
    tfoot.print-footer { display: table-footer-group; }
  
    /* Hide any screen‑only elements */
    .no-print { display: none !important; }
  
    /* Hide all buttons in print (toolbar + per-row buttons) */
    button,
    .btn-quote,
    .btn-finalize { display: none !important; }
  
    /* Hide overlays in print */
    .overlay { display: none !important; }

        /* Chrome, Safari, Edge, Opera */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Firefox */
    input[type="number"] {
      -moz-appearance: textfield;
    }
      
    /* Always visible on screen */
    .discount-row,
    .after-discount-row {
      display: table-row;
    }
    
    @media print {
      /* Hide only during print when discount is zero */
      .discount-zero .discount-row,
      .discount-zero .after-discount-row {
        display: none !important;
      }
    }
  
  /* Overlay (screen only) */
  .overlay {
    display: flex; /* ✅ changed from none so it shows on screen */
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.55);
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .overlay-panel {
    background: #fff;
    border-radius: 10px;
    padding: 1rem 1.25rem;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(15,23,42,0.35);
  }
  .overlay-body {
    flex: 1;
    overflow-y: auto;
    margin-top: 0.25rem;
  }
</style>
</head>

<body>
<header>
  <div class="header-inner">
    <button type="button" class="back-btn" id="backBtn">← Back</button>
    <div class="header-title">ISTOS Medical Private Limited</div>
  </div>
</header>

<!-- ========= Instruments modals ========= -->
<div id="instrumentModalOverlay" class="overlay" style="display:none;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Instruments for this Quote</h3>
      <button type="button" class="overlay-close" id="closeInstrumentModalBtn">✕</button>
    </div>
    <div style="margin-bottom:0.75rem; display:flex; justify-content:space-between; align-items:center;">
      <div style="font-size:12px; color:#64748b;">Manage all instruments included in this quotation.</div>
      <button type="button" class="btn-quote" id="openInstrumentPickerBtn">+ Add Instrument</button>
    </div>
    <div class="overlay-body">
      <table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead>
          <tr style="background:#e5f0ff;">
            <th>Item#</th><th>Cat / Material No.</th><th>Description</th>
            <th>Qty</th><th>Unit Price (INR)</th><th>Total Price (INR)</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="instrumentModalList"></tbody>
      </table>
    </div>
    <div style="margin-top:0.75rem; text-align:right;">
      <button type="button" class="btn-quote btn-quote-secondary" id="closeInstrumentModalFooterBtn">Close</button>
    </div>
  </div>
</div>

<!-- Instrument picker -->
<div id="instrumentPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Instrument from Master</h3>
      <button type="button" class="overlay-close" id="closeInstrumentPickerBtn">✕</button>
    </div>
    <div id="instrumentPickerList" class="overlay-body"></div>
  </div>
</div>

<!-- Shared item modal -->
<div id="itemModalOverlay" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.45); z-index:2000; align-items:center; justify-content:center;">
  <div id="itemModal" style="width:520px; max-width:95%; background:#fff; border-radius:10px; box-shadow:0 18px 45px rgba(15,23,42,0.35); padding:1.25rem 1.5rem;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
      <h3 id="itemModalTitle" style="margin:0; font-size:15px; color:#0d6efd;"></h3>
      <button type="button" id="closeItemModalBtn" style="border:none; background:transparent; font-size:18px; cursor:pointer;">×</button>
    </div>
    <form id="itemModalForm">
      <input type="hidden" id="itemModalType" value="config">
      <input type="hidden" id="itemLineIndex" value="">
      <input id="itemCodeInput" type="text" placeholder="Item code" />
      <input id="itemQty" type="text" placeholder="Qty (or Included)" />
      <div id="itemPriceGroup"><input id="itemPrice" type="text" placeholder="Unit price (INR)" /></div>
      <textarea id="itemDetails" rows="5" placeholder="First line: main item name"></textarea>
      <div style="text-align:right;">
        <button type="button" id="cancelItemModalBtn">Cancel</button>
        <button type="submit">Save item</button>
      </div>
    </form>
    <div id="itemModalList"></div>
  </div>
</div>

<!-- Config/Additional pickers -->
<div id="configPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Configuration Item</h3>
      <button type="button" class="overlay-close" id="closeConfigPickerBtn">✕</button>
    </div>
    <div id="configPickerList" class="overlay-body">
      <div style="font-size:12px; color:#64748b;">Configuration item master is not implemented yet.</div>
    </div>
  </div>
</div>

<div id="additionalPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Additional Item</h3>
      <button type="button" class="overlay-close" id="closeAdditionalPickerBtn">✕</button>
    </div>
    <div id="additionalPickerList" class="overlay-body">
      <div style="font-size:12px; color:#64748b;">Additional item master is not implemented yet.</div>
    </div>
  </div>
</div>

<!-- Main container -->
<div class="container">
  <table class="print-frame">
    <thead class="print-header">
      <tr><td>
        <div class="quote-header">
          <!-- Letterhead populated by populateHeader() -->
          <div class="quote-header-body">
            <div class="quote-left">
              <div class="company-box"><p><strong>ISTOS Medical Pvt Ltd.</strong> BSTN Heights, 2nd Cr J.C Industrial Area Bakasipura Mn Rd, Yelachenhalli Bangalore - 560062</p></div>
              <div class="hospital-box"><p><strong>To:</strong><br><span id="toHospitalNameLine"></span><br><span id="toHospitalAddressLine1"></span><br><span id="toHospitalAddressLine2"></span></p></div>
              <div class="attn-box">KIND ATTN: <span id="toAttn"></span></div>
            </div>
            <div class="quote-right">
              <div class="quote-logo-wrap"><img src="../images/istos-logo.jpg" alt="ISTOS Medical Logo"></div>
              <div class="sales-box"><div class="sales-title">SALES QUOTATION</div></div>
              <div class="quote-meta-grid">
                <div class="label">Quote No.</div><div class="value" id="metaQuoteNo"></div>
                <div class="label right">Quotation Date</div><div class="value value-small right" id="metaQuoteDate"></div>
                <div class="label">Your Reference</div><div class="value value-small" id="metaYourRef"></div>
                <div class="label right">Ref Date</div><div class="value value-small right" id="metaRefDate"></div>
                <div class="label">Your Contact Person</div>
<div class="value value-small" id="metaContactPerson"></div>

<div class="label right">Handphone</div>
<div class="value value-small right" id="metaPhone"></div>

<div class="label">Email</div>
<div class="value value-small" id="metaEmail"></div>

<div class="label right">Office</div>
<div class="value value-small right" id="metaOffice"></div>
</div> <!-- end quote-meta-grid -->
</div> <!-- end quote-right -->
</div> <!-- end quote-header-body -->
</div> <!-- end quote-header -->
</td>
</tr>
</thead>

<tbody class="print-body">
<tr>
  <td>
    <div id="salesNoteBlock"></div>

    <!-- Builder wrapper -->
    <div id="quoteBuilder" class="no-print">
      <h3 class="no-print">Quote Builder</h3>
      <div class="quote-actions no-print">
        <button type="button" class="btn-quote" id="openInstrumentModalBtn">
          Manage Instruments
        </button>
      </div>
    </div>

    <table id="quoteSummaryTable" class="quote-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Cat / Material No.<br>Description</th>
          <th>Quantity</th>
          <th>Unit Price (INR)</th>
          <th>Total Price (INR)</th>
        </tr>
      </thead>
      <tbody id="quoteBuilderBody"></tbody>
      <tbody id="quoteSummaryBody"></tbody>
    </table>

    <div id="termsBlock">
      <h2>Terms and Conditions of Sale</h2>
      <div id="termsTextBlock"></div>
    </div>
  </td>
</tr>
</tbody>

<tfoot class="print-footer">
<tr>
  <td>
    <div class="footer">
      ISTOS Medical Private Limited<br>
      # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area,
      Bikasipura Main Road, Yelachenahalli,<br>
      BANGALORE, Karnataka, INDIA 560 062<br>
      P: +91 80 2686 0607 | F: +91 80 2686 0668 |
      E: talktous@istos.in | www.istosmedical.com<br>
      CIN: U74999KA2016PTC096385 &nbsp; GST: 29AAECI2502G1ZV
    </div>
  </td>
</tr>
</tfoot>
</table>

<div style="margin-top:1.5rem; text-align:right;" class="no-print">
  <button type="button" class="btn-finalize" id="finalizeQuoteBtn">
    ✅ Finalize &amp; Save to History
  </button>
</div>
</div> <!-- end container -->

<!-- ========= Scripts ========= -->
<script type="module">
  /* ===== Imports ===== */
  import { 
    moneyINR, 
    parseDetailsText, 
    formatInstrumentCell, 
    formatItemCell 
  } from "../js/quoteUtils.js";

  import { 
    getQuoteHeaderRaw, 
    saveQuoteHeader, 
    getInstrumentsMaster, 
    getQuoteContext, 
    validateHeader, 
    finalizeQuote 
  } from "../js/quoteService.js";

  import { 
    populateHeader,
    renderQuoteBuilder,
    openInstrumentModal,
    closeInstrumentModal,
    openInstrumentPicker,
    closeInstrumentPicker,
    addInstrumentToQuote,
    openConfigModal,
    openAdditionalModal,
    openItemModal,
    closeItemModal,
    renderItemModalList,
    editItemFromModal,
    removeItemFromModal,
    saveItemFromModal
  } from "../js/quoteUI.js";

  /* ===== Helpers ===== */
function goBack() {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = "index.html";
  }
}

/* ===== Init & Event Wiring ===== */
document.addEventListener("DOMContentLoaded", () => {
  // Initial render
  populateHeader();
  renderQuoteBuilder();

  // Back button
  document.getElementById("backBtn")?.addEventListener("click", goBack);

  // Instrument modal
  const instrumentModalEvents = [
    ["openInstrumentModalBtn", openInstrumentModal],
    ["closeInstrumentModalBtn", closeInstrumentModal],
    ["closeInstrumentModalFooterBtn", closeInstrumentModal]
  ];
  instrumentModalEvents.forEach(([id, handler]) => {
    document.getElementById(id)?.addEventListener("click", handler);
  });

  // Instrument picker
  document
    .getElementById("openInstrumentPickerBtn")
    ?.addEventListener("click", openInstrumentPicker);
  document
    .getElementById("closeInstrumentPickerBtn")
    ?.addEventListener("click", closeInstrumentPicker);

  // Item modal
  document
    .getElementById("closeItemModalBtn")
    ?.addEventListener("click", closeItemModal);
  document
    .getElementById("cancelItemModalBtn")
    ?.addEventListener("click", closeItemModal);
  document
    .getElementById("itemModalForm")
    ?.addEventListener("submit", saveItemFromModal);

  // Config/Additional pickers
  document
    .getElementById("closeConfigPickerBtn")
    ?.addEventListener("click", () => {
      document.getElementById("configPickerOverlay").style.display = "none";
    });
  document
    .getElementById("closeAdditionalPickerBtn")
    ?.addEventListener("click", () => {
      document.getElementById("additionalPickerOverlay").style.display = "none";
    });

  // Finalize quote
  document
    .getElementById("finalizeQuoteBtn")
    ?.addEventListener("click", finalizeQuote);
});
</script>
</body>
</html>
