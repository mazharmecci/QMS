<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Quotes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Aptos Display', system-ui, 'Inter', sans-serif;
      background:#f5f7fa;
      margin:0;
    }

    header {
      background:#0d6efd;
      color:#fff;
      padding:0.75rem 1.5rem;
    }
    .header-inner {
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .back-btn {
      border:none;
      background:rgba(255,255,255,0.12);
      color:#fff;
      padding:0.45rem 0.9rem;
      border-radius:999px;
      cursor:pointer;
    }
    .header-title {
      flex:1;
      text-align:center;
      font-weight:600;
      font-size:1.5rem;
    }

    .container {
      max-width:1200px;
      margin:2rem auto;
      padding:2rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }

    /* Quote header (letterhead) */
    .quote-header {
      margin-bottom:1.5rem;
      border:1px solid #ccc;
      border-radius:8px;
      background:#fff;
      padding:2rem;
      position:relative;
    }
    .quote-header-body {
      display:flex;
      gap:1rem;
    }
    .quote-left,
    .quote-right {
      flex:1 1 0;
      min-width:0;
      display:flex;
      flex-direction:column;
    }
    .quote-logo-wrap {
      align-self:flex-end;
      margin-bottom:0.5rem;
    }
    .quote-logo-wrap img {
      max-height:70px;
      width:auto;
      display:block;
    }
    .company-box {
      flex:0 0 auto;
      background:#d0d4d9;
      border-radius:4px;
      padding:0.4rem 1rem;
      display:flex;
      align-items:center;
      margin-top:4.85rem;
    }
    .company-box p {
      margin:0;
      font-size:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sales-box {
      flex:0 0 auto;
      background:#d0d4d9;
      border-radius:4px;
      padding:0.3rem 1rem;
      display:flex;
      align-items:center;
    }
    .sales-title {
      margin-left:auto;
      font-weight:900;
      font-size:18px;
      line-height:1;
      padding-top:0.1rem;
      letter-spacing:0.03em;
    }
    .hospital-box,
    .attn-box {
      margin-top:0.5rem;
    }
    .attn-box {
      background:#add8e6;
      padding:0.75rem 1rem;
      border-radius:8px;
      font-weight:800;
      color:#000;
      font-size:14px;
    }

    .quote-meta-grid {
      margin-top:0.5rem;
      background:#fff;
      border-radius:4px;
      padding:0.5rem 0.75rem;
      display:grid;
      grid-template-columns:auto 1fr auto 1fr;
      column-gap:0.75rem;
      row-gap:0.55rem;
    }
    .quote-meta-grid .label {
      font-size:9px;
      font-weight:500;
      color:#222;
      text-align:left;
    }
    .quote-meta-grid .value {
      font-size:16px;
      font-weight:700;
      color:#000;
      text-align:left;
      white-space:nowrap;
    }
    .quote-meta-grid .value-small {
      font-size:13px;
      font-weight:600;
    }
    .quote-meta-grid .label.right,
    .quote-meta-grid .value.right {
      text-align:right;
    }

    /* Sales note and builder wrapper */
    #salesNoteBlock {
      margin:0 0 1rem 0;
      font-size:13px;
      line-height:1.5;
      white-space:pre-line;
    }
    #quoteBuilder {
      margin-top:1.5rem;
      padding:1.5rem;
      background:#ffffff;
      border:1px solid #ddd;
      border-radius:12px;
    }
    #quoteBuilder h3 {
      margin-top:0;
      margin-bottom:0.75rem;
      color:#0d6efd;
    }

    /* Quote table */
    table.quote-table {
      width:100%;
      border-collapse:collapse;
      margin-bottom:1rem;
    }
    table.quote-table th,
    table.quote-table td {
      padding:0.25rem 0.6rem;
      border-bottom:1px solid #ddd;
      text-align:left;
      vertical-align:top;
      font-size:13px;
    }
    table.quote-table th {
      background:#e0e0e0;
      color:#000;
      font-size:12px;
      text-transform:capitalize;
      letter-spacing:0.03em;
    }
    table.quote-table th:nth-child(4),
    table.quote-table th:nth-child(5),
    table.quote-table td:nth-child(4),
    table.quote-table td:nth-child(5) {
      text-align:right;
      white-space:nowrap;
    }
    table.quote-table td:nth-child(3),
    table.quote-table th:nth-child(3) {
      text-align:center;
      white-space:nowrap;
    }
    table.quote-table td:nth-child(1),
    table.quote-table td:nth-child(2) {
      vertical-align:top;
    }
    table.quote-table .cat-sub b,
    table.quote-table .cat-sub strong {
      font-weight:500;
    }

    /* Buttons (finalize, config/additional) */
    .btn-finalize {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.3rem;
      background:linear-gradient(135deg, #0b3b91, #0d6efd);
      color:#ffffff;
      padding:0.7rem 1.8rem;
      font-size:0.95rem;
      font-weight:700;
      border:none;
      border-radius:999px;
      cursor:pointer;
      letter-spacing:0.04em;
      text-transform:uppercase;
      box-shadow:0 4px 14px rgba(0, 0, 0, 0.25);
      transition:background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease, filter 0.15s ease;
    }
    .btn-finalize:hover {
      background:linear-gradient(135deg, #0c46a8, #2a7bff);
      box-shadow:0 6px 18px rgba(0, 0, 0, 0.3);
      transform:translateY(-1px);
      filter:brightness(1.03);
    }
    .btn-finalize:active {
      transform:translateY(0);
      box-shadow:0 3px 10px rgba(0, 0, 0, 0.28);
      filter:brightness(0.98);
    }

    .quote-actions {
      margin-bottom:0.75rem;
    }
    .btn-quote {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.3rem;
      padding:0.55rem 1.2rem;
      border-radius:999px;
      border:1px solid #7fb6ff;
      background:linear-gradient(135deg, #e3f2ff, #cde5ff);
      color:#0b1727;
      font-size:0.85rem;
      font-weight:600;
      letter-spacing:0.02em;
      cursor:pointer;
      box-shadow:0 3px 8px rgba(15, 23, 42, 0.15);
      transition:background 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease, border-color 0.15s ease;
    }
    .btn-quote:hover {
      background:linear-gradient(135deg, #f0f7ff, #d7e9ff);
      border-color:#5b9bff;
      box-shadow:0 5px 14px rgba(15, 23, 42, 0.2);
      transform:translateY(-1px);
    }
    .btn-quote:active {
      transform:translateY(0);
      box-shadow:0 2px 6px rgba(15, 23, 42, 0.18);
    }
    .btn-quote-secondary {
      background:linear-gradient(135deg, #eef4ff, #dde7ff);
    }

    /* Terms block */
    #termsBlock {
      margin-top:1.5rem;
      background:#fff;
      border:1px solid #ccc;
      border-radius:8px;
      padding:1rem 1.25rem;
      font-size:12px;
      line-height:1.4;
    }
    #termsBlock h2 {
      margin-top:0;
      color:#0d6efd;
      font-size:13px;
    }
    #termsTextBlock {
      margin-top:0.25rem;
    }
    #termsTextBlock p {
      margin:0.35rem 0;
    }

    .section-header-label {
      font-weight:700;
    }

  /* Print helpers */
  .print-footer tr,
  .print-footer td {
    border-top: none !important;
  }
  .print-frame {
    width: 100%;
    border-collapse: collapse;
    border: none;
  }
  .print-header td,
  .print-body td,
  .print-footer td {
    padding: 0;
    border: none;
  }
  .footer {
    font-size: 10px;
    text-align: right;
    border-top: 1px solid #ccc;
    padding-top: 4px;
    margin-top: 4px;
  }
  
  /* visible on screen by default */
  .no-print { display: block; }
  
  @page {
    size: A4;
    margin: 15mm 15mm 20mm 15mm;
  }
  
  @media print {
    body {
      margin: 0;
      background: #ffffff;
      -webkit-print-color-adjust: exact;
      color-adjust: exact;
    }
  
    header { display: none !important; }
  
    .container {
      margin: 0;
      padding: 0;
      box-shadow: none;
      border-radius: 0;
    }
  
    thead.print-header { display: table-header-group; }
    tfoot.print-footer { display: table-footer-group; }
  
    /* Hide any screen‑only elements */
    .no-print { display: none !important; }
  
    /* Hide all buttons in print (toolbar + per-row buttons) */
    button,
    .btn-quote,
    .btn-finalize { display: none !important; }
  
    /* Hide overlays in print */
    .overlay { display: none !important; }
  
    /* Screen: rows always visible */
    .discount-row,
    .after-discount-row {
      display: table-row; /* ensure they show by default */
    }
    
    @media print {
      /* Hide only in print when discount is zero */
      .discount-zero .discount-row,
      .discount-zero .after-discount-row {
        display: none !important;
      }
    }
  
  /* Overlay (screen only) */
  .overlay {
    display: flex; /* ✅ changed from none so it shows on screen */
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.55);
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .overlay-panel {
    background: #fff;
    border-radius: 10px;
    padding: 1rem 1.25rem;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(15,23,42,0.35);
  }
  .overlay-body {
    flex: 1;
    overflow-y: auto;
    margin-top: 0.25rem;
  }
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <button type="button" class="back-btn" onclick="goBack()">← Back</button>
    <div class="header-title">ISTOS Medical Private Limited</div>
  </div>
</header>

<!-- ========= Instruments modals ========= -->

<!-- Instruments for this quote (list) -->
<div id="instrumentModalOverlay" class="overlay" style="display:none;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Instruments for this Quote</h3>
      <button type="button"
              class="overlay-close"
              onclick="closeInstrumentModal()">✕</button>
    </div>

    <div style="margin-bottom:0.75rem; display:flex; justify-content:space-between; align-items:center;">
      <div style="font-size:12px; color:#64748b;">
        Manage all instruments included in this quotation.
      </div>
      <button type="button"
              class="btn-quote"
              onclick="openInstrumentPicker()">
        + Add Instrument
      </button>
    </div>

    <div class="overlay-body">
      <table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead>
          <tr style="background:#e5f0ff;">
            <th style="padding:0.35rem 0.4rem; border:1px solid #e2e8f0; width:50px;">Item#</th>
            <th style="padding:0.35rem 0.4rem; border:1px solid #e2e8f0; width:140px;">Cat / Material No.</th>
            <th style="padding:0.35rem 0.4rem; border:1px solid #e2e8f0;">Description</th>
            <th style="padding:0.35rem 0.4rem; border:1px solid #e2e8f0; width:70px; text-align:center;">Qty</th>
            <th style="padding:0.35rem 0.4rem; border:1px solid #e2e8f0; width:110px; text-align:right;">Unit Price (INR)</th>
            <th style="padding:0.35rem 0.4rem; border:1px solid #e2e8f0; width:120px; text-align:right;">Total Price (INR)</th>
            <th style="padding:0.35rem 0.4rem; border:1px solid #e2e8f0; width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="instrumentModalList"></tbody>
      </table>
    </div>

    <div style="margin-top:0.75rem; text-align:right;">
      <button type="button"
              class="btn-quote btn-quote-secondary"
              onclick="closeInstrumentModal()">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Instrument picker (from instruments master) -->
<div id="instrumentPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Instrument from Master</h3>
      <button type="button" class="overlay-close" onclick="closeInstrumentPicker()">✕</button>
    </div>
    <div id="instrumentPickerList" class="overlay-body">
      <!-- populated by openInstrumentPicker() -->
    </div>
  </div>
</div>

<!-- ========= Shared item modal (config / additional) ========= -->
<div id="itemModalOverlay"
     style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.45); z-index:2000; align-items:center; justify-content:center;">
  <div id="itemModal"
       style="width:520px; max-width:95%; background:#fff; border-radius:10px; box-shadow:0 18px 45px rgba(15,23,42,0.35); padding:1.25rem 1.5rem; font-family:'Inter',sans-serif; font-size:13px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
      <h3 id="itemModalTitle" style="margin:0; font-size:15px; color:#0d6efd;"></h3>
      <button type="button" onclick="closeItemModal()"
              style="border:none; background:transparent; font-size:18px; cursor:pointer;">×</button>
    </div>

    <form id="itemModalForm" onsubmit="saveItemFromModal(event)">
      <input type="hidden" id="itemModalType" value="config">
      <input type="hidden" id="itemCode" value="">
      <input type="hidden" id="itemLineIndex" value=""> <!-- which instrument line -->

      <div style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem;">
        <input id="itemCodeInput" type="text"
               placeholder="Item code (e.g., 030051 / TFB 1100)"
               style="flex:1 1 160px; min-width:0; padding:0.4rem 0.55rem; border:1px solid #cbd5e1; border-radius:6px;">
        <input id="itemQty" type="text"
               placeholder="Qty (or Included)"
               style="flex:0 1 110px; min-width:0; padding:0.4rem 0.55rem; border:1px solid #cbd5e1; border-radius:6px;">
        <div id="itemPriceGroup" style="flex:0 1 140px; min-width:0;">
          <input id="itemPrice" type="text"
                 placeholder="Unit price (INR)"
                 style="width:100%; padding:0.4rem 0.55rem; border:1px solid #cbd5e1; border-radius:6px;">
        </div>
      </div>

      <div style="margin-bottom:0.5rem;">
        <textarea id="itemDetails" rows="5"
                  placeholder="First line: main item name
Next lines: bullet lines starting with ' - '"
                  style="width:100%; padding:0.4rem 0.55rem; border:1px solid #cbd5e1; border-radius:6px; font-family:inherit; font-size:13px;"></textarea>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-bottom:0.6rem;">
        <button type="button" onclick="closeItemModal()"
                style="border:1px solid #cbd5e1; background:#fff; padding:0.35rem 0.75rem; border-radius:999px; font-size:12px; cursor:pointer;">Cancel</button>
        <button type="submit"
                style="border:none; background:#0d6efd; color:#fff; padding:0.35rem 0.9rem; border-radius:999px; font-size:12px; cursor:pointer;">Save item</button>
      </div>
    </form>

    <div id="itemModalList"
         style="max-height:180px; overflow:auto; border-top:1px solid #e2e8f0; padding-top:0.4rem;">
      <!-- existing items rendered here -->
    </div>
  </div>
</div>

<!-- Optional pickers for future config/additional masters -->
<div id="configPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Configuration Item</h3>
      <button type="button" class="overlay-close" onclick="closeConfigPicker()">✕</button>
    </div>
    <div id="configPickerList" class="overlay-body">
      <div style="font-size:12px; color:#64748b;">
        Configuration item master is not implemented yet. Use the form to add items manually.
      </div>
    </div>
  </div>
</div>

<div id="additionalPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Additional Item</h3>
      <button type="button" class="overlay-close" onclick="closeAdditionalPicker()">✕</button>
    </div>
    <div id="additionalPickerList" class="overlay-body">
      <div style="font-size:12px; color:#64748b;">
        Additional item master is not implemented yet. Use the form to add items manually.
      </div>
    </div>
  </div>
</div>

<div class="container">
  <table class="print-frame">
    <thead class="print-header">
      <tr>
        <td>
          <div class="quote-header">
            <div class="quote-header-body">
              <div class="quote-left">
                <div class="company-box">
                  <p>
                    <strong>ISTOS Medical Pvt Ltd.</strong>
                    #51/5, 2nd Cross, J.C. Ind Area, Bikasipura Main Road,
                    Yelachenahalli, Bangalore - 560062
                  </p>
                </div>
                <div class="hospital-box">
                  <p>
                    <strong>To:</strong><br>
                    <span id="toHospitalNameLine"></span><br>
                    <span id="toHospitalAddressLine1"></span><br>
                    <span id="toHospitalAddressLine2"></span>
                  </p>
                </div>
                <div class="attn-box">
                  KIND ATTN: <span id="toAttn"></span>
                </div>
              </div>

              <div class="quote-right">
                <div class="quote-logo-wrap">
                  <img src="../images/istos-logo.jpg" alt="ISTOS Medical Logo">
                </div>
                <div class="sales-box">
                  <div class="sales-title">SALES QUOTATION</div>
                </div>
                <div class="quote-meta-grid">
                  <div class="label">Quote No.</div><div class="value" id="metaQuoteNo"></div>
                  <div class="label right">Quotation Date</div><div class="value value-small right" id="metaQuoteDate"></div>
                  <div class="label">Your Reference</div><div class="value value-small" id="metaYourRef"></div>
                  <div class="label right">Ref Date</div><div class="value value-small right" id="metaRefDate"></div>
                  <div class="label">Your Contact Person</div><div class="value value-small" id="metaContactPerson"></div>
                  <div class="label right">Handphone</div><div class="value value-small right" id="metaPhone"></div>
                  <div class="label">Email</div><div class="value value-small" id="metaEmail"></div>
                  <div class="label right">Office</div><div class="value value-small right" id="metaOffice"></div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </thead>

    <tbody class="print-body">
      <tr>
        <td>
          <div id="salesNoteBlock"></div>

          <!-- Builder wrapper -->
          <div id="quoteBuilder" class="no-print">
            <h3 class="no-print">Quote Builder</h3>

            <div class="quote-actions no-print">
              <button type="button" class="btn-quote" onclick="openInstrumentModal()">
                Manage Instruments
              </button>
            </div>
          </div>

          <table class="quote-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Cat / Material No.<br>Description</th>
                <th>Quantity</th>
                <th>Unit Price (INR)</th>
                <th>Total Price (INR)</th>
              </tr>
            </thead>
            <tbody id="quoteBuilderBody"></tbody>
            <tbody id="quoteSummaryBody"></tbody>
          </table>

          <table style="width:100%; margin-top:1.5rem; border-collapse:collapse;">
            <tr>
              <td style="font-size:13px; line-height:1.5;">
                We will be happy to furnish any further information or assistance you may need and trust that you call on us to fill your order, which will receive our prompt and careful attention.
                <br><br><br>
                For ISTOS Medical Private Limited
                <br><br><br>
                Naushad
              </td>
            </tr>
          </table>

          <div id="termsBlock">
            <h2>Terms and Conditions of Sale</h2>
            <div id="termsTextBlock"></div>
          </div>
        </td>
      </tr>
    </tbody>

    <tfoot class="print-footer">
      <tr>
        <td>
          <div class="footer">
            ISTOS Medical Private Limited<br>
            # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area,
            Bikasipura Main Road, Yelachenahalli,<br>
            BANGALORE, Karnataka, INDIA 560 062<br>
            P: +91 80 2686 0607 | F: +91 80 2686 0668 |
            E: talktous@istos.in | www.istosmedical.com<br>
            CIN: U74999KA2016PTC096385 &nbsp; GST: 29AAECI2502G1ZV
          </div>
        </td>
      </tr>
    </tfoot>
  </table>

  <div style="margin-top:1.5rem; text-align:right;" class="no-print">
    <button type="button" class="btn-finalize" onclick="finalizeQuote()">
      ✅ Finalize &amp; Save to History
    </button>
  </div>
</div>

<script>
  /* ========= Basic helpers ========= */

  function goBack() {
    if (window.history.length > 1) window.history.back();
  }

  function formatISOToDMY(iso) {
    if (!iso) return '';
    const [y, m, d] = iso.split('-');
    return `${d}-${m}-${y}`;
  }

  function splitAddress(address) {
    if (!address) return ['', ''];
    const parts = address.split(',');
    if (parts.length < 2) return [address.trim(), ''];
    const line2 = parts.slice(-1)[0].trim();
    const line1 = parts.slice(0, -1).join(',').trim();
    return [line1, line2];
  }

  function moneyINR(value) {
    const num = Number(value || 0);
    return num.toLocaleString('en-IN', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function parseLines(raw) {
    if (!raw) return [];
    return String(raw)
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);
  }

  function parseDetailsText(raw) {
    const lines = String(raw || '')
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);
    const name = lines[0] || '';
    const rest = lines.slice(1);
    return { name, rest };
  }

  /* ========= Storage and context ========= */

  function getQuoteHeaderRaw() {
    return JSON.parse(localStorage.getItem('quoteHeader') || '{}');
  }

  function saveQuoteHeader(header) {
    localStorage.setItem('quoteHeader', JSON.stringify(header));
  }

  function getInstrumentsMaster() {
    return JSON.parse(localStorage.getItem('instruments') || '[]');
  }

  function validateHeader(header) {
    const errors = [];
    if (!header.quoteNo)         errors.push('Quote No is missing');
    if (!header.quoteDate)       errors.push('Quote Date is missing');
    if (!header.refDate)         errors.push('Reference Date is missing');
    if (!header.hospitalName)    errors.push('Hospital Name is missing');
    if (!header.hospitalAddress) errors.push('Hospital Address is missing');

    if (errors.length) {
      alert('Validation errors:\n' + errors.join('\n'));
      return false;
    }
    return true;
  }

  function getQuoteContext() {
    const header = getQuoteHeaderRaw();
    const instruments = getInstrumentsMaster();
    if (!Array.isArray(header.quoteLines)) header.quoteLines = [];
    return { header, instruments, lines: header.quoteLines };
  }

  /* ========= Populate letterhead from header ========= */

  function populateHeader() {
    const header = getQuoteHeaderRaw();
    if (!validateHeader(header)) return;

    document.getElementById('metaQuoteNo').textContent   = header.quoteNo || '';
    document.getElementById('metaQuoteDate').textContent = formatISOToDMY(header.quoteDate);
    document.getElementById('metaYourRef').textContent   = header.yourReference || '';
    document.getElementById('metaRefDate').textContent   = formatISOToDMY(header.refDate);
    document.getElementById('metaContactPerson').textContent = header.contactPerson || '';
    document.getElementById('metaPhone').textContent     = header.contactPhone || '';
    document.getElementById('metaEmail').textContent     = header.contactEmail || '';
    document.getElementById('metaOffice').textContent    = header.officePhone || '';

    document.getElementById('toHospitalNameLine').textContent =
      header.hospitalName || 'Hospital / Client Name';

    const [line1, line2] = splitAddress(header.hospitalAddress || '');
    document.getElementById('toHospitalAddressLine1').textContent = line1 || '';
    document.getElementById('toHospitalAddressLine2').textContent = line2 || '';
    document.getElementById('toAttn').textContent = header.kindAttn || 'Attention';

    const noteEl = document.getElementById('salesNoteBlock');
    if (noteEl && header.salesNote) {
      noteEl.textContent = header.salesNote;
    }

    const termsEl = document.getElementById('termsTextBlock');
    if (termsEl) {
      if (header.termsHtml) {
        termsEl.innerHTML = header.termsHtml;
      } else if (header.termsText) {
        termsEl.textContent = header.termsText;
      } else {
        termsEl.textContent = '';
      }
    }
  }

  /* ========= Cell formatters ========= */

  function formatInstrumentCell(inst, lineIdx) {
    const code     = inst.catalog || inst.instrumentCode || inst.code || '';
    const name     = inst.instrumentName || inst.name || '';
    const descText = inst.longDescription || inst.description || '';
  
    const descLines = parseLines(descText);
  
    // Supplied Complete with (string or array)
    let suppliedRaw =
      inst.suppliedCompleteWith || inst.suppliedWith || inst.supplied || '';
    let suppliedLines;
    if (Array.isArray(suppliedRaw)) {
      suppliedLines = suppliedRaw.map(String).filter(Boolean);
    } else {
      suppliedLines = parseLines(String(suppliedRaw || ''));
    }
  
    // Meta: Country of Origin + HSN
    const origin = inst.origin || inst.country || inst.countryOfOrigin || '';
    const hsn    = inst.hsn || inst.hsnCode || '';
  
    let html = `<td style="white-space:pre-line; vertical-align:top; line-height:1.35;">`;
  
    // Cat / Material No.
    if (code) {
      html += `<div class="cat-main" style="margin-bottom:2px;">${code}</div>`;
    }
  
    // Main instrument name
    if (name) {
      html += `<div style="font-weight:600; margin-bottom:4px;">${name}</div>`;
    }
  
    // Description
    if (descLines.length) {
      html += descLines.map(l => `<div>${l}</div>`).join('');
      html += `<div style="height:8px;"></div>`;
    }
  
    // Supplied Complete with block (indented bullets)
    if (suppliedLines.length) {
      html += `<div style="font-weight:600; margin-bottom:2px;">Supplied Complete with:</div>`;
      suppliedLines.forEach(line => {
        html += `<div style="padding-left:1.25rem;">- ${line}</div>`;
      });
    }
  
       // One vertical gap before meta
    if (origin || hsn) {
      html += `<div style="height:8px;"></div>`;
    }
  
    if (origin) {
      html += `<div>Country of Origin: ${origin}</div>`;
    }
    if (hsn) {
      html += `<div>HSN Code: ${hsn}</div>`;
    }
  
    // Per-instrument actions: config / additional items
    html += `
      <div style="margin-top:8px; display:flex; gap:0.4rem; flex-wrap:wrap;">
        <button type="button"
                class="btn-quote"
                onclick="openConfigModal(${lineIdx})">
          Config Items
        </button>
        <button type="button"
                class="btn-quote btn-quote-secondary"
                onclick="openAdditionalModal(${lineIdx})">
          Additional Items
        </button>
      </div>
    `;
  
    html += `</td>`;
    return html;
  }
  
  function formatItemCell(item) {
    const code       = item.code || item.catalog || '';
    const descSource = item.description || item.longDescription || '';
    const lines      = parseLines(descSource); // same helper as instruments
  
    const title = lines[0] || '';
    const rest  = lines.slice(1);
  
    // Supplied lines
    let suppliedRaw =
      item.suppliedCompleteWith ||
      item.suppliedWith ||
      item.supplied ||
      rest.join('\n');
  
    let suppliedLines;
    if (Array.isArray(suppliedRaw)) {
      suppliedLines = suppliedRaw.map(String).filter(Boolean);
    } else {
      suppliedLines = parseLines(String(suppliedRaw || ''));
    }
  
    const origin = item.origin || item.country || item.countryOfOrigin || '';
    const hsn    = item.hsn || item.hsnCode || '';
  
    let html = `<td style="white-space:pre-line; vertical-align:top; line-height:1.35;">`;
  
    // ItemCat / Material number
    if (code) {
      html += `<div class="cat-main" style="margin-bottom:2px;">${code}</div>`;
    }
  
    // Main name
    if (title) {
      html += `<div style="font-weight:600; margin-bottom:4px;">${title}</div>`;
    }
  
    // Supplied Complete with (bulleted, indented)
    if (suppliedLines.length) {
      html += `<div style="font-weight:600; margin-bottom:2px;">Supplied Complete with:</div>`;
      suppliedLines.forEach(line => {
        html += `<div style="padding-left:1.25rem;">- ${line}</div>`;
      });
    }
  
    // Vertical gap before meta
    if (origin || hsn) {
      html += `<div style="height:8px;"></div>`;
    }
  
    // Meta WITHOUT indentation or bullets
    if (origin) {
      html += `<div>Country of Origin: ${origin}</div>`;
    }
    if (hsn) {
      html += `<div>HSN Code: ${hsn}</div>`;
    }
  
    html += `</td>`;
    return html;
  }

  /* ========= Render main quote items ========= */

function renderQuoteBuilder() {
  const { instruments, lines } = getQuoteContext();
  const body = document.getElementById('quoteBuilderBody');
  if (!body) return;

  if (!lines.length) {
    body.innerHTML = '';
    const sb = document.getElementById('quoteSummaryBody');
    if (sb) sb.innerHTML = '';
    return;
  }

  const rows = [];
  let runningItemCode = 1;
  let itemsTotal = 0;

  lines.forEach((line, lineIdx) => {
    const inst = instruments[line.instrumentIndex] || null;
    if (!inst) return;

    const qty = Number(line.quantity || 1);
    const codeText = String(runningItemCode).padStart(3, '0');
    runningItemCode += 1;

    const instUnit = Number(inst.unitPrice || 0);
    const instTotal = instUnit * qty;
    itemsTotal += instTotal;

    // 1) main instrument row
    rows.push(`
      <tr>
        <td>${codeText}</td>
        ${formatInstrumentCell(inst, lineIdx)}
        <td>${qty}</td>
        <td>${moneyINR(instUnit)}</td>
        <td>${moneyINR(instTotal)}</td>
      </tr>
    `); // <- correct closing, no extra }

    // 2) configuration rows directly after this instrument
    const configItems = line.configItems || [];
    if (configItems.length) {
      rows.push(`
        <tr style="background:#00B0F0; color:#000;">
          <td colspan="5" style="font-weight:700;">
            Configuration Items
          </td>
        </tr>
      `);

      configItems.forEach(item => {
        const itemCode = String(runningItemCode).padStart(3, '0');
        runningItemCode += 1;

        const q      = item.qty != null ? item.qty : 'Included';
        const upRaw  = item.upInr != null ? item.upInr : 'Included';
        const tpRaw  = item.tpInr != null ? item.tpInr : 'Included';
        const upCell = typeof upRaw === 'number' ? moneyINR(upRaw) : upRaw;
        const tpCell = typeof tpRaw === 'number' ? moneyINR(tpRaw) : tpRaw;

        rows.push(`
          <tr>
            <td>${itemCode}</td>
            ${formatItemCell(item)}
            <td>${q}</td>
            <td>${upCell}</td>
            <td>${tpCell}</td>
          </tr>
        `);
      });
    }

    // 3) additional rows directly after this instrument
    const additionalItems = line.additionalItems || [];
    if (additionalItems.length) {
      rows.push(`
        <tr style="background:#00B0F0; color:#000;">
          <td colspan="5" style="font-weight:700;">
            Additional Items
          </td>
        </tr>
      `);

      additionalItems.forEach(item => {
        const itemCode = String(runningItemCode).padStart(3, '0');
        runningItemCode += 1;

        const qtyNum  = Number(item.qty || 1);
        const unitNum = Number(item.price || item.unitPrice || 0);
        const totalNum = unitNum * qtyNum;
        itemsTotal += totalNum;

        rows.push(`
          <tr>
            <td>${itemCode}</td>
            ${formatItemCell(item)}
            <td>${qtyNum.toString().padStart(2, '0')}</td>
            <td>${moneyINR(unitNum)}</td>
            <td>${moneyINR(totalNum)}</td>
          </tr>
        `);
      });
    }
  });

  body.innerHTML = rows.join('');
  renderSummaryRows(itemsTotal);
}

function renderSummaryRows(itemsTotal) {
  const sb = document.getElementById('quoteSummaryBody');
  if (!sb) return;

  const header = getQuoteHeaderRaw();
  const gstPercent = 18;
  const discount = Number(header.discount || 0);

  const afterDisc    = itemsTotal - discount;
  const gstAmount    = (afterDisc * gstPercent) / 100;
  const totalValue   = afterDisc + gstAmount;
  const roundedTotal = Math.round(totalValue);
  const roundOff     = roundedTotal - totalValue;

  let rows = `
    <tr>
      <td colspan="3"></td>
      <td style="text-align:right; font-size:12px; color:#475569;">Items Total</td>
      <td style="text-align:right; font-weight:600;">${moneyINR(itemsTotal)}</td>
    </tr>
  `;

  // ✅ Only render discount rows if discount > 0
  if (Number(discount) > 0) {
    rows += `
      <tr class="discount-row">
        <td colspan="3"></td>
        <td style="text-align:right; font-size:12px; color:#475569;">Discount</td>
        <td style="text-align:right; font-weight:600;">${moneyINR(discount)}</td>
      </tr>
      <tr class="after-discount-row">
        <td colspan="3"></td>
        <td style="text-align:right; font-size:12px; color:#475569;">After Discount</td>
        <td style="text-align:right; font-weight:600;">${moneyINR(afterDisc)}</td>
      </tr>
    `;
  }

  rows += `
    <tr>
      <td colspan="3"></td>
      <td style="text-align:right; font-size:12px; color:#475569;">GST @ ${gstPercent}%</td>
      <td style="text-align:right; font-weight:600;">${moneyINR(gstAmount)}</td>
    </tr>
    <tr>
      <td colspan="3"></td>
      <td style="text-align:right; font-size:12px; color:#475569;">Total Value</td>
      <td style="text-align:right; font-weight:600;">${moneyINR(totalValue)}</td>
    </tr>
    <tr>
      <td colspan="3"></td>
      <td style="text-align:right; font-size:12px; color:#475569;">Round Off</td>
      <td style="text-align:right; font-weight:600;">${moneyINR(roundOff)}</td>
    </tr>
    <tr>
      <td colspan="3"></td>
      <td style="text-align:right; font-size:12px;"><strong>Grand Total</strong></td>
      <td style="text-align:right; font-weight:700;">${moneyINR(roundedTotal)}</td>
    </tr>
  `;

  sb.innerHTML = rows;

  // Optional: keep CSS toggle if you want style-based control
  updateDiscountVisibility(discount);
}

function updateDiscountFromInput() {
  const input = document.getElementById('discountInput');
  if (!input) return;

  const raw      = input.value || '0';
  const cleaned  = raw.replace(/[^\d.]/g, '');
  const discount = parseFloat(cleaned) || 0;

  const header = getQuoteHeaderRaw();
  header.discount = discount;
  saveQuoteHeader(header);

  const { instruments, lines } = getQuoteContext();
  let itemsTotal = 0;

  lines.forEach(line => {
    const inst = instruments[line.instrumentIndex] || null;
    if (inst) {
      const qty = Number(line.quantity || 1);
      itemsTotal += Number(inst.unitPrice || 0) * qty;
    }

    (line.additionalItems || []).forEach(item => {
      const qtyNum  = Number(item.qty || 1);
      const unitNum = Number(item.price || item.unitPrice || 0);
      itemsTotal += qtyNum * unitNum;
    });
  });

  renderSummaryRows(itemsTotal);
}

function updateDiscountVisibility(discountValue) {
  const table = document.getElementById('quoteSummaryTable');
  if (!table) return;

  const header = getQuoteHeaderRaw?.() || {};
  const discount = discountValue != null 
    ? Number(discountValue) 
    : Number(header.discount || 0);

  if (discount === 0) {
    table.classList.add('discount-zero');
  } else {
    table.classList.remove('discount-zero');
  }
}

  /* ========= Instruments modal (frame) ========= */

  function openInstrumentModal() {
    const overlay = document.getElementById('instrumentModalOverlay');
    if (!overlay) return;
    renderInstrumentModalList();
    overlay.style.display = 'flex';
  }

  function closeInstrumentModal() {
    const overlay = document.getElementById('instrumentModalOverlay');
    if (overlay) overlay.style.display = 'none';
  }

function renderInstrumentModalList() {
  const listEl = document.getElementById('instrumentModalList');
  const { instruments, lines } = getQuoteContext();

  if (!lines.length) {
    listEl.innerHTML = `
      <tr>
        <td colspan="7" style="padding:0.4rem; font-size:12px; color:#64748b; text-align:center;">
          No instruments added yet for this quote.
        </td>
      </tr>`;
    return;
  }

  let rows = '';
  lines.forEach((line, idx) => {
    const inst = instruments[line.instrumentIndex] || {};
    const itemNo = String(idx + 1).padStart(2, '0');
    const code   = inst.catalog || inst.instrumentCode || '';
    const name   = inst.instrumentName || inst.name || 'Unnamed Instrument';
    const desc   = inst.description || inst.longDescription || '';
    const shortDesc = desc.replace(/\s+/g, ' ').slice(0, 80) + (desc.length > 80 ? '…' : '');

    const qty  = Number(line.quantity || 1);
    const unit = Number(inst.unitPrice || 0);
    const total = qty * unit;

    rows += `
      <tr>
        <td style="padding:0.3rem 0.4rem; border:1px solid #e2e8f0; text-align:center;">${itemNo}</td>
        <td style="padding:0.3rem 0.4rem; border:1px solid #e2e8f0;">${code}</td>
        <td style="padding:0.3rem 0.4rem; border:1px solid #e2e8f0;">
          <div style="font-weight:600;">${name}</div>
          <div style="font-size:11px; color:#64748b;">${shortDesc}</div>
        </td>
        <td style="padding:0.3rem 0.4rem; border:1px solid #e2e8f0; text-align:center;">${qty}</td>
        <td style="padding:0.3rem 0.4rem; border:1px solid #e2e8f0; text-align:right;">${moneyINR(unit)}</td>
        <td style="padding:0.3rem 0.4rem; border:1px solid #e2e8f0; text-align:right;">${moneyINR(total)}</td>
        <td style="padding:0.3rem 0.4rem; border:1px solid #e2e8f0;">
          <button type="button"
                  class="btn-quote"
                  style="font-size:11px; padding:0.2rem 0.6rem; margin-right:0.25rem;"
                  onclick="editInstrumentLine(${idx})">
            Edit
          </button>
          <button type="button"
                  class="btn-quote btn-quote-secondary"
                  style="font-size:11px; padding:0.2rem 0.6rem;"
                  onclick="removeInstrumentLine(${idx})">
            Remove
          </button>
        </td>
      </tr>
    `;
  });

  listEl.innerHTML = rows;
}

  function removeInstrumentLine(idx) {
    const { header } = getQuoteContext();
    if (!Array.isArray(header.quoteLines)) return;
    header.quoteLines.splice(idx, 1);
    saveQuoteHeader(header);
    renderQuoteBuilder();
    renderInstrumentModalList();
  }

  // Simple edit (quantity); can be extended to pick a different instrument
  function editInstrumentLine(idx) {
    const { header } = getQuoteContext();
    if (!Array.isArray(header.quoteLines) || !header.quoteLines[idx]) return;

    const currentQty = Number(header.quoteLines[idx].quantity || 1);
    const newQtyStr = prompt('Update quantity for this instrument:', String(currentQty));
    if (newQtyStr == null) return;
    const newQty = Math.max(1, Number(newQtyStr) || 1);

    header.quoteLines[idx].quantity = newQty;
    saveQuoteHeader(header);
    renderQuoteBuilder();
    renderInstrumentModalList();
  }

  /* ========= Instrument picker (from master) ========= */

  function openInstrumentPicker() {
    const overlay = document.getElementById('instrumentPickerOverlay');
    if (!overlay) return;

    const listEl = document.getElementById('instrumentPickerList');
    const instruments = getInstrumentsMaster();

    if (!instruments.length) {
      listEl.innerHTML = '<div style="font-size:12px; color:#64748b;">No instruments in master. Please create instruments first.</div>';
    } else {
      listEl.innerHTML = instruments.map((inst, idx) => {
        const name = inst.instrumentName || inst.name || 'Unnamed Instrument';
        const code = inst.catalog || inst.instrumentCode || '';
        const desc = inst.description || inst.longDescription || '';
        const shortDesc = desc.replace(/\s+/g, ' ').slice(0, 160) + (desc.length > 160 ? '…' : '');
        return `
          <div style="
            border-bottom:1px dashed #e2e8f0;
            padding:0.4rem 0;
            display:flex;
            align-items:flex-start;
            justify-content:space-between;
            gap:0.5rem;">
            
            <div style="font-size:12px; flex:1;">
              <div style="font-weight:600;">${code} ${name}</div>
              <div style="color:#64748b; margin-top:2px; font-size:11px;">
                ${shortDesc}
              </div>
            </div>

            <div style="display:flex; align-items:center; gap:0.25rem;">
              <input type="number" min="1" value="1"
                     id="instQty_${idx}"
                     style="width:50px; font-size:11px; padding:0.15rem 0.3rem; border-radius:4px; border:1px solid #cbd5e1;">
              <button type="button"
                      class="btn-quote"
                      onclick="addInstrumentToQuote(${idx})">
                Add
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    overlay.style.display = 'flex';
  }

  function closeInstrumentPicker() {
    const overlay = document.getElementById('instrumentPickerOverlay');
    if (overlay) overlay.style.display = 'none';
  }

  function addInstrumentToQuote(instIndex) {
    const header = getQuoteHeaderRaw();
    const qtyInput = document.getElementById(`instQty_${instIndex}`);
    const qty = Math.max(1, Number(qtyInput?.value || 1));

    if (!Array.isArray(header.quoteLines)) header.quoteLines = [];

    header.quoteLines.push({
      lineType: 'instrument',
      instrumentIndex: instIndex,
      quantity: qty,
      configItems: [],
      additionalItems: []
    });

    saveQuoteHeader(header);
    renderQuoteBuilder();
    renderInstrumentModalList();
  }

  /* ========= Config / additional modal wiring ========= */

  let currentEditIndex = null;

  function openConfigModal(lineIndex) {
    openItemModal('config', lineIndex);
  }

  function openAdditionalModal(lineIndex) {
    openItemModal('additional', lineIndex);
  }

  function openItemModal(type, lineIndex) {
    const { header } = getQuoteContext();
    const line = header.quoteLines[lineIndex] || { configItems: [], additionalItems: [] };

    const overlay = document.getElementById('itemModalOverlay');
    const titleEl = document.getElementById('itemModalTitle');
    const typeEl  = document.getElementById('itemModalType');
    const lineEl  = document.getElementById('itemLineIndex');

    const codeEl      = document.getElementById('itemCodeInput');
    const qtyEl       = document.getElementById('itemQty');
    const priceEl     = document.getElementById('itemPrice');
    const priceGroup  = document.getElementById('itemPriceGroup');
    const detailsEl   = document.getElementById('itemDetails');

    currentEditIndex = null;
    typeEl.value = type;
    lineEl.value = String(lineIndex);

    titleEl.textContent = type === 'config'
      ? 'Configuration Items for this Instrument'
      : 'Additional Items for this Instrument';

    codeEl.value    = '';
    qtyEl.value     = type === 'config' ? 'Included' : '1';
    detailsEl.value = '';
    if (priceGroup) priceGroup.style.display = (type === 'config') ? 'none' : 'block';
    if (priceEl) priceEl.value = '';

    renderItemModalList(line, type);
    overlay.style.display = 'flex';
  }

  function closeItemModal() {
    const overlay = document.getElementById('itemModalOverlay');
    if (overlay) overlay.style.display = 'none';
    currentEditIndex = null;
  }

  function renderItemModalList(line, type) {
    const listEl = document.getElementById('itemModalList');
    const arr = type === 'config' ? (line.configItems || []) : (line.additionalItems || []);

    if (!arr.length) {
      listEl.innerHTML = '<div style="font-size:12px; color:#64748b;">No items yet for this instrument.</div>';
      return;
    }

    listEl.innerHTML = arr.map((item, idx) => {
      const qty = item.qty != null ? item.qty : (type === 'config' ? 'Included' : '1');
      const price = type === 'config'
        ? 'Included'
        : (item.price || item.unitPrice || item.upInr || item.tpInr || '');
      return `
        <div style="display:flex; align-items:center; justify-content:space-between;
                    padding:0.25rem 0; border-bottom:1px dashed #e2e8f0;">
          <div style="flex:1; font-size:12px;">
            <div style="font-weight:600;">${item.code || ''} ${item.name || ''}</div>
            <div style="color:#64748b;">Qty: ${qty} &nbsp; | &nbsp; Price: ${price}</div>
          </div>
          <div style="display:flex; gap:0.25rem;">
            <button type="button"
                    class="btn-quote"
                    onclick="editItemFromModal('${type}', ${idx})">
              Edit
            </button>
            <button type="button"
                    class="btn-quote btn-quote-secondary"
                    onclick="removeItemFromModal('${type}', ${idx})">
              Remove
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  function editItemFromModal(type, idx) {
    const { header } = getQuoteContext();
    const lineIndex = Number(document.getElementById('itemLineIndex').value || 0);
    const line = header.quoteLines[lineIndex] || { configItems: [], additionalItems: [] };
    const arr = type === 'config' ? (line.configItems || []) : (line.additionalItems || []);
    const item = arr[idx];
    if (!item) return;

    currentEditIndex = idx;

    document.getElementById('itemModalType').value = type;

    const titleEl = document.getElementById('itemModalTitle');
    titleEl.textContent = type === 'config' ? 'Edit Configuration Item' : 'Edit Additional Item';

    const codeEl     = document.getElementById('itemCodeInput');
    const qtyEl      = document.getElementById('itemQty');
    const priceEl    = document.getElementById('itemPrice');
    const priceGroup = document.getElementById('itemPriceGroup');
    const detailsEl  = document.getElementById('itemDetails');

    codeEl.value = item.code || '';
    qtyEl.value  = item.qty != null ? item.qty : (type === 'config' ? 'Included' : '1');

    if (priceGroup) priceGroup.style.display = (type === 'config') ? 'none' : 'block';

    if (type === 'config') {
      if (priceEl) priceEl.value = '';
    } else {
      let raw = item.price || item.unitPrice || item.upInr || item.tpInr || '';
      raw = String(raw).replace(/[^\d.]/g, '');
      if (priceEl) priceEl.value = raw;
    }

    detailsEl.value = item.description || '';
    document.getElementById('itemModalOverlay').style.display = 'flex';
  }

  function removeItemFromModal(type, idx) {
    const { header } = getQuoteContext();
    const lineIndex = Number(document.getElementById('itemLineIndex').value || 0);
    const line = header.quoteLines[lineIndex] || { configItems: [], additionalItems: [] };

    const arrName = type === 'config' ? 'configItems' : 'additionalItems';
    const arr = line[arrName] || [];
    arr.splice(idx, 1);
    line[arrName] = arr;

    header.quoteLines[lineIndex] = line;
    saveQuoteHeader(header);

    renderQuoteBuilder();
    renderItemModalList(line, type);
  }

  function saveItemFromModal(e) {
    e.preventDefault();

    const { header } = getQuoteContext();
    const typeEl    = document.getElementById('itemModalType');
    const lineIndex = Number(document.getElementById('itemLineIndex').value || 0);
    const codeEl    = document.getElementById('itemCodeInput');
    const qtyEl     = document.getElementById('itemQty');
    const priceEl   = document.getElementById('itemPrice');
    const detailsEl = document.getElementById('itemDetails');

    const type = typeEl.value;
    const code = (codeEl.value || '').trim();
    const { name } = parseDetailsText(detailsEl.value);
    if (!name) return;

    const line = header.quoteLines[lineIndex] || { configItems: [], additionalItems: [] };
    const arrName = type === 'config' ? 'configItems' : 'additionalItems';
    if (!Array.isArray(line[arrName])) line[arrName] = [];

    const isEdit = currentEditIndex != null;
    const idx = isEdit ? currentEditIndex : line[arrName].length;

    if (type === 'config') {
      const existingCode = isEdit && line.configItems[idx]?.code || null;
      const item = {
        code: code || existingCode || `CFG-${String(line.configItems.length + 1).padStart(2, '0')}`,
        name,
        description: detailsEl.value,
        qty: qtyEl.value || 'Included',
        upInr: 'Included',
        tpInr: 'Included'
      };
      line.configItems[idx] = item;

    } else {
      const existingCode = isEdit && line.additionalItems[idx]?.code || null;
      const rawPrice = priceEl?.value || '0';
      const cleanedPrice = rawPrice.replace(/[^\d.]/g, '');
      const priceNum = parseFloat(cleanedPrice) || 0;

      const item = {
        code: code || existingCode || `ADD-${String(line.additionalItems.length + 1).padStart(2, '0')}`,
        name,
        description: detailsEl.value,
        qty: Number(qtyEl.value || 1),
        price: priceNum
      };
      line.additionalItems[idx] = item;
    }

    currentEditIndex = null;
    header.quoteLines[lineIndex] = line;
    saveQuoteHeader(header);
    renderQuoteBuilder();
    renderItemModalList(line, type);
  }

  /* ========= Finalize quote ========= */

  function buildLineItemsFromCurrentQuote() {
    const { instruments, lines } = getQuoteContext();
    const items = [];

    lines.forEach(line => {
      const inst = instruments[line.instrumentIndex] || null;
      if (inst) {
        items.push({
          name: inst.instrumentName || inst.name || '',
          code: inst.catalog || inst.instrumentCode || '',
          type: 'Instrument',
          price: Number(inst.unitPrice || 0)
        });
      }

      (line.configItems || []).forEach(item => {
        const price = item.tpInr != null
          ? Number(item.tpInr)
          : Number(item.upInr || 0);
        items.push({
          name: item.name || item.itemName || '',
          code: item.code || item.catalog || '',
          type: 'Configuration',
          price
        });
      });

      (line.additionalItems || []).forEach(item => {
        const unitNum = Number(item.price || item.unitPrice || item.upInr || item.tpInr || 0);
        items.push({
          name: item.name || item.itemName || '',
          code: item.code || item.catalog || '',
          type: 'Additional',
          price: unitNum
        });
      });
    });

    return items;
  }

  function finalizeQuote() {
    const header = getQuoteHeaderRaw();
    if (!validateHeader(header)) return;

    const { instruments, lines } = getQuoteContext();
    if (!lines.length) {
      alert('No instruments in this quote. Please add at least one instrument.');
      return;
    }

    let itemsTotal = 0;
    lines.forEach(line => {
      const inst = instruments[line.instrumentIndex] || null;
      if (inst) {
        const qty = Number(line.quantity || 1);
        itemsTotal += (Number(inst.unitPrice || 0) * qty);
      }
      (line.additionalItems || []).forEach(item => {
        const qtyNum = Number(item.qty || 1);
        const unitNum = Number(item.price || item.unitPrice || 0);
        itemsTotal += qtyNum * unitNum;
      });
    });

    const gstPercent = 18;
    const discount = 0;
    const afterDisc = itemsTotal - discount;
    const gstAmount = (afterDisc * gstPercent) / 100;
    const totalValue = afterDisc + gstAmount;
    const roundedTotal = Math.round(totalValue);

    const summary = {
      itemsTotal,
      discount,
      afterDiscount: afterDisc,
      freight: 'Included',
      gstPercent,
      gstAmount,
      totalValue,
      roundOff: roundedTotal - totalValue
    };

    const lineItems = buildLineItemsFromCurrentQuote();
    const existing = JSON.parse(localStorage.getItem('quotes') || '[]');

    const sameQuote = existing.filter(q => q.header && q.header.quoteNo === header.quoteNo);
    const lastRev = sameQuote.length
      ? Math.max(...sameQuote.map(q => Number(q.revision || 1)))
      : 0;
    const nextRev = lastRev + 1;

    const now = new Date();
    const quote = {
      header,
      lineItems,
      summary,
      quoteNo: header.quoteNo,
      revision: nextRev,
      status: 'submitted',
      history: [{
        status: 'submitted',
        date: now.toISOString().slice(0, 10),
        time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      }]
    };

    existing.push(quote);
    localStorage.setItem('quotes', JSON.stringify(existing));
    alert(`Quote saved to history as ${header.quoteNo} (Rev ${nextRev}).`);
  }

  /* ========= Init ========= */

  document.addEventListener('DOMContentLoaded', function () {
    populateHeader();
    renderQuoteBuilder();
  });
</script>
</body>
</html>


</body>
</html>
