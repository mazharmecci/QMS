<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Quotes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ===== Base & Layout ===== */
  
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }
  
  html,
  body {
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
    background: #0f172a;
    color: #0f172a;
  }
  
  /* ===== Header ===== */
  
  header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(90deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.97));
    border-bottom: 1px solid rgba(148, 163, 184, 0.28);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
  }
  
  .header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0.75rem 1.5rem;
    color: #f9fafb;
  }
  
  .header-title {
    flex: 1;
    text-align: center;
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  
  .header-title span {
    color: #60a5fa;
  }
  
  /* Header buttons */
  
  .back-btn,
  .logout-btn {
    border: none;
    border-radius: 999px;
    padding: 0.35rem 0.9rem;
    font-size: 0.8rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: background 0.15s ease, transform 0.12s ease, box-shadow 0.15s ease;
  }
  
  .back-btn {
    background: rgba(255, 255, 255, 0.1);
    color: #f9fafb;
  }
  
  .back-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
  }
  
  .logout-btn {
    background: rgba(15, 23, 42, 0.96);
    color: #f9fafb;
    border: 1px solid rgba(148, 163, 184, 0.5);
  }
  
  .logout-btn:hover {
    background: rgba(248, 113, 113, 0.15);
    color: #fecaca;
    border-color: rgba(248, 113, 113, 0.7);
    box-shadow: 0 6px 18px rgba(248, 113, 113, 0.4);
    transform: translateY(-1px);
  }
  
  /* ===== Main Container / Print Frame ===== */
  
  .container {
    max-width: 1320px;
    margin: 1.5rem auto 2rem;
    padding: 1.5rem 2rem 2rem;
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.3);
  }
  
  .print-frame {
    width: 100%;
    border-collapse: collapse;
  }
  
  /* ===== Quote Header Block ===== */
  
  .quote-header {
    border: 1px solid #d4d4d8;
    border-radius: 12px;
    background: #f9fafb;
    padding: 1.5rem 1.75rem;
  }
  
  .quote-header-body {
    display: flex;
    gap: 1.25rem;
  }
  
  .quote-left,
  .quote-right {
    flex: 1 1 0;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }
  
  /* Company box */
  
  .company-box {
    background: #e5e7eb;
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: 0.7rem;
  }
  
  .company-box p {
    margin: 0;
    color: #111827;
  }
  
  /* Hospital / Attn */
  
  .hospital-box {
    margin-top: 0.5rem;
    font-size: 0.8rem;
  }
  
  .hospital-box p {
    margin: 0;
  }
  
  .attn-box {
    margin-top: 0.4rem;
    background: #bfdbfe;
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    font-weight: 600;
    color: #0f172a;
  }
  
  /* Logo + sales title */
  
  .quote-logo-wrap {
    align-self: flex-end;
    margin-bottom: 0.25rem;
  }
  
  .quote-logo-wrap img {
    max-height: 60px;
    width: auto;
    display: block;
  }
  
  .sales-box {
    align-self: flex-end;
    background: #e5e7eb;
    border-radius: 8px;
    padding: 0.35rem 0.9rem;
    margin-bottom: 0.5rem;
  }
  
  .sales-title {
    margin: 0;
    font-weight: 700;
    font-size: 0.95rem;
    letter-spacing: 0.05em;
    color: #0d6efd;
  }
  
  /* Meta grid */
  
  .quote-meta-grid {
    background: #ffffff;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    padding: 0.75rem 0.9rem;
    display: grid;
    grid-template-columns: minmax(0, auto) minmax(0, 2fr) minmax(0, auto) minmax(0, 1.7fr);
    column-gap: 0.5rem;
    row-gap: 0.35rem;
    font-size: 0.75rem;
  }
  
  .quote-meta-grid .label {
    font-size: 0.65rem;
    font-weight: 500;
    color: #6b7280;
    text-align: left;
  }
  
  .quote-meta-grid .value {
    font-size: 0.8rem;
    font-weight: 600;
    color: #111827;
    word-break: break-word;
  }
  
  .quote-meta-grid .value-small {
    font-size: 0.75rem;
  }
  
  .quote-meta-grid .label.right,
  .quote-meta-grid .value.right {
    text-align: right;
  }
  
  /* ===== Sales Note ===== */
  
  #salesNoteBlock {
    margin: 0.8rem 0 1rem;
    font-size: 0.85rem;
    line-height: 1.5;
    white-space: pre-line;
    color: #374151;
  }
  
  /* ===== Quote Builder & Buttons (edit only) ===== */
  
  #quoteBuilder {
    margin: 1rem 0 1.25rem;
    padding: 1rem 1.2rem;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
  }
  
  #quoteBuilder h3 {
    margin: 0 0 0.5rem;
    color: #0d6efd;
    font-size: 0.95rem;
  }
  
  .quote-actions {
    margin-bottom: 0;
  }
  
  .btn-quote,
  .btn-finalize {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.3rem;
    border-radius: 999px;
    border: 1px solid #60a5fa;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    padding: 0.45rem 1.1rem;
    transition: background 0.2s ease, transform 0.12s ease, box-shadow 0.2s ease;
  }
  
  .btn-quote {
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    color: #0b1727;
  }
  
  .btn-quote-secondary {
    background: #f3f4f6;
    border-color: #cbd5e1;
  }
  
  .btn-quote:hover {
    background: linear-gradient(135deg, #ffffff, #dbeafe);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);
  }
  
  .btn-finalize {
    background: linear-gradient(135deg, #60a5fa, #2563eb);
    color: #ffffff;
    border-color: #1d4ed8;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.45);
  }
  
  .btn-finalize:hover {
    background: linear-gradient(135deg, #82b4ff, #1d4ed8);
    transform: translateY(-1px);
  }
  
  /* ===== Quote Table ===== */
  
  table.quote-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
    background: #ffffff;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
  }
  
  table.quote-table th,
  table.quote-table td {
    padding: 0.35rem 0.6rem;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.8rem;
    vertical-align: top;
  }
  
  table.quote-table th {
    background: linear-gradient(135deg, #e5f0ff, #dbeafe);
    font-size: 0.75rem;
    text-transform: capitalize;
    letter-spacing: 0.03em;
    color: #111827;
  }
  
  table.quote-table th:nth-child(3),
  table.quote-table td:nth-child(3) {
    text-align: center;
    white-space: nowrap;
  }
  
  table.quote-table th:nth-child(4),
  table.quote-table th:nth-child(5),
  table.quote-table td:nth-child(4),
  table.quote-table td:nth-child(5) {
    text-align: right;
    white-space: nowrap;
  }
  
  /* If you have an actions column in HTML, mark it with .no-print-col on th/td. */
  
  /* ===== Terms & Conditions ===== */
  
  #termsBlock {
    margin-top: 1.25rem;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    padding: 0.9rem 1rem;
    font-size: 0.8rem;
    line-height: 1.4;
    background: #f9fafb;
  }
  
  #termsBlock h2 {
    margin: 0 0 0.4rem;
    font-size: 0.85rem;
    color: #0d6efd;
  }
  
  #termsTextBlock {
    margin-top: 0.3rem;
  }
  
  /* ===== Footer ===== */
  
  .footer {
    font-size: 0.7rem;
    text-align: right;
    border-top: 1px solid #d4d4d8;
    padding-top: 0.25rem;
    margin-top: 0.5rem;
    color: #4b5563;
  }
  
  /* ===== Overlays / Modals ===== */
  
  .overlay {
    display: flex;
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.5);
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  
  .overlay-panel {
    background: #ffffff;
    border-radius: 12px;
    padding: 1rem 1.2rem;
    max-width: 900px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 14px 40px rgba(15, 23, 42, 0.35);
  }
  
  .overlay-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  
  .overlay-title {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 700;
    color: #0f172a;
  }
  
  .overlay-close {
    border: none;
    background: transparent;
    font-size: 1.1rem;
    cursor: pointer;
    color: #64748b;
  }
  
  .overlay-body {
    flex: 1;
    overflow-y: auto;
    margin-top: 0.25rem;
  }
  
  /* Shared item modal (non-overlay) */
  
  #itemModalOverlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.55);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  
  #itemModal {
    width: 620px;
    max-width: 95%;
    background: #ffffff;
    border-radius: 12px;
    padding: 1rem 1.2rem 0.8rem;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4);
    border: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
  }
  
  .item-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  
  .item-modal-title {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 700;
  }
  
  .item-modal-tag {
    font-size: 0.7rem;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    background: #eff6ff;
    color: #1d4ed8;
    border: 1px solid #bfdbfe;
  }
  
  .item-modal-close {
    border: none;
    background: transparent;
    font-size: 1.1rem;
    cursor: pointer;
    color: #64748b;
  }
  
  .item-modal-grid {
    display: grid;
    grid-template-columns: 1.1fr 0.9fr;
    gap: 0.5rem 0.75rem;
    margin-bottom: 0.75rem;
  }
  
  .item-modal-field label {
    display: block;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    margin-bottom: 0.15rem;
  }
  
  .item-modal-field input,
  .item-modal-field textarea {
    width: 100%;
    font-size: 0.8rem;
    padding: 0.35rem 0.45rem;
    border-radius: 6px;
    border: 1px solid #cbd5e1;
    outline: none;
  }
  
  .item-modal-field input:focus,
  .item-modal-field textarea:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
  }
  
  .item-modal-details {
    grid-column: 1 / -1;
  }
  
  .item-modal-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.4rem;
  }
  
  .item-modal-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .btn-item-secondary,
  .btn-item-primary {
    border-radius: 999px;
    border: 1px solid #cbd5e1;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.3rem 0.8rem;
    cursor: pointer;
  }
  
  .btn-item-secondary {
    background: #f1f5f9;
    color: #0f172a;
  }
  
  .btn-item-primary {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #ffffff;
    border-color: #1d4ed8;
  }
  
  /* Item list in modal */
  
  .item-modal-list {
    margin-top: 0.5rem;
    max-height: 210px;
    overflow-y: auto;
    border-top: 1px dashed #e2e8f0;
    padding-top: 0.4rem;
    font-size: 0.75rem;
  }
  
  .item-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0.35rem 0;
    border-bottom: 1px dashed #e2e8f0;
  }
  
  .item-row:last-child {
    border-bottom: none;
  }
  
  .item-row-main {
    flex: 1;
    margin-right: 0.5rem;
  }
  
  .item-row-main-title {
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 0.1rem;
  }
  
  .item-row-main-meta {
    color: #64748b;
  }
  
  .item-row-actions {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .item-row-actions button {
    border-radius: 999px;
    border: 1px solid #cbd5e1;
    font-size: 0.7rem;
    padding: 0.15rem 0.55rem;
    cursor: pointer;
    background: #f8fafc;
  }
  
  /* ===== Utility ===== */
  
  .no-print {
    display: block;
  }
  
  /* ===== Page & Print Styles ===== */
  
  @page {
    size: A4;
    margin: 15mm 15mm 20mm 15mm;
  }
  
  @media print {
  
    body {
      background: #ffffff !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  
    header {
      display: none !important;
    }
  
    .container {
      margin: 0;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
      max-width: 100%;
    }
  
    thead.print-header {
      display: table-header-group;
    }
  
    tfoot.print-footer {
      display: table-footer-group;
    }
  
    .no-print,
    .btn-finalize,
    .btn-quote,
    button,
    .overlay,
    #itemModalOverlay {
      display: none !important;
    }
  
    /* If you have any action column in quote table, mark it in HTML with .no-print-col */
    .quote-table th.no-print-col,
    .quote-table td.no-print-col {
      display: none !important;
      padding: 0 !important;
      margin: 0 !important;
    }
  
    #quoteBuilder,
    #termsBlock,
    table.quote-table {
      background: #ffffff !important;
      box-shadow: none !important;
      border: 1px solid #d4d4d8;
    }
  
    #termsBlock {
      page-break-before: always;
    }
  }

  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <!-- Back button far left -->
      <button id="backBtn" class="back-btn">← Back</button>

      <!-- Centered title -->
      <div class="header-title">
        ISTOS Medical Private Limited <span>- QMS</span>
      </div>

      <!-- Logout button far right -->
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
  </header>

  <!-- ========= Instruments modals ========= -->
  <!-- Instruments for this quote (list) -->
  <div id="instrumentModalOverlay" class="overlay" style="display:none;">
    <div class="overlay-panel">
      <div class="overlay-header">
        <h3 class="overlay-title">Instruments for this Quote</h3>
        <button type="button" class="overlay-close" id="closeInstrumentModalBtn">✕</button>
      </div>
      <div style="margin-bottom:0.75rem; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:12px; color:#64748b;">Manage all instruments included in this quotation.</div>
        <button type="button" class="btn-quote" id="openInstrumentPickerBtn">+ Add Instrument</button>
      </div>
      <div class="overlay-body">
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr style="background:#e5f0ff;">
              <th>Item#</th>
              <th>Cat / Material No.</th>
              <th>Description</th>
              <th>Qty</th>
              <th>Unit Price (INR)</th>
              <th>Total Price (INR)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="instrumentModalList"></tbody>
        </table>
      </div>
      <div style="margin-top:0.75rem; text-align:right;">
        <button type="button" class="btn-quote btn-quote-secondary" id="closeInstrumentModalFooterBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit instrument (qty + price) -->
  <div id="editInstrumentOverlay" class="overlay" style="display:none; z-index:2200;">
    <div class="overlay-panel" style="max-width:400px;">
      <div class="overlay-header">
        <h3 class="overlay-title">Edit Instrument</h3>
        <button type="button" class="overlay-close" id="closeEditInstrumentBtn">✕</button>
      </div>
      <div class="overlay-body" style="padding:1.5rem;">
        <input type="hidden" id="editInstrumentIndex" value="-1" />

        <div class="item-modal-field" style="margin-bottom:0.75rem;">
          <label for="editQuantity">Quantity</label>
          <input
            id="editQuantity"
            type="number"
            min="1"
            value="1"
            style="width:100%; padding:0.5rem; border:1px solid #d1d5db; border-radius:0.375rem;"
          />
        </div>

        <div class="item-modal-field">
          <label for="editUnitPrice">Unit Price (INR)</label>
          <input
            id="editUnitPrice"
            type="number"
            min="0"
            step="0.01"
            placeholder="0.00"
            style="width:100%; padding:0.5rem; border:1px solid #d1d5db; border-radius:0.375rem;"
          />
        </div>
      </div>
      <div style="padding:0 1.5rem 1.5rem; text-align:right; border-top:1px solid #e5e7eb;">
        <button type="button" class="btn-quote btn-quote-secondary" id="cancelEditInstrumentBtn">Cancel</button>
        <button type="button" class="btn-quote" id="saveEditInstrumentBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Instrument picker -->
  <div id="instrumentPickerOverlay" class="overlay" style="display:none; z-index:2100;">
    <div class="overlay-panel">
      <div class="overlay-header">
        <h3 class="overlay-title">Select Instrument from Master</h3>
        <button type="button" class="overlay-close" id="closeInstrumentPickerBtn">✕</button>
      </div>
      <div id="instrumentPickerList" class="overlay-body"></div>
    </div>
  </div>

  <!-- Shared item modal -->
  <div id="itemModalOverlay">
    <div id="itemModal">
      <div class="item-modal-header">
        <div>
          <h3 id="itemModalTitle" class="item-modal-title">Additional Items for this Instrument</h3>
          <span id="itemModalTag" class="item-modal-tag">Additional</span>
        </div>
        <button type="button" id="closeItemModalBtn" class="item-modal-close">×</button>
      </div>

      <form id="itemModalForm">
        <input type="hidden" id="itemModalType" value="config" />
        <input type="hidden" id="itemLineIndex" value="" />

        <div class="item-modal-grid">
          <div class="item-modal-field">
            <label for="itemCodeInput">Item code</label>
            <input id="itemCodeInput" type="text" placeholder="Auto if left blank" />
          </div>

          <div class="item-modal-field" id="itemQtyGroup">
            <label for="itemQty">Quantity</label>
            <input id="itemQty" type="text" placeholder="1 or Included" />
          </div>

          <div class="item-modal-field" id="itemPriceGroup">
            <label for="itemPrice">Unit price (INR)</label>
            <input id="itemPrice" type="text" placeholder="0.00" />
          </div>

          <div class="item-modal-field item-modal-details">
            <label for="itemDetails">Details</label>
            <textarea
              id="itemDetails"
              rows="4"
              placeholder="First line: main item name
Next lines: brief description"
            ></textarea>
          </div>
        </div>

        <div class="item-modal-footer">
          <div id="itemModalHint" style="font-size:11px;color:#64748b;">
            No items yet for this instrument.
          </div>
          <div class="item-modal-actions">
            <button type="button" id="cancelItemModalBtn" class="btn-item-secondary">Cancel</button>
            <button type="submit" class="btn-item-primary">Save item</button>
          </div>
        </div>
      </form>

      <div id="itemModalList" class="item-modal-list"></div>
    </div>
  </div>

  <!-- Config/Additional pickers -->
  <div id="configPickerOverlay" class="overlay" style="display:none; z-index:2100;">
    <div class="overlay-panel">
      <div class="overlay-header">
        <h3 class="overlay-title">Select Configuration Item</h3>
        <button type="button" class="overlay-close" id="closeConfigPickerBtn">✕</button>
      </div>
      <div id="configPickerList" class="overlay-body">
        <div style="font-size:12px; color:#64748b;">Configuration item master is not implemented yet.</div>
      </div>
    </div>
  </div>

  <div id="additionalPickerOverlay" class="overlay" style="display:none; z-index:2100;">
    <div class="overlay-panel">
      <div class="overlay-header">
        <h3 class="overlay-title">Select Additional Item</h3>
        <button type="button" class="overlay-close" id="closeAdditionalPickerBtn">✕</button>
      </div>
      <div id="additionalPickerList" class="overlay-body">
        <div style="font-size:12px; color:#64748b;">Additional item master is not implemented yet.</div>
      </div>
    </div>
  </div>

  <!-- Main container -->
  <div class="container">
    <table class="print-frame">
      <thead class="print-header">
        <tr>
          <td>
            <div class="quote-header">
              <div class="quote-header-body">
                <!-- Left side: company + hospital -->
                <div class="quote-left">
                  <div class="company-box">
                    <p>
                      <strong>ISTOS Medical Pvt Ltd.</strong>
                      BSTN Heights, 2nd Cr J.C Indl Area, Bikasipura Main Road,
                      Yelachenahalli, Bangalore-560062
                    </p>
                  </div>

                  <div class="hospital-box">
                    <p>
                      <strong>To:</strong><br>
                      <span id="toHospitalNameLine"></span><br>
                      <span id="toHospitalAddressLine1"></span><br>
                      <span id="toHospitalAddressLine2"></span>
                    </p>
                  </div>

                  <div class="attn-box">
                    <span><strong>Kind Attn:</strong></span>
                    <span id="toAttn"></span>
                  </div>
                </div>

                <!-- Right side: logo + meta -->
                <div class="quote-right">
                  <div class="quote-logo-wrap">
                    <img src="../images/istos-logo.jpg" alt="ISTOS Medical Logo">
                  </div>

                  <div class="sales-box">
                    <div class="sales-title">SALES QUOTATION</div>
                  </div>

                  <div class="quote-meta-grid">
                    <div class="label">Quote No.</div>
                    <div class="value" id="metaQuoteNo"></div>

                    <div class="label right">Quotation Date</div>
                    <div class="value value-small right" id="metaQuoteDate"></div>

                    <div class="label">Your Reference</div>
                    <div class="value value-small" id="metaYourRef"></div>

                    <div class="label right">Ref Date</div>
                    <div class="value value-small right" id="metaRefDate"></div>

                    <div class="label">Your Contact Person</div>
                    <div class="value value-small" id="metaContactPerson"></div>

                    <div class="label right">Handphone</div>
                    <div class="value value-small right" id="metaPhone"></div>

                    <div class="label">Email</div>
                    <div class="value value-small" id="metaEmail"></div>

                    <div class="label right">Office</div>
                    <div class="value value-small right" id="metaOffice"></div>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </thead>

      <tbody class="print-body">
        <tr>
          <td>
            <!-- Sales note (free text) -->
            <div id="salesNoteBlock"></div>

            <!-- Quote builder controls (edit-only) -->
            <div id="quoteBuilder" class="no-print">
              <h3>Quote Builder</h3>
              <div class="quote-actions">
                <button type="button" class="btn-quote" id="openInstrumentModalBtn">
                  Manage Instruments
                </button>
              </div>
            </div>

            <!-- Line items + summary -->
            <table id="quoteSummaryTable" class="quote-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Cat / Material No.<br>Description</th>
                  <th>Quantity</th>
                  <th>Unit Price (INR)</th>
                  <th>Total Price (INR)</th>
                </tr>
              </thead>
              <tbody id="quoteBuilderBody"></tbody>
              <tbody id="quoteSummaryBody"></tbody>
            </table>

            <!-- Terms & Conditions -->
            <div id="termsBlock">
              <h2>Terms and Conditions of Sale</h2>
              <div id="termsTextBlock" contenteditable="true"></div>
            </div>
          </td>
        </tr>
      </tbody>

      <tfoot class="print-footer">
        <tr>
          <td>
            <div class="footer">
              ISTOS Medical Private Limited<br>
              # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area,
              Bikasipura Main Road, Yelachenahalli,<br>
              BANGALORE, Karnataka, INDIA 560 062<br>
              P: +91 80 2686 0607 | F: +91 80 2686 0668 |
              E: talktous@istos.in | www.istosmedical.com<br>
              CIN: U74999KA2016PTC096385 &nbsp; GST: 29AAECI2502G1ZV
            </div>
          </td>
        </tr>
      </tfoot>
    </table>

    <!-- Finalize actions (edit-only) -->
    <div class="no-print" style="margin-top:1.5rem; text-align:right;">
      <button type="button" class="btn-finalize" id="finalizeQuoteBtn">
        ✅ Finalize &amp; Save to History
      </button>
    </div>
  </div>

<script type="module">
  import {
    moneyINR,
    parseDetailsText,
    formatInstrumentCell,
    formatItemCell
  } from "../js/quoteUtils.js";

  import {
    getQuoteHeaderRaw,
    saveQuoteHeader,
    getInstrumentsMaster,
    getQuoteContext,
    validateHeader,
    finalizeQuote,
    buildQuoteObject
  } from "../js/quoteService.js";

  import {
    populateHeader,
    renderQuoteBuilder,
    openInstrumentModal,
    closeInstrumentModal,
    openInstrumentPicker,
    closeInstrumentPicker,
    addInstrumentToQuote,
    openConfigModal,
    openAdditionalModal,
    openItemModal,
    closeItemModal,
    renderItemModalList,
    editItemFromModal,
    removeItemFromModal,
    saveItemFromModal,
    addMasterItemToLine,
    renderInstrumentModalList
  } from "../js/quoteUI.js";

  import { db, doc, getDoc, auth, signOut } from "../js/firebase.js";

  let currentQuoteDocId = null;
  let quoteHydrated = false;

  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  function toDateInputValue(d) {
    if (!d) return "";
    const date = d instanceof Date ? d : new Date(d.seconds ? d.seconds * 1000 : d);
    if (Number.isNaN(date.getTime())) return "";
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, "0");
    const dd = String(date.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function hydrateLocalFromFirestoreDoc(docData, docId = null) {
    if (!docData || typeof docData !== "object") return null;
    if (docId) currentQuoteDocId = docId;
  
    const hosp = docData.hospital || {};
  
    const header = {
      quoteNo: docData.quoteNo || "",
      quoteDate: toDateInputValue(docData.quoteDate),
      hospitalName: hosp.name || docData.hospitalName || "",
      hospitalAddress: hosp.address || docData.hospitalAddress || "",
      contactPerson: hosp.contactPerson || docData.contactPerson || "",
      contactEmail: hosp.email || docData.contactEmail || "",
      contactPhone: hosp.phone || docData.contactPhone || "",
      officePhone: hosp.officePhone || docData.officePhone || "",
      yourReference: docData.yourReference || "",
      refDate: toDateInputValue(docData.refDate),
      kindAttn: hosp.kindAttn || docData.kindAttn || "",
      salesNote: docData.salesNote || "",
      termsHtml: docData.termsHtml || "",
      termsText: docData.termsText || "",
      discount: Number(docData.discount || 0),
      status: docData.status || "Submitted",
      gstPercent: Number(docData.gstPercent || 0),
      gstValueINR: Number(docData.gstValueINR || 0),
      totalValueINR: Number(docData.totalValueINR || 0),
      quoteLines: []
    };
  
    // 1) Prefer stored quoteLines (new model)
    if (Array.isArray(docData.quoteLines) && docData.quoteLines.length) {
      header.quoteLines = docData.quoteLines.map((line) => ({
        lineType: line.lineType || "instrument",
        instrumentIndex: line.instrumentIndex ?? 0,
        quantity: Number(line.quantity || 1),
        unitPriceOverride: line.unitPriceOverride ?? null,
        configItems: Array.isArray(line.configItems) ? line.configItems : [],
        additionalItems: Array.isArray(line.additionalItems) ? line.additionalItems : []
      }));
      console.log("[hydrate] Using quoteLines from Firestore:", header.quoteLines.length);
    } else {
      // 2) Legacy fallback: map items[] to quoteLines using master
      const instruments = getInstrumentsMaster();
      const items = Array.isArray(docData.items) ? docData.items : [];
      console.log("[hydrate] Legacy items length:", items.length);
  
      header.quoteLines = items.map((item) => {
        const code = item.instrumentCode || item.code || "";
        const name = item.instrumentName || item.name || "";
        let idx = instruments.findIndex(
          (inst) =>
            inst.instrumentCode === code ||
            inst.catalog === code ||
            inst.instrumentName === name ||
            inst.name === name
        );
        if (idx < 0) {
          console.warn("[hydrate] Instrument not found in master:", item);
          idx = 0;
        }
        return {
          lineType: "instrument",
          instrumentIndex: idx,
          quantity: item.quantity || 1,
          unitPriceOverride: item.unitPriceOverride || null,
          configItems: item.configItems || [],
          additionalItems: item.additionalItems || []
        };
      });
    }
  
    saveQuoteHeader(header);
    return header;
  }

  async function loadQuoteFromFirestoreIfNeeded() {
    const quoteId = getQueryParam("id");
    if (quoteId) {
      try {
        console.log("[quotes.html] Loading quote from Firestore for id:", quoteId);
        const ref = doc(db, "quoteHistory", quoteId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          hydrateLocalFromFirestoreDoc(snap.data(), snap.id);
          quoteHydrated = true;
          console.log("[quotes.html] Hydrated header from Firestore for id:", quoteId);
          return true;
        } else {
          console.warn("[quotes.html] No quoteHistory document for id", quoteId);
        }
      } catch (err) {
        console.error("[quotes.html] Error loading quote from Firestore:", err);
      }
      return false;
    }

    if (currentQuoteDocId) {
      console.log("[quotes.html] Editing Firestore quote:", currentQuoteDocId);
    } else {
      console.log("[quotes.html] Using existing local header (no Firestore id).");
    }
    quoteHydrated = true;
    return false;
  }

  function validateHeaderIfReady() {
    if (!quoteHydrated) {
      console.log("[quotes.html] Skipping header validation: quote not hydrated yet");
      return true; // allow if not hydrated yet to avoid false negatives
    }
    // validateHeader should itself log details and return true/false
    return validateHeader(getQuoteHeaderRaw());
  }

  // Edit instrument helpers (qty + price)
  function openEditInstrument(index) {
    const header = getQuoteHeaderRaw();
    const line = header.quoteLines[index];
    if (!line) return;

    document.getElementById("editInstrumentIndex").value = index;
    document.getElementById("editQuantity").value = line.quantity || 1;

    const instruments = getInstrumentsMaster();
    const instPrice = instruments[line.instrumentIndex]?.unitPrice || 0;
    document.getElementById("editUnitPrice").value =
      line.unitPriceOverride ?? instPrice ?? 0;

    document.getElementById("editInstrumentOverlay").style.display = "flex";
  }

  function closeEditInstrument() {
    const el = document.getElementById("editInstrumentOverlay");
    if (el) el.style.display = "none";
  }

  function saveEditInstrument() {
    const index = parseInt(document.getElementById("editInstrumentIndex").value, 10);
    const header = getQuoteHeaderRaw();
    const line = header.quoteLines[index];
    if (!line) return;

    const newQty = Number(document.getElementById("editQuantity").value) || 1;
    const newPrice = Number(document.getElementById("editUnitPrice").value) || 0;

    line.quantity = newQty;
    line.unitPriceOverride = newPrice > 0 ? newPrice : null;

    saveQuoteHeader(header);
    renderQuoteBuilder();
    renderInstrumentModalList();
    closeEditInstrument();
  }

  document.addEventListener("DOMContentLoaded", async () => {
    console.log("[quotes.html] DOMContentLoaded");

    await loadQuoteFromFirestoreIfNeeded();

    // Now render with hydrated header
    populateHeader();
    renderQuoteBuilder();

    // Sync terms block to header
    const termsEl = document.getElementById("termsTextBlock");
    if (termsEl) {
      const syncTermsToHeader = () => {
        const header = getQuoteHeaderRaw();
        header.termsHtml = termsEl.innerHTML;
        header.termsText = termsEl.innerText || "";
        saveQuoteHeader(header);
        console.log("[terms] Synced termsHtml length:", header.termsHtml.length);
      };
      ["input", "blur"].forEach(evt => termsEl.addEventListener(evt, syncTermsToHeader));
    }

    // Go back handler
    function goBack() {
      location.href = "/index.html";
    }
    document.getElementById("backBtn")?.addEventListener("click", goBack);

    // Logout
    document.getElementById("logoutBtn")?.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "https://qms.istosmedical.com/login.html";
      } catch (err) {
        console.error("Failed to sign out", err);
        alert("Could not log out. Please try again.");
      }
    });

    // Modal bindings
    const modalBindings = [
      ["openInstrumentModalBtn", openInstrumentModal],
      ["closeInstrumentModalBtn", closeInstrumentModal],
      ["closeInstrumentModalFooterBtn", closeInstrumentModal],
      ["openInstrumentPickerBtn", openInstrumentPicker],
      ["closeInstrumentPickerBtn", closeInstrumentPicker],
      ["closeItemModalBtn", closeItemModal],
      ["cancelItemModalBtn", closeItemModal]
    ];
    modalBindings.forEach(([id, handler]) => {
      document.getElementById(id)?.addEventListener("click", handler);
    });

    // Edit-instrument modal bindings
    [
      ["closeEditInstrumentBtn", closeEditInstrument],
      ["cancelEditInstrumentBtn", closeEditInstrument],
      ["saveEditInstrumentBtn", saveEditInstrument]
    ].forEach(([id, handler]) => {
      document.getElementById(id)?.addEventListener("click", handler);
    });

    // Item modal form
    document.getElementById("itemModalForm")?.addEventListener("submit", saveItemFromModal);

    // Overlay closers
    const overlayClosers = {
      closeConfigPickerBtn: "configPickerOverlay",
      closeAdditionalPickerBtn: "additionalPickerOverlay"
    };
    Object.entries(overlayClosers).forEach(([btnId, overlayId]) => {
      document.getElementById(btnId)?.addEventListener("click", () => {
        const el = document.getElementById(overlayId);
        if (el) el.style.display = "none";
      });
    });

    // Finalize button
    const finalizeBtn = document.getElementById("finalizeQuoteBtn");
    if (finalizeBtn) {
      let lastClickTime = 0;
      finalizeBtn.addEventListener("click", async () => {
        const now = Date.now();
        if (now - lastClickTime < 3000) {
          console.warn("[finalizeQuoteBtn] Ignored duplicate click.");
          return;
        }
        lastClickTime = now;
    
        console.log("[quotes.html] Finalize button clicked:", currentQuoteDocId);
    
        // 1) Validate header; if invalid, show message and STOP
        const ok = validateHeaderIfReady();
        if (!ok) {
          console.warn("[quotes.html] Header validation failed, aborting finalize.");
          return;
        }
    
        // 2) Only now perform Firestore writes
        finalizeBtn.disabled = true;
        try {
          await finalizeQuote(currentQuoteDocId);
        } finally {
          finalizeBtn.disabled = false;
        }
      });
    }

    // Next buttons (if any)
    const nextButtons = document.querySelectorAll(".btn-next");
    nextButtons.forEach(btn => {
      btn.addEventListener("click", async () => {
        const docId = btn.getAttribute("data-doc-id");
        if (!docId) {
          console.warn("[Next button] Missing data-doc-id");
          return;
        }
        console.log("[quotes.html] Next button clicked for docId:", docId);
        try {
          await approveQuoteRevision(docId);
        } catch (err) {
          console.error("[quotes.html] Error approving quote:", err);
          alert("Failed to approve quote. Please try again.");
        }
      });
    });
  });

  // Global hooks for inline handlers
  window.openConfigModal = openConfigModal;
  window.openAdditionalModal = openAdditionalModal;
  window.openItemModal = openItemModal;
  window.editItemFromModal = editItemFromModal;
  window.removeItemFromModal = removeItemFromModal;
  window.addInstrumentToQuote = addInstrumentToQuote;
  window.addMasterItemToLine = addMasterItemToLine;
  window.openEditInstrument = openEditInstrument;
  window.closeEditInstrument = closeEditInstrument;
  window.saveEditInstrument = saveEditInstrument;
</script>

</body>
</html>
