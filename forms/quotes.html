<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Quotes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ====== Styles from Block 1 ====== */
    body {
      font-family: 'Aptos Display', system-ui, 'Inter', sans-serif;
      background:#f5f7fa;
      margin:0;
    }
    header {
      background:#0d6efd;
      color:#fff;
      padding:0.75rem 1.5rem;
    }
    .header-inner {
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .back-btn {
      border:none;
      background:rgba(255,255,255,0.12);
      color:#fff;
      padding:0.45rem 0.9rem;
      border-radius:999px;
      cursor:pointer;
    }
    .header-title {
      flex:1;
      text-align:center;
      font-weight:600;
      font-size:1.5rem;
    }
    .container {
      max-width:1200px;
      margin:2rem auto;
      padding:2rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    /* ... (all other CSS from Block 1 remains unchanged) ... */
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <button type="button" class="back-btn" id="goBackBtn">← Back</button>
    <div class="header-title">ISTOS Medical Private Limited</div>
  </div>
</header>

<!-- ========= Instruments modals ========= -->
<div id="instrumentModalOverlay" class="overlay" style="display:none;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Instruments for this Quote</h3>
      <button type="button" class="overlay-close" id="closeInstrumentModalBtn">✕</button>
    </div>
    <div style="margin-bottom:0.75rem; display:flex; justify-content:space-between; align-items:center;">
      <div style="font-size:12px; color:#64748b;">Manage all instruments included in this quotation.</div>
      <button type="button" class="btn-quote" id="openInstrumentPickerBtn">+ Add Instrument</button>
    </div>
    <div class="overlay-body">
      <table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead>
          <tr style="background:#e5f0ff;">
            <th>Item#</th><th>Cat / Material No.</th><th>Description</th>
            <th>Qty</th><th>Unit Price (INR)</th><th>Total Price (INR)</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="instrumentModalList"></tbody>
      </table>
    </div>
    <div style="margin-top:0.75rem; text-align:right;">
      <button type="button" class="btn-quote btn-quote-secondary" id="closeInstrumentModalFooterBtn">Close</button>
    </div>
  </div>
</div>

<!-- Instrument picker -->
<div id="instrumentPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Instrument from Master</h3>
      <button type="button" class="overlay-close" id="closeInstrumentPickerBtn">✕</button>
    </div>
    <div id="instrumentPickerList" class="overlay-body"></div>
  </div>
</div>

<!-- Shared item modal -->
<div id="itemModalOverlay" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.45); z-index:2000; align-items:center; justify-content:center;">
  <div id="itemModal" style="width:520px; max-width:95%; background:#fff; border-radius:10px; box-shadow:0 18px 45px rgba(15,23,42,0.35); padding:1.25rem 1.5rem;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
      <h3 id="itemModalTitle" style="margin:0; font-size:15px; color:#0d6efd;"></h3>
      <button type="button" id="closeItemModalBtn" style="border:none; background:transparent; font-size:18px; cursor:pointer;">×</button>
    </div>
    <form id="itemModalForm">
      <input type="hidden" id="itemModalType" value="config">
      <input type="hidden" id="itemLineIndex" value="">
      <input id="itemCodeInput" type="text" placeholder="Item code" />
      <input id="itemQty" type="text" placeholder="Qty (or Included)" />
      <div id="itemPriceGroup"><input id="itemPrice" type="text" placeholder="Unit price (INR)" /></div>
      <textarea id="itemDetails" rows="5" placeholder="First line: main item name"></textarea>
      <div style="text-align:right;">
        <button type="button" id="cancelItemModalBtn">Cancel</button>
        <button type="submit">Save item</button>
      </div>
    </form>
    <div id="itemModalList"></div>
  </div>
</div>

<!-- Config/Additional pickers -->
<div id="configPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Configuration Item</h3>
      <button type="button" class="overlay-close" id="closeConfigPickerBtn">✕</button>
    </div>
    <div id="configPickerList" class="overlay-body">
      <div style="font-size:12px; color:#64748b;">Configuration item master is not implemented yet.</div>
    </div>
  </div>
</div>

<div id="additionalPickerOverlay" class="overlay" style="display:none; z-index:2100;">
  <div class="overlay-panel">
    <div class="overlay-header">
      <h3 class="overlay-title">Select Additional Item</h3>
      <button type="button" class="overlay-close" id="closeAdditionalPickerBtn">✕</button>
    </div>
    <div id="additionalPickerList" class="overlay-body">
      <div style="font-size:12px; color:#64748b;">Additional item master is not implemented yet.</div>
    </div>
  </div>
</div>

<!-- Main container -->
<div class="container">
  <table class="print-frame">
    <thead class="print-header">
      <tr><td>
        <div class="quote-header">
          <!-- Letterhead populated by populateHeader() -->
          <div class="quote-header-body">
            <div class="quote-left">
              <div class="company-box"><p><strong>ISTOS Medical Pvt Ltd.</strong> #51/5, Bangalore - 560062</p></div>
              <div class="hospital-box"><p><strong>To:</strong><br><span id="toHospitalNameLine"></span><br><span id="toHospitalAddressLine1"></span><br><span id="toHospitalAddressLine2"></span></p></div>
              <div class="attn-box">KIND ATTN: <span id="toAttn"></span></div>
            </div>
            <div class="quote-right">
              <div class="quote-logo-wrap"><img src="../images/istos-logo.jpg" alt="ISTOS Medical Logo"></div>
              <div class="sales-box"><div class="sales-title">SALES QUOTATION</div></div>
              <div class="quote-meta-grid">
                <div class="label">Quote No.</div><div class="value" id="metaQuoteNo"></div>
                <div class="label right">Quotation Date</div><div class="value value-small right" id="metaQuoteDate"></div>
                <div class="label">Your Reference</div><div class="value value-small" id="metaYourRef"></div>
                <div class="label right">Ref Date</div><div class="value value-small right" id="metaRefDate"></div>
                <div class="label">Your Contact Person</div>
<div class="value value-small" id="metaContactPerson"></div>

<div class="label right">Handphone</div>
<div class="value value-small right" id="metaPhone"></div>

<div class="label">Email</div>
<div class="value value-small" id="metaEmail"></div>

<div class="label right">Office</div>
<div class="value value-small right" id="metaOffice"></div>
</div> <!-- end quote-meta-grid -->
</div> <!-- end quote-right -->
</div> <!-- end quote-header-body -->
</div> <!-- end quote-header -->
</td>
</tr>
</thead>

<tbody class="print-body">
<tr>
  <td>
    <div id="salesNoteBlock"></div>

    <!-- Builder wrapper -->
    <div id="quoteBuilder" class="no-print">
      <h3 class="no-print">Quote Builder</h3>
      <div class="quote-actions no-print">
        <button type="button" class="btn-quote" id="openInstrumentModalBtn">
          Manage Instruments
        </button>
      </div>
    </div>

    <table id="quoteSummaryTable" class="quote-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Cat / Material No.<br>Description</th>
          <th>Quantity</th>
          <th>Unit Price (INR)</th>
          <th>Total Price (INR)</th>
        </tr>
      </thead>
      <tbody id="quoteBuilderBody"></tbody>
      <tbody id="quoteSummaryBody"></tbody>
    </table>

    <div id="termsBlock">
      <h2>Terms and Conditions of Sale</h2>
      <div id="termsTextBlock"></div>
    </div>
  </td>
</tr>
</tbody>

<tfoot class="print-footer">
<tr>
  <td>
    <div class="footer">
      ISTOS Medical Private Limited<br>
      # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area,
      Bikasipura Main Road, Yelachenahalli,<br>
      BANGALORE, Karnataka, INDIA 560 062<br>
      P: +91 80 2686 0607 | F: +91 80 2686 0668 |
      E: talktous@istos.in | www.istosmedical.com<br>
      CIN: U74999KA2016PTC096385 &nbsp; GST: 29AAECI2502G1ZV
    </div>
  </td>
</tr>
</tfoot>
</table>

<div style="margin-top:1.5rem; text-align:right;" class="no-print">
  <button type="button" class="btn-finalize" id="finalizeQuoteBtn">
    ✅ Finalize &amp; Save to History
  </button>
</div>
</div> <!-- end container -->

<!-- ========= Scripts ========= -->
<script type="module">
  import { 
    moneyINR, 
    parseDetailsText, 
    formatInstrumentCell, 
    formatItemCell 
  } from "./quoteUtils.js";

  import { 
    getQuoteHeaderRaw, 
    saveQuoteHeader, 
    getInstrumentsMaster, 
    getQuoteContext, 
    validateHeader, 
    finalizeQuote 
  } from "./quoteService.js";

  import { 
    renderQuoteBuilder,
    openInstrumentModal,
    closeInstrumentModal,
    openInstrumentPicker,
    closeInstrumentPicker,
    addInstrumentToQuote,
    openConfigModal,
    openAdditionalModal,
    openItemModal,
    closeItemModal,
    renderItemModalList,
    editItemFromModal,
    removeItemFromModal,
    saveItemFromModal,
    populateHeader
  } from "./quoteUI.js";

  // Basic helper: go back
  function goBack() {
    if (window.history.length > 1) window.history.back();
  }

  // Attach event listeners
  document.addEventListener("DOMContentLoaded", () => {
    populateHeader();
    renderQuoteBuilder();

    document.getElementById("goBackBtn")?.addEventListener("click", goBack);

    // Instrument modal
    document.getElementById("openInstrumentModalBtn")?.addEventListener("click", openInstrumentModal);
    document.getElementById("closeInstrumentModalBtn")?.addEventListener("click", closeInstrumentModal);
    document.getElementById("closeInstrumentModalFooterBtn")?.addEventListener("click", closeInstrumentModal);

    // Instrument picker
    document.getElementById("openInstrumentPickerBtn")?.addEventListener("click", openInstrumentPicker);
    document.getElementById("closeInstrumentPickerBtn")?.addEventListener("click", closeInstrumentPicker);

    // Item modal
    document.getElementById("closeItemModalBtn")?.addEventListener("click", closeItemModal);
    document.getElementById("cancelItemModalBtn")?.addEventListener("click", closeItemModal);
    document.getElementById("itemModalForm")?.addEventListener("submit", saveItemFromModal);

    // Config/Additional pickers
    document.getElementById("closeConfigPickerBtn")?.addEventListener("click", () => {
      document.getElementById("configPickerOverlay").style.display = "none";
    });
    document.getElementById("closeAdditionalPickerBtn")?.addEventListener("click", () => {
      document.getElementById("additionalPickerOverlay").style.display = "none";
    });

    // Finalize quote
    document.getElementById("finalizeQuoteBtn")?.addEventListener("click", finalizeQuote);
  });
</script>
</body>
</html>
