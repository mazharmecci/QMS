<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QMS - Quotes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Aptos Display', system-ui, 'Inter', sans-serif;
      background:#f5f7fa;
      margin:0;
    }
    header {
      background:#0d6efd;
      color:#fff;
      padding:0.85rem 1rem;
      text-align:right;
      font-size:1rem;
      font-weight:600;
    }
    .container {
      max-width:1200px;
      margin:2rem auto;
      padding:2rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .quote-header {
      margin-bottom:1.5rem;
      border:1px solid #ccc;
      border-radius:8px;
      background:#fff;
      padding:2rem;
    }
    .quote-header-body {
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .quote-left { flex:1; min-width:300px; }
    .company-box {
      background:#d0d4d9;
      text-align:left;
      padding:0.2rem 1rem;
      border-radius:4px;
      margin-bottom:1rem;
    }
    .company-box p {
      font-size:10px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin:0;
    }
    .hospital-box p {
      margin:0;
      font-size:13px;
      line-height:1.3;
    }
    .hospital-box span { font-size:13px; }
    .attn-box {
      margin-top:7rem;
      background:#add8e6;
      padding:0.75rem 1rem;
      border-radius:8px;
      font-weight:800;
      color:#000;
      text-align:left;
      font-size:14px;
    }
    .quote-right { flex:1; min-width:300px; background:#fff; padding:1rem 1.25rem; border-radius:8px; }
    .quote-right-title {
      background:#d0d4d9;
      text-align:right;
      padding:0.2rem 1rem;
      border-radius:4px;
      margin-bottom:1rem;
      font-weight:800;
    }
    .quote-meta-grid {
      display:grid;
      grid-template-columns:auto 1fr auto 1fr;
      column-gap:0.75rem;
      row-gap:0.55rem;
    }
    .quote-meta-grid .label { font-size:9px; font-weight:500; color:#222; text-align:left; }
    .quote-meta-grid .value { font-size:16px; font-weight:700; color:#000; text-align:left; white-space:nowrap; }
    .quote-meta-grid .value-small { font-size:13px; font-weight:600; }
    .quote-meta-grid .label.right, .quote-meta-grid .value.right { text-align:right; }

    #quoteBuilder {
      margin-top:1.5rem;
      padding:1.5rem;
      background:#f9fafc;
      border:1px solid #ddd;
      border-radius:12px;
    }
    #quoteBuilder h3 { margin:0 0 0.75rem 0; }
    table.quote-table {
      width:100%;
      border-collapse:collapse;
      margin-bottom:1rem;
    }
    table.quote-table th, table.quote-table td {
      padding:0.6rem;
      border-bottom:1px solid #ddd;
      text-align:left;
      vertical-align:top;
    }
    table.quote-table th { background:#f0f4f8; }
    table.quote-table td:last-child, table.quote-table th:last-child { text-align:right; }
    table.quote-table td:nth-last-child(2), table.quote-table th:nth-last-child(2) { text-align:right; }

    .section-label {
      margin:1rem 0 0.25rem 0;
      font-weight:700;
      color:#0d6efd;
      font-size:0.95rem;
    }

    #quoteSummary {
      text-align:right;
      font-weight:600;
      margin-top:1rem;
    }
    #quoteSummary .line { margin:0.25rem 0; }
    #quoteSummary .grand { font-size:1.1rem; }

    #termsBlock {
      background:#fff;
      border:1px solid #ccc;
      border-radius:8px;
      padding:1rem;
      font-size:0.85rem;
      margin-top:1rem;
    }
    #termsBlock h4 {
      color:#0d6efd;
      margin:0 0 0.5rem 0;
    }
    #termsBlock ul { margin:0; padding-left:1rem; }
  </style>
</head>
<body>
<header>QMS - Quotes</header>

<div class="container">
  <!-- Header -->
  <div class="quote-header">
    <div class="quote-header-body">
      <div class="quote-left">
        <div class="company-box">
          <p><strong>ISTOS Medical Pvt Ltd.</strong> #51/5, 2nd Cross, J.C. Ind Area, Bikasipura Main Road, Yelachenahalli, Bangalore - 560062</p>
        </div>
        <div class="hospital-box">
          <p>
            <strong>To:</strong><br />
            <span id="toHospitalNameLine"></span><br />
            <span id="toHospitalAddressLine1"></span><br />
            <span id="toHospitalAddressLine2"></span>
          </p>
        </div>
        <div class="attn-box">
          KIND ATTN: <span id="toAttn"></span>
        </div>
      </div>

      <div class="quote-right">
        <div class="quote-right-title">SALES QUOTATION</div>
        <div class="quote-meta-grid">
          <div class="label">Quote No.</div>
          <div class="value" id="metaQuoteNo"></div>

          <div class="label right">Quotation Date</div>
          <div class="value value-small right" id="metaQuoteDate"></div>

          <div class="label">Your Reference</div>
          <div class="value value-small" id="metaYourRef"></div>

          <div class="label right">Ref Date</div>
          <div class="value value-small right" id="metaRefDate"></div>

          <div class="label">Your Contact Person</div>
          <div class="value value-small" id="metaContactPerson"></div>

          <div class="label right">Handphone</div>
          <div class="value value-small right" id="metaPhone"></div>

          <div class="label">Email</div>
          <div class="value value-small" id="metaEmail"></div>

          <div class="label right">Office</div>
          <div class="value value-small right" id="metaOffice"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quote builder -->
  <div id="quoteBuilder">
    <h3>Quote Builder</h3>

    <div class="section-label">Main instrument</div>
    <table class="quote-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Cat / Material No.</th>
          <th>Quantity</th>
          <th>Unit Price (INR)</th>
          <th>Total Price (INR)</th>
        </tr>
      </thead>
      <tbody id="quoteInstrumentBody"></tbody>
    </table>

    <div class="section-label">Configuration items</div>
    <table class="quote-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Cat / Material No.</th>
          <th>Quantity</th>
          <th>Unit Price (INR)</th>
          <th>Total Price (INR)</th>
        </tr>
      </thead>
      <tbody id="quoteConfigBody"></tbody>
    </table>

    <div class="section-label">Additional items</div>
    <table class="quote-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Cat / Material No.</th>
          <th>Quantity</th>
          <th>Unit Price (INR)</th>
          <th>Total Price (INR)</th>
        </tr>
      </thead>
      <tbody id="quoteAdditionalBody"></tbody>
    </table>

    <div id="quoteSummary">
      <div class="line">Subtotal: ₹ <span id="subtotal">0.00</span></div>
      <div class="line">GST @ <span id="gstRate">18</span>%: ₹ <span id="gst">0.00</span></div>
      <div class="line grand"><strong>Grand Total: ₹ <span id="grandTotal">0.00</span></strong></div>
    </div>
  </div>

  <!-- Terms -->
  <div id="termsBlock">
    <h4>Terms and conditions of sale</h4>
    <ul>
      <li><strong>Validity:</strong> Offer valid for 60 days from date of quotation.</li>
      <li><strong>Purchase order:</strong> Favouring ISTOS Medical Private Limited, # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area, Bikasipura Main Road, Yelachenahalli, Bangalore 560062.</li>
      <li><strong>Delivery:</strong> F.O.R basis; 6–8 weeks from receipt of valid purchase order; delayed delivery beyond control does not cancel other deliveries; title transfers after full payment.</li>
      <li><strong>Payment:</strong> 100% in advance via RTGS / NEFT / IMPS / Cheque / Draft. Bankers details on invoice / proforma.</li>
      <li><strong>Warranty:</strong> 12 months from installation against manufacturing defects. Consumables and easily damageable items excluded; unauthorized usage/mishandling voids warranty.</li>
      <li><strong>Government levies:</strong> GST extra @ 18%. Changes at invoicing will be accounted; any other levies to buyer’s account.</li>
      <li><strong>Packing & shipment:</strong> As per international standards at seller’s option unless otherwise mentioned.</li>
      <li><strong>Transit damages:</strong> To be claimed from insurance if applicable; otherwise in scope of ISTOS Medical Pvt. Ltd.</li>
      <li><strong>Installation & training:</strong> Free by ISTOS engineers / support specialists at your laboratory.</li>
      <li><strong>Documentation:</strong> Quality and performance documentation provided post successful installation.</li>
    </ul>
  </div>
</div>

<script>
  // ---------- Utilities ----------
  function formatISOToDMY(iso) {
    if (!iso) return '';
    const [y, m, d] = iso.split('-');
    return `${d}-${m}-${y}`;
  }
  function splitAddress(address) {
    if (!address) return ['', ''];
    const parts = address.split(',');
    if (parts.length < 2) return [address.trim(), ''];
    const line2 = parts.slice(-1)[0].trim();
    const line1 = parts.slice(0, -1).join(',').trim();
    return [line1, line2];
  }

  // ---------- Modular stacked cell formatter ----------
  function formatStackedQuoteCell({ code = '', name = '', description = '' }) {
    // Split long descriptions by sentence to form neat lines
    const descLines = (description || '').split(/(?<=\.)\s+/);
    const formattedDesc = descLines.join('\n');

    return `
      <td style="white-space:pre-line; vertical-align:top;">
        <div style="font-size:13px; font-weight:600;">${code}</div>
        <div style="font-size:12px; font-weight:500; color:#222;">${name}</div>
        <div style="font-size:11px; color:#555;">${formattedDesc}</div>
      </td>
    `;
  }

  // ---------- Price helpers ----------
  function parseINR(val) {
    // support plain numbers or strings with commas
    if (val === undefined || val === null || val === '') return 0;
    return parseFloat(String(val).replace(/,/g, '')) || 0;
  }
  function formatINR(num) {
    return Number(num).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // ---------- Header population ----------
  function populateHeader() {
    const header = JSON.parse(localStorage.getItem('quoteHeader') || '{}');

    document.getElementById('metaQuoteNo').textContent = header.quoteNo || '';
    document.getElementById('metaQuoteDate').textContent = formatISOToDMY(header.quoteDate);
    document.getElementById('metaYourRef').textContent = header.yourReference || '';
    document.getElementById('metaRefDate').textContent = formatISOToDMY(header.refDate);
    document.getElementById('metaContactPerson').textContent = header.contactPerson || '';
    document.getElementById('metaPhone').textContent = header.contactPhone || '';
    document.getElementById('metaEmail').textContent = header.contactEmail || '';
    document.getElementById('metaOffice').textContent = header.officePhone || '';

    document.getElementById('toHospitalNameLine').textContent = header.hospitalName || 'Hospital / Client Name';
    const fullAddress = header.hospitalAddress || '';
    const [line1, line2] = splitAddress(fullAddress);
    document.getElementById('toHospitalAddressLine1').textContent = line1 || '';
    document.getElementById('toHospitalAddressLine2').textContent = line2 || '';
    document.getElementById('toAttn').textContent = header.kindAttn || 'Attention';
  }

  // ---------- Unified renderer ----------
  function renderQuote() {
    const header = JSON.parse(localStorage.getItem('quoteHeader') || '{}');
    const configItems = JSON.parse(localStorage.getItem('configItemMaster') || '[]');
    const additionalItems = JSON.parse(localStorage.getItem('additionalItemMaster') || '[]');

    // Layer 1: Main Instrument (Item code always 001)
    const instrumentBody = document.getElementById('quoteInstrumentBody');
    instrumentBody.innerHTML = '';
    let subtotal = 0;

    if (header.selectedInstrument) {
      const inst = header.selectedInstrument;
      const unit = parseINR(inst.unitPrice);
      const qty = 1;
      const total = unit * qty;
      subtotal += total;

      const instrumentRow = `
        <tr>
          <td>001</td>
          ${formatStackedQuoteCell({
            code: inst.catalog || '',
            name: (inst.instrumentName || inst.description || '').replace(/<br>/g, ' '),
            description: (inst.longDescription || inst.details || inst.description || '').replace(/<br>/g, ' ')
          })}
          <td>01</td>
          <td>${formatINR(unit)}</td>
          <td>${formatINR(total)}</td>
        </tr>
      `;
      instrumentBody.innerHTML = instrumentRow;
    }

    // Layer 2: Configuration Items (start at 002)
    const configBody = document.getElementById('quoteConfigBody');
    configBody.innerHTML = '';
    const configRows = [];
    configItems.forEach((item, idx) => {
      const code = String(idx + 2).padStart(3, '0');
      const unit = 0;
      const qty = 1;
      const total = 0;

      configRows.push(`
        <tr>
          <td>${code}</td>
          ${formatStackedQuoteCell({
            code: item.itemCode || '',
            name: item.itemName || '',
            description: (item.catalogRef || '').replace(/<br>/g, ' ')
          })}
          <td>01</td>
          <td>${formatINR(unit)}</td>
          <td>${formatINR(total)}</td>
        </tr>
      `);
    });
    configBody.innerHTML = configRows.join('');

    // Layer 3: Additional Items (restart at 001)
    const additionalBody = document.getElementById('quoteAdditionalBody');
    additionalBody.innerHTML = '';
    const additionalRows = [];
    additionalItems.forEach((item, idx) => {
      const code = String(idx + 1).padStart(3, '0');
      const unit = parseINR(item.unitPrice || 0);
      const qty = parseINR(item.quantity || 1) || 1;
      const total = unit * qty;
      subtotal += total;

      additionalRows.push(`
        <tr>
          <td>${code}</td>
          ${formatStackedQuoteCell({
            code: item.itemCode || '',
            name: item.itemName || '',
            description: (item.catalogRef || '').replace(/<br>/g, ' ')
          })}
          <td>${String(qty).padStart(2, '0')}</td>
          <td>${formatINR(unit)}</td>
          <td>${formatINR(total)}</td>
        </tr>
      `);
    });
    additionalBody.innerHTML = additionalRows.join('');

    // Summary
    const gstRateEl = document.getElementById('gstRate');
    const gstRate = parseFloat(gstRateEl.textContent) || 18;
    const gst = subtotal * (gstRate / 100);
    const grand = subtotal + gst;

    document.getElementById('subtotal').textContent = formatINR(subtotal);
    document.getElementById('gst').textContent = formatINR(gst);
    document.getElementById('grandTotal').textContent = formatINR(grand);
  }

  // ---------- Init ----------
  populateHeader();
  renderQuote();
</script>
</body>
</html>
