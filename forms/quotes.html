<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Quotes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Aptos Display', system-ui, 'Inter', sans-serif;
    background:#f5f7fa;
    margin:0;
  }

  header {
    background:#0d6efd;
    color:#fff;
    padding:0.75rem 1.5rem;
  }

  .header-inner {
    max-width:1200px;
    margin:0 auto;
    display:flex;
    align-items:center;
    gap:12px;
  }

  .back-btn {
    border:none;
    background:rgba(255,255,255,0.12);
    color:#fff;
    padding:0.45rem 0.9rem;
    border-radius:999px;
    cursor:pointer;
  }

  .header-title {
    flex:1;
    text-align:center;
    font-weight:600;
    font-size:1.5rem;
  }

  .container {
    max-width:1200px;
    margin:2rem auto;
    padding:2rem;
    background:#fff;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }

  .quote-header {
    margin-bottom:1.5rem;
    border:1px solid #ccc;
    border-radius:8px;
    background:#fff;
    padding:2rem;
    position:relative;
  }

  .quote-header-body {
    display:flex;
    gap:1rem;
  }

  .quote-left,
  .quote-right {
    flex:1 1 0;
    min-width:0;
    display:flex;
    flex-direction:column;
  }

  .quote-logo-wrap {
    align-self:flex-end;
    margin-bottom:0.5rem;
  }

  .quote-logo-wrap img {
    max-height:70px;
    width:auto;
    display:block;
  }

  .company-box {
    flex:0 0 auto;
    background:#d0d4d9;
    border-radius:4px;
    padding:0.4rem 1rem;
    display:flex;
    align-items:center;
    margin-top:4.85rem;
  }

  .company-box p {
    margin:0;
    font-size:10px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .sales-box {
    flex:0 0 auto;
    background:#d0d4d9;
    border-radius:4px;
    padding:0.3rem 1rem;
    display:flex;
    align-items:center;
  }

  .sales-title {
    margin-left:auto;
    font-weight:900;
    font-size:18px;
    line-height:1;
    padding-top:0.1rem;
    letter-spacing:0.03em;
  }

  .hospital-box,
  .attn-box {
    margin-top:0.5rem;
  }

  .attn-box {
    background:#add8e6;
    padding:0.75rem 1rem;
    border-radius:8px;
    font-weight:800;
    color:#000;
    font-size:14px;
  }

  .quote-meta-grid {
    margin-top:0.5rem;
    background:#fff;
    border-radius:4px;
    padding:0.5rem 0.75rem;
    display:grid;
    grid-template-columns:auto 1fr auto 1fr;
    column-gap:0.75rem;
    row-gap:0.55rem;
  }

  .quote-meta-grid .label {
    font-size:9px;
    font-weight:500;
    color:#222;
    text-align:left;
  }

  .quote-meta-grid .value {
    font-size:16px;
    font-weight:700;
    color:#000;
    text-align:left;
    white-space:nowrap;
  }

  .quote-meta-grid .value-small {
    font-size:13px;
    font-weight:600;
  }

  .quote-meta-grid .label.right,
  .quote-meta-grid .value.right {
    text-align:right;
  }

  #salesNoteBlock {
    margin:0 0 1rem 0;
    font-size:13px;
    line-height:1.5;
    white-space:pre-line;
  }

  #quoteBuilder {
    margin-top:1.5rem;
    padding:1.5rem;
    background:#ffffff;
    border:1px solid #ddd;
    border-radius:12px;
  }

  #quoteBuilder h3 {
    margin-top:0;
    margin-bottom:0.75rem;
    color:#0d6efd;
  }

  table.quote-table {
    width:100%;
    border-collapse:collapse;
    margin-bottom:1rem;
  }

  table.quote-table th,
  table.quote-table td {
    padding:0.25rem 0.6rem;
    border-bottom:1px solid #ddd;
    text-align:left;
    vertical-align:top;
    font-size:13px;
  }

  table.quote-table th {
    background:#e0e0e0;
    color:#000;
    font-size:12px;
    text-transform:capitalize;
    letter-spacing:0.03em;
  }

  table.quote-table th:nth-child(4),
  table.quote-table th:nth-child(5),
  table.quote-table td:nth-child(4),
  table.quote-table td:nth-child(5) {
    text-align:right;
    white-space:nowrap;
  }

  table.quote-table td:nth-child(3),
  table.quote-table th:nth-child(3) {
    text-align:center;
    white-space:nowrap;
  }

  table.quote-table td:nth-child(1),
  table.quote-table td:nth-child(2) {
    vertical-align:top;
  }

  table.quote-table .cat-sub b,
  table.quote-table .cat-sub strong {
    font-weight:500;
  }

    .btn-finalize {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:0.3rem;
    background:linear-gradient(135deg, #0b3b91, #0d6efd);
    color:#ffffff;
    padding:0.7rem 1.8rem;
    font-size:0.95rem;
    font-weight:700;
    border:none;
    border-radius:999px;
    cursor:pointer;
    letter-spacing:0.04em;
    text-transform:uppercase;
    box-shadow:0 4px 14px rgba(0, 0, 0, 0.25);
    transition:
      background 0.15s ease,
      box-shadow 0.15s ease,
      transform 0.1s ease,
      filter 0.15s ease;
  }
  
  .btn-finalize:hover {
    background:linear-gradient(135deg, #0c46a8, #2a7bff);
    box-shadow:0 6px 18px rgba(0, 0, 0, 0.3);
    transform:translateY(-1px);
    filter:brightness(1.03);
  }
  
  .btn-finalize:active {
    transform:translateY(0);
    box-shadow:0 3px 10px rgba(0, 0, 0, 0.28);
    filter:brightness(0.98);
  }


  #termsBlock {
    margin-top:1.5rem;
    background:#fff;
    border:1px solid #ccc;
    border-radius:8px;
    padding:1rem 1.25rem;
    font-size:12px;
    line-height:1.4;
  }

  #termsBlock h2 {
    margin-top:0;
    color:#0d6efd;
    font-size:13px;
  }

  #termsTextBlock {
    margin-top:0.25rem;
  }

  #termsTextBlock p {
    margin:0.35rem 0;
  }

  .section-header-label {
    font-weight:700;
  }

  .print-footer tr,
  .print-footer td {
    border-top:none !important;
  }

  .print-frame {
    width:100%;
    border-collapse:collapse;
    border:none;
  }

  .print-header td,
  .print-body td,
  .print-footer td {
    padding:0;
    border:none;
  }

  .footer {
    font-size:10px;
    text-align:right;
    border-top:1px solid #ccc;
    padding-top:4px;
    margin-top:4px;
  }

  /* Premium light-blue buttons for actions */
  .quote-actions {
    margin-bottom:0.75rem;
  }

  .btn-quote {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:0.3rem;
    padding:0.55rem 1.2rem;
    border-radius:999px;
    border:1px solid #7fb6ff;
    background:linear-gradient(135deg, #e3f2ff, #cde5ff);
    color:#0b1727;
    font-size:0.85rem;
    font-weight:600;
    letter-spacing:0.02em;
    cursor:pointer;
    box-shadow:0 3px 8px rgba(15, 23, 42, 0.15);
    transition:
      background 0.15s ease,
      box-shadow 0.15s ease,
      transform 0.1s ease,
      border-color 0.15s ease;
  }

  .btn-quote:hover {
    background:linear-gradient(135deg, #f0f7ff, #d7e9ff);
    border-color:#5b9bff;
    box-shadow:0 5px 14px rgba(15, 23, 42, 0.2);
    transform:translateY(-1px);
  }

  .btn-quote:active {
    transform:translateY(0);
    box-shadow:0 2px 6px rgba(15, 23, 42, 0.18);
  }

  .btn-quote-secondary {
    background:linear-gradient(135deg, #eef4ff, #dde7ff);
  }

  /* Generic no-print helper for UI-only elements */
  .no-print {
    display:block;
  }

  @page {
    size:A4;
    margin:15mm 15mm 20mm 15mm;
  }

  @media print {
    body {
      margin:0;
      background:#ffffff;
      -webkit-print-color-adjust:exact;
      color-adjust:exact;
    }
    header { display:none !important; }
    .container {
      margin:0;
      padding:0;
      box-shadow:none;
      border-radius:0;
    }
    thead.print-header { display:table-header-group; }
    tfoot.print-footer { display:table-footer-group; }

    .no-print {
      display:none !important;
    }
  }
</style>

</head>
<body>
<header>
  <div class="header-inner">
    <button type="button" class="back-btn" onclick="goBack()">← Back</button>
    <div class="header-title">ISTOS Medical Private Limited</div>
  </div>
</header>

<!-- Modal -->
<div id="itemModalOverlay" style="display:none;
  position:fixed; inset:0; background:rgba(15,23,42,0.45);
  z-index:2000; align-items:center; justify-content:center;">
  <div id="itemModal" style="
    width:520px; max-width:95%; background:#fff; border-radius:10px;
    box-shadow:0 18px 45px rgba(15,23,42,0.35); padding:1.25rem 1.5rem;
    font-family:'Inter',sans-serif; font-size:13px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
      <h3 id="itemModalTitle" style="margin:0; font-size:15px; color:#0d6efd;"></h3>
      <button type="button" onclick="closeItemModal()"
              style="border:none; background:transparent; font-size:18px; cursor:pointer;">×</button>
    </div>

    <form id="itemModalForm" onsubmit="saveItemFromModal(event)">
      <input type="hidden" id="itemModalType" value="config">
      <input type="hidden" id="itemCode" value="">

      <!-- FIXED ROW -->
      <div style="
        display:flex;
        flex-wrap:wrap;
        gap:0.5rem;
        margin-bottom:0.5rem;
      ">
        <input id="itemCodeInput" type="text"
               placeholder="Item code (e.g., 030051 / TFB 1100)"
               style="
                 flex:1 1 160px;
                 min-width:0;
                 padding:0.4rem 0.55rem;
                 border:1px solid #cbd5e1;
                 border-radius:6px;
               ">
        <input id="itemQty" type="text"
               placeholder="Qty (or Included)"
               style="
                 flex:0 1 110px;
                 min-width:0;
                 padding:0.4rem 0.55rem;
                 border:1px solid #cbd5e1;
                 border-radius:6px;
               ">
        <input id="itemPrice" type="text"
               placeholder="Unit price (INR)"
               style="
                 flex:0 1 140px;
                 min-width:0;
                 padding:0.4rem 0.55rem;
                 border:1px solid #cbd5e1;
                 border-radius:6px;
               ">
      </div>

      <div style="margin-bottom:0.5rem;">
        <textarea id="itemDetails" rows="5"
                  placeholder="First line: main item name
Next lines: bullet lines starting with ' - '"
                  style="width:100%; padding:0.4rem 0.55rem; border:1px solid #cbd5e1; border-radius:6px; font-family:inherit; font-size:13px;"></textarea>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:0.5rem; margin-bottom:0.6rem;">
        <button type="button" onclick="closeItemModal()"
                style="border:1px solid #cbd5e1; background:#fff; padding:0.35rem 0.75rem;
                       border-radius:999px; font-size:12px; cursor:pointer;">Cancel</button>
        <button type="submit"
                style="border:none; background:#0d6efd; color:#fff; padding:0.35rem 0.9rem;
                       border-radius:999px; font-size:12px; cursor:pointer;">Save item</button>
      </div>
    </form>
  </div>
</div>

    <div id="itemModalList" style="max-height:180px; overflow:auto; border-top:1px solid #e2e8f0; padding-top:0.4rem;">
      <!-- existing items rendered here -->
    </div>
  </div>
</div>

<div class="container">
  <table class="print-frame">
    <thead class="print-header">
      <tr>
        <td>
          <div class="quote-header">
            <div class="quote-header-body">
              <div class="quote-left">
                <div class="company-box">
                  <p>
                    <strong>ISTOS Medical Pvt Ltd.</strong>
                    #51/5, 2nd Cross, J.C. Ind Area, Bikasipura Main Road,
                    Yelachenahalli, Bangalore - 560062
                  </p>
                </div>
                <div class="hospital-box">
                  <p>
                    <strong>To:</strong><br>
                    <span id="toHospitalNameLine"></span><br>
                    <span id="toHospitalAddressLine1"></span><br>
                    <span id="toHospitalAddressLine2"></span>
                  </p>
                </div>
                <div class="attn-box">
                  KIND ATTN: <span id="toAttn"></span>
                </div>
              </div>

              <div class="quote-right">
                <div class="quote-logo-wrap">
                  <img src="../images/istos-logo.jpg" alt="ISTOS Medical Logo">
                </div>
                <div class="sales-box">
                  <div class="sales-title">SALES QUOTATION</div>
                </div>
                <div class="quote-meta-grid">
                  <div class="label">Quote No.</div><div class="value" id="metaQuoteNo"></div>
                  <div class="label right">Quotation Date</div><div class="value value-small right" id="metaQuoteDate"></div>
                  <div class="label">Your Reference</div><div class="value value-small" id="metaYourRef"></div>
                  <div class="label right">Ref Date</div><div class="value value-small right" id="metaRefDate"></div>
                  <div class="label">Your Contact Person</div><div class="value value-small" id="metaContactPerson"></div>
                  <div class="label right">Handphone</div><div class="value value-small right" id="metaPhone"></div>
                  <div class="label">Email</div><div class="value value-small" id="metaEmail"></div>
                  <div class="label right">Office</div><div class="value value-small right" id="metaOffice"></div>
                </div>
              </div>

            </div>
          </div>
        </td>
      </tr>
    </thead>

    <tbody class="print-body">
      <tr>
        <td>
          <div id="salesNoteBlock"></div>

          <div id="quoteBuilder" class="no-print">
            <h3 class="no-print">Quote Builder</h3>
            <div class="quote-actions no-print">
              <button type="button" class="btn-quote" onclick="openConfigModal()">
                Add / Edit Configuration Items
              </button>
              <button type="button" class="btn-quote btn-quote-secondary" onclick="openAdditionalModal()">
                Add / Edit Additional Items
              </button>
            </div>
          </div>

            <table class="quote-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Cat / Material No.<br>Description</th>
                  <th>Quantity</th>
                  <th>Unit Price (INR)</th>
                  <th>Total Price (INR)</th>
                </tr>
              </thead>
              <tbody id="quoteBuilderBody"></tbody>
            </table>
          </div>

          <div id="termsBlock">
            <h2>Terms and Conditions of Sale</h2>
            <div id="termsTextBlock"></div>
          </div>
        </td>
      </tr>
    </tbody>

    <tfoot class="print-footer">
      <tr>
        <td>
          <div class="footer">
            ISTOS Medical Private Limited<br>
            # 51/5, Ground Floor, BSTN Heights, 2nd Cross, J.C. Industrial Area,
            Bikasipura Main Road, Yelachenahalli,<br>
            BANGALORE, Karnataka, INDIA 560 062<br>
            P: +91 80 2686 0607 | F: +91 80 2686 0668 |
            E: talktous@istos.in | www.istosmedical.com<br>
            CIN: U74999KA2016PTC096385 &nbsp; GST: 29AAECI2502G1ZV
          </div>
        </td>
      </tr>
    </tfoot>
  </table>

  <div style="margin-top:1.5rem; text-align:right;" class="no-print">
    <button type="button" class="btn-finalize" onclick="finalizeQuote()">
      ✅ Finalize &amp; Save to History
    </button>
  </div>
  </div>

<script>
  function goBack() {
    if (window.history.length > 1) window.history.back();
  }

  function formatISOToDMY(iso) {
    if (!iso) return '';
    const [y, m, d] = iso.split('-');
    return `${d}-${m}-${y}`;
  }

  function splitAddress(address) {
    if (!address) return ['', ''];
    const parts = address.split(',');
    if (parts.length < 2) return [address.trim(), ''];
    const line2 = parts.slice(-1)[0].trim();
    const line1 = parts.slice(0, -1).join(',').trim();
    return [line1, line2];
  }

  function moneyINR(value) {
    const num = Number(value || 0);
    return num.toLocaleString('en-IN', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function parseLines(raw) {
    if (!raw) return [];
    return String(raw)
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);
  }

  function parseDetailsText(raw) {
    const lines = String(raw || '')
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);
    const name = lines[0] || '';
    const rest = lines.slice(1);
    return { name, rest };
  }

  function getQuoteHeaderRaw() {
    return JSON.parse(localStorage.getItem('quoteHeader') || '{}');
  }

  function getInstrumentsMaster() {
    return JSON.parse(localStorage.getItem('instruments') || '[]');
  }

  function resolveInstrumentForHeader(header) {
    const all = getInstrumentsMaster();

    if (header.selectedInstrumentIndex != null && header.selectedInstrumentIndex !== '') {
      const idx = Number(header.selectedInstrumentIndex);
      if (!isNaN(idx) && all[idx]) return all[idx];
    }

    if (header.instrumentCode) {
      const instByCode = all.find(
        i => (i.instrumentCode || i.catalog || '') === header.instrumentCode
      );
      if (instByCode) return instByCode;
    }

    return null;
  }

  function getPrimaryLine(header) {
    if (header.quoteLines && header.quoteLines.length) {
      return header.quoteLines[0];
    }
    const line = {
      lineType: 'instrument',
      instrumentIndex:
        header.selectedInstrumentIndex !== '' && header.selectedInstrumentIndex != null
          ? Number(header.selectedInstrumentIndex)
          : null,
      quantity: 1,
      configItems: header.configItems || [],
      additionalItems: header.additionalItems || []
    };
    header.quoteLines = [line];
    localStorage.setItem('quoteHeader', JSON.stringify(header));
    return line;
  }

  function validateHeader(header) {
    const errors = [];
    if (!header.quoteNo)         errors.push('Quote No is missing');
    if (!header.quoteDate)       errors.push('Quote Date is missing');
    if (!header.refDate)         errors.push('Reference Date is missing');
    if (!header.hospitalName)    errors.push('Hospital Name is missing');
    if (!header.hospitalAddress) errors.push('Hospital Address is missing');

    if (errors.length) {
      alert('Validation errors:\n' + errors.join('\n'));
      return false;
    }
    return true;
  }

  function getQuoteContext() {
    const header = getQuoteHeaderRaw();
    const inst   = resolveInstrumentForHeader(header);
    const line   = getPrimaryLine(header);
    return { header, inst, line };
  }

  function populateHeader() {
    const { header } = getQuoteContext();
    if (!validateHeader(header)) return;

    document.getElementById('metaQuoteNo').textContent   = header.quoteNo || '';
    document.getElementById('metaQuoteDate').textContent = formatISOToDMY(header.quoteDate);
    document.getElementById('metaYourRef').textContent   = header.yourReference || '';
    document.getElementById('metaRefDate').textContent   = formatISOToDMY(header.refDate);
    document.getElementById('metaContactPerson').textContent = header.contactPerson || '';
    document.getElementById('metaPhone').textContent     = header.contactPhone || '';
    document.getElementById('metaEmail').textContent     = header.contactEmail || '';
    document.getElementById('metaOffice').textContent    = header.officePhone || '';

    document.getElementById('toHospitalNameLine').textContent =
      header.hospitalName || 'Hospital / Client Name';

    const [line1, line2] = splitAddress(header.hospitalAddress || '');
    document.getElementById('toHospitalAddressLine1').textContent = line1 || '';
    document.getElementById('toHospitalAddressLine2').textContent = line2 || '';
    document.getElementById('toAttn').textContent = header.kindAttn || 'Attention';

    const noteEl = document.getElementById('salesNoteBlock');
    if (noteEl && header.salesNote) {
      noteEl.textContent = header.salesNote;
    }

    const termsEl = document.getElementById('termsTextBlock');
    if (termsEl) {
      if (header.termsHtml) {
        termsEl.innerHTML = header.termsHtml;
      } else if (header.termsText) {
        termsEl.textContent = header.termsText;
      } else {
        termsEl.textContent = '';
      }
    }
  }

  function formatInstrumentCell(inst) {
    const code = inst.catalog || inst.code || '';
    const name = inst.instrumentName || inst.name || '';
    const descLines = parseLines(inst.longDescription || inst.description || '');

    const boldLines = [];
    if (code) boldLines.push(code);
    if (name) boldLines.push(name);
    if (descLines[0]) boldLines.push(descLines[0]);

    const restDesc = descLines.slice(1);
    const supplied = inst.suppliedWith || inst.supplied || [];

    const specs = [];
    if (inst.dimensions) specs.push(`Dimensions: ${inst.dimensions}`);
    if (inst.weight)     specs.push(`Weight: ${inst.weight}`);
    if (inst.power)      specs.push(`Power: ${inst.power}`);

    const meta = [];
    if (inst.origin || inst.country) meta.push(`Country of Origin: ${inst.origin || inst.country}`);
    if (inst.hsn)                    meta.push(`HSN Code: ${inst.hsn}`);

    let html = `<td style="white-space:pre-line; vertical-align:top; line-height:1.3;">`;

    boldLines.forEach(line => {
      html += `<div class="cat-main">${line}</div>`;
    });

    if (restDesc.length) {
      html += `<div style="height:8px;"></div>`;
      html += `<div class="cat-sub">${restDesc.join(' ')}</div>`;
    }

    if (supplied.length) {
      html += `<div style="height:8px;"></div>`;
      html += `<div class="cat-sub"><strong>Supplied Complete with:</strong><br>`;
      html += supplied.map(s => ` - ${s}`).join('<br>');
      html += `</div>`;
    }

    if (specs.length) {
      html += `<div style="height:8px;"></div>`;
      html += `<div class="cat-sub">${specs.join('<br>')}</div>`;
    }

    if (meta.length) {
      html += `<div style="height:8px;"></div>`;
      html += `<div class="cat-sub">${meta.join('<br>')}</div>`;
    }

    html += `</td>`;
    return html;
  }

  function formatItemCell(item) {
    const code = item.code || item.catalog || '';
    const descSource = item.description || item.longDescription || item.description || '';
    const lines = parseLines(descSource);
    const name = item.name || lines[0] || '';
    const rest = lines.slice(1);

    let html = `<td style="white-space:pre-line; vertical-align:top; line-height:1.3;">`;

    if (code) html += `<div class="cat-main">${code}</div>`;
    if (name) html += `<div class="cat-main">${name}</div>`;

    if (rest.length) {
      html += `<div style="height:8px;"></div>`;
      html += rest.map(line => `<div class="cat-sub">${line}</div>`).join('');
    }

    html += `</td>`;
    return html;
  }

  function renderQuoteBuilder() {
    const { inst, line } = getQuoteContext();
    const body = document.getElementById('quoteBuilderBody');

    if (!inst) {
      body.innerHTML = '';
      return;
    }

    const rows = [];

    const qty = line.quantity || 1;
    rows.push(`
      <tr>
        <td>001</td>
        ${formatInstrumentCell(inst)}
        <td>${qty}</td>
        <td>${moneyINR(inst.unitPrice)}</td>
        <td>${moneyINR((inst.unitPrice || 0) * qty)}</td>
      </tr>
    `);

    const configItems = line.configItems || [];
    if (configItems.length) {
      rows.push(`
        <tr style="background:#00B0F0; color:#000;">
          <td colspan="5" style="font-weight:700;">
            <span class="section-header-label">CONFIGURATION ITEMS</span>
          </td>
        </tr>
      `);

      configItems.forEach((item, idx) => {
        const itemCode = String(idx + 2).padStart(3, '0');
        const q = item.qty != null ? item.qty : 'Included';
        const upRaw = item.upInr != null ? item.upInr : 'Included';
        const tpRaw = item.tpInr != null ? item.tpInr : 'Included';
        const upCell = typeof upRaw === 'number' ? moneyINR(upRaw) : upRaw;
        const tpCell = typeof tpRaw === 'number' ? moneyINR(tpRaw) : tpRaw;

        rows.push(`
          <tr>
            <td>${itemCode}</td>
            ${formatItemCell(item)}
            <td>${q}</td>
            <td>${upCell}</td>
            <td>${tpCell}</td>
          </tr>
        `);
      });
    }

    const additionalItems = line.additionalItems || [];
    if (additionalItems.length) {
      rows.push(`
        <tr style="background:#00B0F0; color:#000;">
          <td colspan="5" style="font-weight:700;">
            <span class="section-header-label">ADDITIONAL ITEMS</span>
          </td>
        </tr>
      `);

      additionalItems.forEach((item, idx) => {
        const itemCode = String(idx + 1).padStart(3, '0');
        const qtyNum = Number(item.qty || 1);

        let unitNum = 0;
        if (item.price) {
          const cleaned = String(item.price).replace(/[^\d,]/g, '').replace(/,/g, '');
          unitNum = parseFloat(cleaned) || 0;
        } else {
          unitNum = Number(item.unitPrice || item.upInr || item.tpInr || 0);
        }
        const totalNum = unitNum * qtyNum;

        rows.push(`
          <tr>
            <td>${itemCode}</td>
            ${formatItemCell(item)}
            <td>${qtyNum.toString().padStart(2, '0')}</td>
            <td>${moneyINR(unitNum)}</td>
            <td>${moneyINR(totalNum)}</td>
          </tr>
        `);
      });
    }

    body.innerHTML = rows.join('');
  }

  function buildLineItemsFromCurrentQuote() {
    const { inst, line } = getQuoteContext();
    const items = [];

    if (inst) {
      items.push({
        name: inst.instrumentName || inst.name || '',
        code: inst.catalog || inst.code || '',
        type: 'Instrument',
        price: Number(inst.unitPrice || 0)
      });
    }

    (line.configItems || []).forEach(item => {
      const price = item.tpInr != null
        ? Number(item.tpInr)
        : Number(item.upInr || 0);

      items.push({
        name: item.name || item.itemName || '',
        code: item.code || item.catalog || '',
        type: 'Configuration',
        price
      });
    });

    (line.additionalItems || []).forEach(item => {
      let unitNum = 0;
      if (item.price) {
        const cleaned = String(item.price).replace(/[^\d,]/g, '').replace(/,/g, '');
        unitNum = parseFloat(cleaned) || 0;
      } else {
        unitNum = Number(item.unitPrice || item.upInr || item.tpInr || 0);
      }

      items.push({
        name: item.name || item.itemName || '',
        code: item.code || item.catalog || '',
        type: 'Additional',
        price: unitNum
      });
    });

    return items;
  }

  function buildSummaryFromHeader(header) {
    const itemsTotal = Number(header.itemsTotal || header.itemsValueTotal || 0);
    const discount   = Number(header.discount || 0);
    const afterDisc  = Number(header.afterDiscount || (itemsTotal - discount));
    const freight    = header.freight || 'As applicable';
    const gstPercent = Number(header.gstPercent || 0);
    const gstAmount  = Number(header.gstAmount || (afterDisc * gstPercent) / 100);
    const totalValue = Number(header.totalValue || (afterDisc + gstAmount));
    const roundOff   = Number(header.roundOff || 0);

    return {
      itemsTotal,
      discount,
      afterDiscount: afterDisc,
      freight,
      gstPercent,
      gstAmount,
      totalValue,
      roundOff
    };
  }

  function finalizeQuote() {
    const header = getQuoteHeaderRaw();

    if (!header.quoteNo || !header.quoteDate || !header.hospitalName) {
      alert('Missing key details (Quote No / Date / Hospital). Please complete the header first.');
      return;
    }

    const lineItems = buildLineItemsFromCurrentQuote();
    const summary   = buildSummaryFromHeader(header);
    const existing  = JSON.parse(localStorage.getItem('quotes') || '[]');

    const sameQuote = existing.filter(q => q.header && q.header.quoteNo === header.quoteNo);
    const lastRev   = sameQuote.length
      ? Math.max(...sameQuote.map(q => Number(q.revision || 1)))
      : 0;
    const nextRev   = lastRev + 1;

    const now = new Date();
    const quote = {
      header,
      lineItems,
      summary,
      quoteNo: header.quoteNo,
      revision: nextRev,
      status: 'submitted',
      history: [{
        status: 'submitted',
        date: now.toISOString().slice(0, 10),
        time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      }]
    };

    existing.push(quote);
    localStorage.setItem('quotes', JSON.stringify(existing));
    alert(`Quote saved to history as ${header.quoteNo} (Rev ${nextRev}).`);
  }

  function openConfigModal() {
    openItemModal('config');
  }

  function openAdditionalModal() {
    openItemModal('additional');
  }

  function openItemModal(type) {
    const { line } = getQuoteContext();
    const overlay = document.getElementById('itemModalOverlay');
    const titleEl = document.getElementById('itemModalTitle');
    const typeEl  = document.getElementById('itemModalType');

    const codeEl    = document.getElementById('itemCodeInput');
    const qtyEl     = document.getElementById('itemQty');
    const priceEl   = document.getElementById('itemPrice');
    const detailsEl = document.getElementById('itemDetails');

    currentEditIndex = null;

    typeEl.value = type;
    titleEl.textContent = type === 'config'
      ? 'Configuration Items for this Quote'
      : 'Additional Items for this Quote';

    codeEl.value    = '';
    qtyEl.value     = type === 'config' ? 'Included' : '1';
    // hide / ignore price for config
    if (type === 'config') {
      if (priceEl) priceEl.value = '';
    } else {
      if (priceEl) priceEl.value = '';
    }
    detailsEl.value = '';

    renderItemModalList(line, type);
    overlay.style.display = 'flex';
  }

  function closeItemModal() {
    const overlay = document.getElementById('itemModalOverlay');
    if (overlay) overlay.style.display = 'none';
  }

  function renderItemModalList(line, type) {
    const listEl = document.getElementById('itemModalList');
    const arr = type === 'config' ? (line.configItems || []) : (line.additionalItems || []);

    if (!arr.length) {
      listEl.innerHTML = '<div style="font-size:12px; color:#64748b;">No items yet for this quote.</div>';
      return;
    }

    listEl.innerHTML = arr.map((item, idx) => {
      const qty = item.qty != null ? item.qty : (type === 'config' ? 'Included' : '1');
      const price = type === 'config'
        ? 'Included'
        : (item.price || item.unitPrice || item.upInr || item.tpInr || '');
      return `
        <div style="display:flex; align-items:center; justify-content:space-between;
                    padding:0.25rem 0; border-bottom:1px dashed #e2e8f0;">
          <div style="flex:1; font-size:12px;">
            <div style="font-weight:600;">${item.code || ''} ${item.name || ''}</div>
            <div style="color:#64748b;">Qty: ${qty} &nbsp; | &nbsp; Price: ${price}</div>
          </div>
          <div style="display:flex; gap:0.25rem;">
            <button type="button" onclick="editItemFromModal('${type}', ${idx})"
                    style="border:none; background:#e0f2fe; color:#0369a1;
                           font-size:11px; padding:0.15rem 0.45rem; border-radius:999px; cursor:pointer;">
              Edit
            </button>
            <button type="button" onclick="removeItemFromModal('${type}', ${idx})"
                    style="border:none; background:#fee2e2; color:#b91c1c;
                           font-size:11px; padding:0.15rem 0.45rem; border-radius:999px; cursor:pointer;">
              Remove
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  let currentEditIndex = null;

  function editItemFromModal(type, idx) {
    const { line } = getQuoteContext();
    const arr = type === 'config' ? (line.configItems || []) : (line.additionalItems || []);
    const item = arr[idx];
    if (!item) return;

    currentEditIndex = idx;

    document.getElementById('itemModalType').value = type;
    document.getElementById('itemModalTitle').textContent =
      type === 'config' ? 'Edit Configuration Item' : 'Edit Additional Item';

    const codeEl    = document.getElementById('itemCodeInput');
    const qtyEl     = document.getElementById('itemQty');
    const priceEl   = document.getElementById('itemPrice');
    const detailsEl = document.getElementById('itemDetails');

    codeEl.value = item.code || '';
    qtyEl.value  =
      item.qty != null ? item.qty : (type === 'config' ? 'Included' : '1');

    if (type === 'config') {
      if (priceEl) priceEl.value = '';
    } else {
      if (item.price && priceEl) {
        const cleaned = String(item.price).replace(/[^\d.]/g, '');
        priceEl.value = cleaned;
      } else if (priceEl) {
        priceEl.value = '';
      }
    }

    detailsEl.value = item.description || '';

    const overlay = document.getElementById('itemModalOverlay');
    overlay.style.display = 'flex';
  }

  function removeItemFromModal(type, idx) {
    const { header, line } = getQuoteContext();
    const arrName = type === 'config' ? 'configItems' : 'additionalItems';
    const arr = line[arrName] || [];
    arr.splice(idx, 1);
    line[arrName] = arr;
    header.quoteLines[0] = line;
    localStorage.setItem('quoteHeader', JSON.stringify(header));
    renderQuoteBuilder();
    renderItemModalList(line, type);
  }

  function saveItemFromModal(e) {
    e.preventDefault();
    const { header, line } = getQuoteContext();

    const typeEl    = document.getElementById('itemModalType');
    const codeEl    = document.getElementById('itemCodeInput');
    const qtyEl     = document.getElementById('itemQty');
    const priceEl   = document.getElementById('itemPrice');
    const detailsEl = document.getElementById('itemDetails');

    const type = typeEl.value;
    const code = (codeEl.value || '').trim();
    const { name } = parseDetailsText(detailsEl.value);
    if (!name) return;

    const arrName = type === 'config' ? 'configItems' : 'additionalItems';
    if (!Array.isArray(line[arrName])) line[arrName] = [];

    const isEdit = currentEditIndex != null;
    const idx = isEdit ? currentEditIndex : line[arrName].length;

    if (type === 'config') {
      const existingCode = isEdit && line.configItems[idx] ? line.configItems[idx].code : null;
      const item = {
        code: code || existingCode || 'CFG-' + String(line.configItems.length + 1).padStart(2, '0'),
        name,
        description: detailsEl.value,
        qty: qtyEl.value || 'Included',
        upInr: 'Included',
        tpInr: 'Included'
      };
      line.configItems[idx] = item;
    } else {
      const existingCode = isEdit && line.additionalItems[idx] ? line.additionalItems[idx].code : null;
      const raw = priceEl.value || '0';
      const num = Number(raw.replace(/[^\d.]/g, '') || 0);
      const formattedPrice = '₹ ' + num.toLocaleString('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      const item = {
        code: code || existingCode || 'ADD-' + String(line.additionalItems.length + 1).padStart(2, '0'),
        name,
        description: detailsEl.value,
        qty: Number(qtyEl.value || 1),
        price: formattedPrice
      };
      line.additionalItems[idx] = item;
    }

    currentEditIndex = null;
    header.quoteLines[0] = line;
    localStorage.setItem('quoteHeader', JSON.stringify(header));
    renderQuoteBuilder();
    renderItemModalList(line, type);
  }

  populateHeader();
  renderQuoteBuilder();
</script>

</body>
</html>
