<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Quotes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Aptos Display', system-ui, 'Inter', sans-serif;
      background:#f5f7fa;
      margin:0;
    }
    header {
      background:#0d6efd;
      color:#fff;
      padding:0.85rem 1rem;
      text-align:right;
      font-size:1rem;
      font-weight:600;
    }
    .container {
      max-width:1200px;
      margin:2rem auto;
      padding:2rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }

    .quote-header {
      margin-bottom:1.5rem;
      border:1px solid #ccc;
      border-radius:8px;
      background:#fff;
      padding:2rem;
    }
    .quote-header-body {
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .quote-left { flex:1; min-width:300px; }
    .quote-right { flex:1; min-width:300px; background:#fff; padding:1rem 1.25rem; border-radius:8px; }

    .company-box {
      background:#d0d4d9;
      text-align:left;
      padding:0.2rem 1rem;
      border-radius:4px;
      margin-bottom:1rem;
    }
    .company-box p {
      font-size:10px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin:0;
    }
    .hospital-box p { margin:0; font-size:13px; line-height:1.3; }
    .hospital-box span { font-size:13px; }

    .attn-box {
      margin-top:1rem;
      background:#add8e6;
      padding:0.75rem 1rem;
      border-radius:8px;
      font-weight:800;
      color:#000;
      text-align:left;
      font-size:14px;
    }

    .quote-right-title {
      background:#d0d4d9;
      text-align:right;
      padding:0.2rem 1rem;
      border-radius:4px;
      margin-bottom:1rem;
      font-weight:800;
    }

    .quote-meta-grid {
      display:grid;
      grid-template-columns:auto 1fr auto 1fr;
      column-gap:0.75rem;
      row-gap:0.55rem;
    }
    .quote-meta-grid .label {
      font-size:9px;
      font-weight:500;
      color:#222;
      text-align:left;
    }
    .quote-meta-grid .value {
      font-size:16px;
      font-weight:700;
      color:#000;
      text-align:left;
      white-space:nowrap;
    }
    .quote-meta-grid .value-small { font-size:13px; font-weight:600; }
    .quote-meta-grid .label.right,
    .quote-meta-grid .value.right { text-align:right; }


    #quoteBuilder {
      margin-top:1.5rem;
      padding:1.5rem;
      background:#f9fafc;
      border:1px solid #ddd;
      border-radius:12px;
    }
    #quoteBuilder h3 {
      margin-top:0;
      margin-bottom:0.75rem;
      color:#0d6efd;
    }

    table.quote-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    table.quote-table th,
    table.quote-table td {
      padding: 0.25rem 0.6rem;
      border-bottom: 1px solid #ddd;
      text-align: left;
      vertical-align: top;
      font-size: 13px;
    }
    table.quote-table th {
      background: #f0f4f8;
      font-size: 12px;
      text-transform: capitalize;
      letter-spacing: 0.03em;
    }

    table.quote-table th:nth-child(4),
    table.quote-table th:nth-child(5),
    table.quote-table td:nth-child(4),
    table.quote-table td:nth-child(5) {
      text-align: right;
      white-space: nowrap;
    }

    table.quote-table td:nth-child(3),
    table.quote-table th:nth-child(3) {
      text-align: center;
      white-space: nowrap;
    }

    table.quote-table td:nth-child(1),
    table.quote-table td:nth-child(2) {
      vertical-align: top;
    }

    table.quote-table .cat-sub b,
    table.quote-table .cat-sub strong {
      font-weight:500;
    }

    #termsBlock {
      margin-top:1.5rem;
      background:#fff;
      border:1px solid #ccc;
      border-radius:8px;
      padding:1rem 1.25rem;
      font-size:12px;
      line-height:1.4;
    }
    #termsBlock h4 {
      margin-top:0;
      color:#0d6efd;
      font-size:13px;
    }
    #termsBlock ul {
      padding-left:1.1rem;
      margin:0.25rem 0 0;
    }
    #termsBlock li { margin-bottom:0.15rem; }
  </style>
</head>
<body>
<header>QMS - Quotes</header>
<div class="container">
  <div class="quote-header">
    <div class="quote-header-body">
      <div class="quote-left">
        <div class="company-box">
          <p><strong>ISTOS Medical Pvt Ltd.</strong> #51/5, 2nd Cross, J.C. Ind Area, Bikasipura Main Road, Yelachenahalli, Bangalore - 560062</p>
        </div>
        <div class="hospital-box">
          <p>
            <strong>To:</strong><br>
            <span id="toHospitalNameLine"></span><br>
            <span id="toHospitalAddressLine1"></span><br>
            <span id="toHospitalAddressLine2"></span>
          </p>
        </div>
        <div class="attn-box">KIND ATTN: <span id="toAttn"></span></div>
      </div>
      <div class="quote-right">
        <div class="quote-right-title">SALES QUOTATION</div>
        <div class="quote-meta-grid">
          <div class="label">Quote No.</div><div class="value" id="metaQuoteNo"></div>
          <div class="label right">Quotation Date</div><div class="value value-small right" id="metaQuoteDate"></div>
          <div class="label">Your Reference</div><div class="value value-small" id="metaYourRef"></div>
          <div class="label right">Ref Date</div><div class="value value-small right" id="metaRefDate"></div>
          <div class="label">Your Contact Person</div><div class="value value-small" id="metaContactPerson"></div>
          <div class="label right">Handphone</div><div class="value value-small right" id="metaPhone"></div>
          <div class="label">Email</div><div class="value value-small" id="metaEmail"></div>
          <div class="label right">Office</div><div class="value value-small right" id="metaOffice"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="quoteBuilder">
    <h3>Quote Builder</h3>
    <table class="quote-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Cat / Material No.<br>Description</th>
          <th>Quantity</th>
          <th>Unit Price (INR)</th>
          <th>Total Price (INR)</th>
        </tr>
      </thead>
      <tbody id="quoteBuilderBody"></tbody>
    </table>
  </div>

  <div id="termsBlock">
    <h4>Terms and Conditions of Sale</h4>
    <ul>
      <li><strong>Validity:</strong> Offer valid for 60 days from date of quotation.</li>
      <li><strong>Delivery:</strong> 6â€“8 weeks from receipt of valid purchase order.</li>
      <li><strong>Payment:</strong> 100% advance via RTGS/NEFT/IMPS/Cheque/Draft.</li>
      <li><strong>Warranty:</strong> 12 months from installation against manufacturing defects.</li>
      <li><strong>GST:</strong> Extra @ 18% on all offered products.</li>
      <li><strong>Installation & Training:</strong> Free by ISTOS engineers at client site.</li>
      <li><strong>Documentation:</strong> Provided post successful installation.</li>
    </ul>
  </div>
</div>

<script>
/* ========= Helpers ========= */
function formatISOToDMY(iso){
  if(!iso) return '';
  const [y,m,d] = iso.split('-');
  return `${d}-${m}-${y}`;
}
function splitAddress(address){
  if(!address) return ['',''];
  const parts = address.split(',');
  if(parts.length < 2) return [address.trim(), ''];
  const line2 = parts.slice(-1)[0].trim();
  const line1 = parts.slice(0, -1).join(',').trim();
  return [line1, line2];
}
function moneyINR(value){
  const num = Number(value || 0);
  return num.toLocaleString('en-IN',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  });
}

/* ========= Header ========= */
function validateHeader(header) {
  const errors = [];
  if (!header.quoteNo) errors.push("Quote No is missing");
  if (!header.quoteDate) errors.push("Quote Date is missing");
  if (!header.refDate) errors.push("Reference Date is missing");
  if (!header.hospitalName) errors.push("Hospital Name is missing");
  if (!header.hospitalAddress) errors.push("Hospital Address is missing");
  if (!header.contactPhone) errors.push("Contact Phone is missing");
  if (!header.contactEmail) errors.push("Contact Email is missing");
  if (errors.length) {
    alert("Validation errors:\n" + errors.join("\n"));
    return false;
  }
  return true;
}
function populateHeader() {
  const header = JSON.parse(localStorage.getItem('quoteHeader') || '{}');
  if (!validateHeader(header)) return;

  document.getElementById('metaQuoteNo').textContent   = header.quoteNo || '';
  document.getElementById('metaQuoteDate').textContent = formatISOToDMY(header.quoteDate);
  document.getElementById('metaYourRef').textContent   = header.yourReference || '';
  document.getElementById('metaRefDate').textContent   = formatISOToDMY(header.refDate);
  document.getElementById('metaContactPerson').textContent = header.contactPerson || '';
  document.getElementById('metaPhone').textContent     = header.contactPhone || '';
  document.getElementById('metaEmail').textContent     = header.contactEmail || '';
  document.getElementById('metaOffice').textContent    = header.officePhone || '';

  document.getElementById('toHospitalNameLine').textContent =
    header.hospitalName || 'Hospital / Client Name';

  const [line1, line2] = splitAddress(header.hospitalAddress || '');
  document.getElementById('toHospitalAddressLine1').textContent = line1 || '';
  document.getElementById('toHospitalAddressLine2').textContent = line2 || '';
  document.getElementById('toAttn').textContent = header.kindAttn || 'Attention';
}

/* ========= Shared description parser ========= */
// Always read multiline strings as given in localStorage, preserve all lines.
function parseLines(raw) {
  if (!raw) return [];
  return String(raw)
    .split('\n')
    .map(l => l.trim())
    .filter(Boolean);
}

function formatStackedQuoteCell({
  code = '',
  name = '',
  description = '',
  supplied = [],
  dimensions = '',
  weight = '',
  power = '',
  country = '',
  hsn = ''
}) {
  const descLines = (description || '').split('\n').map(l => l.trim()).filter(Boolean);

  let block = `
    <td style="white-space:pre-line; vertical-align:top; line-height:1.3;">
      <div class="cat-main">${code}</div>
      <div class="cat-main">${name}</div>
  `;

  if (descLines.length) {
    descLines.forEach(line => {
      block += `<div class="cat-main">${line}</div>`;
    });
    block += `<div style="height:8px;"></div>`;
  }

  if (supplied.length) {
    block += `<div class="cat-sub" style="font-weight:600;">Supplied Complete with:</div>`;
    block += supplied.map(line => `<div class="cat-sub" style="padding-left:15px;">- ${line}</div>`).join('');
    block += `<div style="height:8px;"></div>`;
  }

  const specLines = [];
  if (dimensions) specLines.push(`Dimensions: ${dimensions}`);
  if (weight)     specLines.push(`Weight: ${weight}`);
  if (power)      specLines.push(`Power: ${power}`);
  if (specLines.length) {
    block += `<div class="cat-sub" style="padding-left:15px;">${specLines.join('<br>')}</div>`;
    block += `<div style="height:8px;"></div>`;
  }

  const metaLines = [];
  if (country) metaLines.push(`Country of Origin: ${country}`);
  if (hsn)     metaLines.push(`HSN Code: ${hsn}`);
  if (metaLines.length) {
    block += `<div class="cat-sub" style="padding-left:15px;">${metaLines.join('<br>')}</div>`;
  }

  block += `</td>`;
  return block;
}


/* ========= Formatters for each section ========= */
// Main instrument = code (bold) + 2 bold lines + blocks with gaps
function formatInstrumentCell(inst) {
  const code = inst.catalog || inst.code || '';
  const name = inst.instrumentName || inst.name || '';
  const descLines = parseLines(inst.longDescription || inst.description || '');

  const boldLines = [];
  if (code) boldLines.push(code);
  if (name) boldLines.push(name);
  if (descLines[0]) boldLines.push(descLines[0]); // first description line bold per your spec

  const restDesc = descLines.slice(1);

  const supplied = inst.supplied || [];
  const specs = [];
  if (inst.dimensions) specs.push(`Dimensions: ${inst.dimensions}`);
  if (inst.weight)     specs.push(`Weight: ${inst.weight}`);
  if (inst.power)      specs.push(`Power: ${inst.power}`);

  const meta = [];
  if (inst.origin || inst.country) meta.push(`Country of Origin: ${inst.origin || inst.country}`);
  if (inst.hsn)                    meta.push(`HSN Code: ${inst.hsn}`);

  let html = `<td style="white-space:pre-line; vertical-align:top; line-height:1.3;">`;

  boldLines.forEach(line => {
    html += `<div class="cat-main">${line}</div>`;
  });

  if (restDesc.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">` + restDesc.join(' ') + `</div>`;
  }

  if (supplied.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">Supplied Complete with:<br>`;
    html += supplied.map(s => ` - ${s}`).join('<br>');
    html += `</div>`;
  }

  if (specs.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">${specs.join('<br>')}</div>`;
  }

  if (meta.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">${meta.join('<br>')}</div>`;
  }

  html += `</td>`;
  return html;
}

// Config / Additional items = 2 bold lines + bullet features + specs + meta
function formatItemCell(item) {
  const code = item.code || item.catalog || '';
  const name = item.name || item.itemName || item.instrumentName || '';
  const descLines = parseLines(item.longDescription || item.description || '');

  const bold1 = code;
  const bold2 = name || descLines[0] || '';
  const featureLines = name ? descLines : descLines.slice(1);

  const specs = [];
  if (item.dimensions) specs.push(`Dimensions: ${item.dimensions}`);
  if (item.weight)     specs.push(`Weight: ${item.weight}`);
  if (item.power)      specs.push(`Power: ${item.power}`);

  const meta = [];
  if (item.origin || item.country) meta.push(`Country of Origin: ${item.origin || item.country}`);
  if (item.hsn)                    meta.push(`HSN Code: ${item.hsn}`);

  let html = `<td style="white-space:pre-line; vertical-align:top; line-height:1.3;">`;

  if (bold1) html += `<div class="cat-main">${bold1}</div>`;
  if (bold2) html += `<div class="cat-main">${bold2}</div>`;

  if (featureLines.length) {
    html += `<div style="height:8px;"></div>`;
    html += featureLines
      .map(line => `<div class="cat-sub">- ${line}</div>`)
      .join('');
  }

  if (specs.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">${specs.join('<br>')}</div>`;
  }

  if (meta.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">${meta.join('<br>')}</div>`;
  }

  html += `</td>`;
  return html;
}

/* ========= Main renderer ========= */
function renderQuoteBuilder() {
  const header = JSON.parse(localStorage.getItem('quoteHeader') || '{}');
  const inst   = header.selectedInstrument;
  const body   = document.getElementById('quoteBuilderBody');

  console.log('quoteHeader:', header);              // debug: confirm all data present
  console.log('instrument:', inst);

  if (!inst) {
    body.innerHTML = '';
    return;
  }

  const rows = [];

  // MAIN INSTRUMENT
  rows.push(`
    <tr>
      <td>001</td>
      ${formatInstrumentCell(inst)}
      <td>01</td>
      <td>${moneyINR(inst.unitPrice)}</td>
      <td>${moneyINR(inst.unitPrice)}</td>
    </tr>
  `);

  // CONFIGURATION ITEMS
  const configItems = inst.configurationItems || inst.configItems || [];
  if (configItems.length) {
    rows.push(`
      <tr style="background:#00B0F0; color:#000;">
        <td colspan="5" style="font-weight:700;">CONFIGURATION ITEMS</td>
      </tr>
    `);
    configItems.forEach((item, idx) => {
      const itemCode = String(idx + 2).padStart(3, '0');
      const qty = item.qty != null ? item.qty : 'Included';
      const upRaw = item.upInr != null ? item.upInr : 'Included';
      const tpRaw = item.tpInr != null ? item.tpInr : 'Included';
      const upCell = typeof upRaw === 'number' ? moneyINR(upRaw) : upRaw;
      const tpCell = typeof tpRaw === 'number' ? moneyINR(tpRaw) : tpRaw;

      rows.push(`
        <tr>
          <td>${itemCode}</td>
          ${formatItemCell(item)}
          <td>${qty}</td>
          <td>${upCell}</td>
          <td>${tpCell}</td>
        </tr>
      `);
    });
  }

  // ADDITIONAL ITEMS
  const additionalItems = inst.optionalItems || inst.additionalItems || [];
  if (additionalItems.length) {
    rows.push(`
      <tr style="background:#00B0F0; color:#000;">
        <td colspan="5" style="font-weight:700;">ADDITIONAL ITEMS</td>
      </tr>
    `);
    additionalItems.forEach((item, idx) => {
      const itemCode = String(idx + 1).padStart(3, '0');
      const qtyNum   = Number(item.qty || 1);
      const unitRaw  = item.price || item.unitPrice || item.upInr || 0;
      const unitNum  = Number(unitRaw);
      const totalNum = unitNum * qtyNum;

      rows.push(`
        <tr>
          <td>${itemCode}</td>
          ${formatItemCell(item)}
          <td>${qtyNum.toString().padStart(2, '0')}</td>
          <td>${moneyINR(unitNum)}</td>
          <td>${moneyINR(totalNum)}</td>
        </tr>
      `);
    });
  }

  body.innerHTML = rows.join('');
}

/* ========= Boot ========= */
populateHeader();
renderQuoteBuilder();
</script>

</body>
</html>
