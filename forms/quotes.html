<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Quotes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Aptos Display', system-ui, 'Inter', sans-serif;
      background:#f5f7fa;
      margin:0;
    }
    header {
      background:#0d6efd;
      color:#fff;
      padding:0.75rem 1.5rem;
    }
    .header-inner {
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .back-btn {
      border:none;
      background:rgba(255,255,255,0.12);
      color:#fff;
      padding:0.45rem 0.9rem;
      border-radius:999px;
      cursor:pointer;
    }
    .header-title {
      flex:1;
      text-align:center;
      font-weight:600;
      font-size:1.5rem;
    }

    .container {
      max-width:1200px;
      margin:2rem auto;
      padding:2rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }


  .quote-header {
    margin-bottom:1.5rem;
    border:1px solid #ccc;
    border-radius:8px;
    background:#fff;
    padding:2rem;
  }

  .quote-header-body {
    display:flex;
    flex-wrap:nowrap;
    align-items:flex-start;
    gap:1rem;
  }

  .quote-left,
  .quote-right {
    flex:1 1 0;
    min-width:0;
    display:flex;
    flex-direction:column;
  }

  /* --- top logo row, spans only right side visually --- */
  .quote-logo-wrap {
    text-align:right;
    margin-bottom:0.5rem;
  }
  .quote-logo-wrap img {
    max-height:70px;
    width:auto;
    display:inline-block;
  }

  /* row with company box and SALES QUOTATION, equal height */
  .quote-top-row {
    display:flex;
    gap:1rem;
    align-items:stretch;
  }

  .company-box,
  .sales-box {
    flex:1 1 0;
    background:#d0d4d9;
    display:flex;
    align-items:center;
    padding:0.75rem 1rem;
    border-radius:4px;
  }

  .company-box p {
    margin:0;
    font-size:10px;
    line-height:1.2;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .sales-title {
    margin-left:auto;
    font-weight:900;
    font-size:18px;
  }

  .hospital-box p { margin:0; font-size:13px; line-height:1.3; }
  .hospital-box span { font-size:13px; }

  .attn-box {
    margin-top:1rem;
    background:#add8e6;
    padding:0.75rem 1rem;
    border-radius:8px;
    font-weight:800;
    color:#000;
    text-align:left;
    font-size:14px;
  }

  .quote-meta-grid {
    margin-top:0.6rem;
    background:#fff;
    border-radius:4px;
    padding:0.5rem 0.75rem;
    display:grid;
    grid-template-columns:auto 1fr auto 1fr;
    column-gap:0.75rem;
    row-gap:0.55rem;
  }
  .quote-meta-grid .label {
    font-size:9px;
    font-weight:500;
    color:#222;
    text-align:left;
  }
  .quote-meta-grid .value {
    font-size:16px;
    font-weight:700;
    color:#000;
    text-align:left;
    white-space:nowrap;
  }
  .quote-meta-grid .value-small { font-size:13px; font-weight:600; }
  .quote-meta-grid .label.right,
  .quote-meta-grid .value.right { text-align:right; }

    #quoteBuilder {
      margin-top:1.5rem;
      padding:1.5rem;
      background:#f9fafc;
      border:1px solid #ddd;
      border-radius:12px;
    }
    #quoteBuilder h3 {
      margin-top:0;
      margin-bottom:0.75rem;
      color:#0d6efd;
    }

    table.quote-table {
      width:100%;
      border-collapse:collapse;
      margin-bottom:1rem;
    }
    table.quote-table th,
    table.quote-table td {
      padding:0.25rem 0.6rem;
      border-bottom:1px solid #ddd;
      text-align:left;
      vertical-align:top;
      font-size:13px;
    }
    table.quote-table th {
      background:#f0f4f8;
      font-size:12px;
      text-transform:capitalize;
      letter-spacing:0.03em;
    }

    table.quote-table th:nth-child(4),
    table.quote-table th:nth-child(5),
    table.quote-table td:nth-child(4),
    table.quote-table td:nth-child(5) {
      text-align:right;
      white-space:nowrap;
    }

    table.quote-table td:nth-child(3),
    table.quote-table th:nth-child(3) {
      text-align:center;
      white-space:nowrap;
    }

    table.quote-table td:nth-child(1),
    table.quote-table td:nth-child(2) {
      vertical-align:top;
    }

    table.quote-table .cat-sub b,
    table.quote-table .cat-sub strong {
      font-weight:500;
    }

    #termsBlock {
      margin-top:1.5rem;
      background:#fff;
      border:1px solid #ccc;
      border-radius:8px;
      padding:1rem 1.25rem;
      font-size:12px;
      line-height:1.4;
    }
    #termsBlock h4 {
      margin-top:0;
      color:#0d6efd;
      font-size:13px;
    }
    #termsBlock ul {
      padding-left:1.1rem;
      margin:0.25rem 0 0;
    }
    #termsBlock li { margin-bottom:0.15rem; }

    .section-header-label {
      font-weight:700;
    }
    .section-header-controls {
      font-weight:400;
      font-size:11px;
      float:right;
    }
    .section-header-controls label {
      cursor:pointer;
    }

    /* === Printable frame with repeating header/footer === */
    .print-frame {
      width:100%;
      border-collapse:collapse;
    }
    .print-header td,
    .print-body td,
    .print-footer td {
      padding:0;
      border:none;
    }
    .footer {
      font-size:10px;
      text-align:center;
      border-top:1px solid #ccc;
      padding-top:4px;
      margin-top:4px;
    }

    /* A4 page setup + repeating header/footer in print */
    @page {
      size:A4;
      margin:15mm 15mm 20mm 15mm;
    }

    @media print {
      body {
        margin:0;
        background:#fff;
      }
      header {
        display:none;        /* hide web UI header/back button when printing */
      }
      .container {
        margin:0;
        padding:0;
        box-shadow:none;
        border-radius:0;
      }

      thead.print-header {
        display:table-header-group;
      }
      tfoot.print-footer {
        display:table-footer-group;
      }

      .cfg-item-check,
      .opt-item-check,
      #cfgSelectAll,
      #optSelectAll,
      .section-header-controls {
        display:none;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <button type="button" class="back-btn" onclick="goBack()">← Back</button>
    <div class="header-title">QMS - Quotes</div>
  </div>
</header>

<div class="container">
  <!-- Printable frame: header (repeats), body, footer (repeats) -->
  <table class="print-frame">
    <thead class="print-header">
      <tr>
        <td>
          <div class="quote-header">
            <div class="quote-header-body">
          
              <!-- LEFT COLUMN -->
              <div class="quote-left">
                <!-- top row: company + SALES QUOTATION side by side -->
                <div class="quote-top-row">
                  <div class="company-box">
                    <p>
                      <strong>ISTOS Medical Pvt Ltd.</strong>
                      #51/5, 2nd Cross, J.C. Ind Area, Bikasipura Main Road,
                      Yelachenahalli, Bangalore - 560062
                    </p>
                  </div>
                  <div class="sales-box">
                    <div class="sales-title">SALES QUOTATION</div>
                  </div>
                </div>
          
                <!-- below that: To + Attn -->
                <div class="hospital-box">
                  <p>
                    <strong>To:</strong><br>
                    <span id="toHospitalNameLine"></span><br>
                    <span id="toHospitalAddressLine1"></span><br>
                    <span id="toHospitalAddressLine2"></span>
                  </p>
                </div>
                <div class="attn-box">KIND ATTN: <span id="toAttn"></span></div>
              </div>
          
              <!-- RIGHT COLUMN -->
              <div class="quote-right">
                <!-- logo at very top -->
                <div class="quote-logo-wrap">
                  <img src="../images/istos-logo.jpg" alt="ISTOS Medical Logo">
                </div>
          
                <!-- meta grid below logo -->
                <div class="quote-meta-grid">
                  <div class="label">Quote No.</div><div class="value" id="metaQuoteNo"></div>
                  <div class="label right">Quotation Date</div><div class="value value-small right" id="metaQuoteDate"></div>
                  <div class="label">Your Reference</div><div class="value value-small" id="metaYourRef"></div>
                  <div class="label right">Ref Date</div><div class="value value-small right" id="metaRefDate"></div>
                  <div class="label">Your Contact Person</div><div class="value value-small" id="metaContactPerson"></div>
                  <div class="label right">Handphone</div><div class="value value-small right" id="metaPhone"></div>
                  <div class="label">Email</div><div class="value value-small" id="metaEmail"></div>
                  <div class="label right">Office</div><div class="value value-small right" id="metaOffice"></div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </thead>

    <tbody class="print-body">
      <tr>
        <td>
          <div id="quoteBuilder">
            <h3>Quote Builder</h3>
            <table class="quote-table">
              <thead>
              <tr>
                <th>Item</th>
                <th>Cat / Material No.<br>Description</th>
                <th>Quantity</th>
                <th>Unit Price (INR)</th>
                <th>Total Price (INR)</th>
              </tr>
              </thead>
              <tbody id="quoteBuilderBody"></tbody>
            </table>
          </div>

          <div id="termsBlock">
            <h4>Terms and Conditions of Sale</h4>
            <ul>
              <li><strong>Validity:</strong> Offer valid for 60 days from date of quotation.</li>
              <li><strong>Delivery:</strong> 6–8 weeks from receipt of valid purchase order.</li>
              <li><strong>Payment:</strong> 100% advance via RTGS/NEFT/IMPS/Cheque/Draft.</li>
              <li><strong>Warranty:</strong> 12 months from installation against manufacturing defects.</li>
              <li><strong>GST:</strong> Extra @ 18% on all offered products.</li>
              <li><strong>Installation & Training:</strong> Free by ISTOS engineers at client site.</li>
              <li><strong>Documentation:</strong> Provided post successful installation.</li>
            </ul>
          </div>
        </td>
      </tr>
    </tbody>

    <tfoot class="print-footer">
      <tr>
        <td>
          <div class="footer">
            ISTOS Medical Pvt Ltd. · #51/5, 2nd Cross, J.C. Ind Area, Bikasipura Main Road, Yelachenahalli, Bangalore - 560062 · Phone: +91-XXXXXXXXXX
          </div>
        </td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
function goBack(){ if (window.history.length > 1) window.history.back(); }

/* ========= Generic helpers ========= */
function formatISOToDMY(iso){
  if(!iso) return '';
  const [y,m,d] = iso.split('-');
  return `${d}-${m}-${y}`;
}
function splitAddress(address){
  if(!address) return ['',''];
  const parts = address.split(',');
  if(parts.length < 2) return [address.trim(), ''];
  const line2 = parts.slice(-1)[0].trim();
  const line1 = parts.slice(0, -1).join(',').trim();
  return [line1, line2];
}
function moneyINR(value){
  const num = Number(value || 0);
  return num.toLocaleString('en-IN',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  });
}
function parseLines(raw) {
  if (!raw) return [];
  return String(raw)
    .split('\n')
    .map(l => l.trim())
    .filter(Boolean);
}

/* ========= Data access ========= */
function getQuoteHeaderRaw(){
  return JSON.parse(localStorage.getItem('quoteHeader') || '{}'); /* localStorage object */ /* [web:86][web:122] */
}
function getInstrumentsMaster(){
  return JSON.parse(localStorage.getItem('instruments') || '[]');
}
function resolveInstrumentForHeader(header){
  const all = getInstrumentsMaster();
  if (header.selectedInstrumentIndex != null && header.selectedInstrumentIndex !== '') {
    const idx = Number(header.selectedInstrumentIndex);
    if (!isNaN(idx) && all[idx]) return all[idx];
  }
  if (header.instrumentCode) {
    const instByCode = all.find(i => (i.instrumentCode || i.catalog || '') === header.instrumentCode);
    if (instByCode) return instByCode;
  }
  return null;
}

/* ========= Header handling ========= */
function validateHeader(header) {
  const errors = [];
  if (!header.quoteNo) errors.push("Quote No is missing");
  if (!header.quoteDate) errors.push("Quote Date is missing");
  if (!header.refDate) errors.push("Reference Date is missing");
  if (!header.hospitalName) errors.push("Hospital Name is missing");
  if (!header.hospitalAddress) errors.push("Hospital Address is missing");
  if (!header.contactPhone) errors.push("Contact Phone is missing");
  if (!header.contactEmail) errors.push("Contact Email is missing");
  if (errors.length) {
    alert("Validation errors:\n" + errors.join("\n"));
    return false;
  }
  return true;
}

function getInitialSelection(inst) {
  const cfgLen = (inst.configurationItems || inst.configItems || []).length;
  const optLen = (inst.optionalItems || inst.additionalItems || []).length;
  return {
    config: Array(cfgLen).fill(true),
    optional: Array(optLen).fill(true)
  };
}

function getQuoteContext(){
  const header = getQuoteHeaderRaw();
  const inst = resolveInstrumentForHeader(header);
  if (inst && !header.itemSelection) {
    header.itemSelection = getInitialSelection(inst);
    localStorage.setItem('quoteHeader', JSON.stringify(header));
  }
  return { header, inst };
}

function populateHeader() {
  const { header } = getQuoteContext();
  if (!validateHeader(header)) return;

  document.getElementById('metaQuoteNo').textContent   = header.quoteNo || '';
  document.getElementById('metaQuoteDate').textContent = formatISOToDMY(header.quoteDate);
  document.getElementById('metaYourRef').textContent   = header.yourReference || '';
  document.getElementById('metaRefDate').textContent   = formatISOToDMY(header.refDate);
  document.getElementById('metaContactPerson').textContent = header.contactPerson || '';
  document.getElementById('metaPhone').textContent     = header.contactPhone || '';
  document.getElementById('metaEmail').textContent     = header.contactEmail || '';
  document.getElementById('metaOffice').textContent    = header.officePhone || '';

  document.getElementById('toHospitalNameLine').textContent =
    header.hospitalName || 'Hospital / Client Name';

  const [line1, line2] = splitAddress(header.hospitalAddress || '');
  document.getElementById('toHospitalAddressLine1').textContent = line1 || '';
  document.getElementById('toHospitalAddressLine2').textContent = line2 || '';
  document.getElementById('toAttn').textContent = header.kindAttn || 'Attention';
}

/* ========= Cell formatters ========= */
function formatInstrumentCell(inst) {
  const code = inst.catalog || inst.code || '';
  const name = inst.instrumentName || inst.name || '';
  const descLines = parseLines(inst.longDescription || inst.description || '');

  const boldLines = [];
  if (code) boldLines.push(code);
  if (name) boldLines.push(name);
  if (descLines[0]) boldLines.push(descLines[0]);

  const restDesc = descLines.slice(1);
  const supplied = inst.suppliedWith || inst.supplied || [];

  const specs = [];
  if (inst.dimensions) specs.push(`Dimensions: ${inst.dimensions}`);
  if (inst.weight)     specs.push(`Weight: ${inst.weight}`);
  if (inst.power)      specs.push(`Power: ${inst.power}`);

  const meta = [];
  if (inst.origin || inst.country) meta.push(`Country of Origin: ${inst.origin || inst.country}`);
  if (inst.hsn)                    meta.push(`HSN Code: ${inst.hsn}`);

  let html = `<td style="white-space:pre-line; vertical-align:top; line-height:1.3;">`;

  boldLines.forEach(line => {
    html += `<div class="cat-main">${line}</div>`;
  });

  if (restDesc.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">` + restDesc.join(' ') + `</div>`;
  }

  if (supplied.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub"><strong>Supplied Complete with:</strong><br>`;
    html += supplied.map(s => ` - ${s}`).join('<br>');
    html += `</div>`;
  }

  if (specs.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">${specs.join('<br>')}</div>`;
  }

  if (meta.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">${meta.join('<br>')}</div>`;
  }

  html += `</td>`;
  return html;
}

function formatItemCell(item) {
  const code = item.code || item.catalog || '';
  const name = item.name || item.itemName || item.instrumentName || '';
  const descLines = parseLines(item.longDescription || item.description || '');

  const bold1 = code;
  const bold2 = name || descLines[0] || '';
  const featureLines = name ? descLines : descLines.slice(1);

  const specs = [];
  if (item.dimensions) specs.push(`Dimensions: ${item.dimensions}`);
  if (item.weight)     specs.push(`Weight: ${item.weight}`);
  if (item.power)      specs.push(`Power: ${item.power}`);

  const meta = [];
  if (item.origin || item.country) meta.push(`Country of Origin: ${item.origin || item.country}`);
  if (item.hsn)                    meta.push(`HSN Code: ${item.hsn}`);

  let html = `<td style="white-space:pre-line; vertical-align:top; line-height:1.3;">`;

  if (bold1) html += `<div class="cat-main">${bold1}</div>`;
  if (bold2) html += `<div class="cat-main">${bold2}</div>`;

  if (featureLines.length) {
    html += `<div style="height:8px;"></div>`;
    html += featureLines
      .map(line => `<div class="cat-sub">- ${line}</div>`)
      .join('');
  }

  if (specs.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">${specs.join('<br>')}</div>`;
  }

  if (meta.length) {
    html += `<div style="height:8px;"></div>`;
    html += `<div class="cat-sub">${meta.join('<br>')}</div>`;
  }

  html += `</td>`;
  return html;
}

/* ========= Quote builder with per-quote selection ========= */
function renderQuoteBuilder() {
  const ctx   = getQuoteContext();
  const header = ctx.header;
  const inst   = ctx.inst;
  const body   = document.getElementById('quoteBuilderBody');

  if (!inst) {
    body.innerHTML = '';
    return;
  }

  const selection = header.itemSelection || getInitialSelection(inst);
  const rows = [];

  // MAIN INSTRUMENT
  rows.push(`
    <tr>
      <td>001</td>
      ${formatInstrumentCell(inst)}
      <td>01</td>
      <td>${moneyINR(inst.unitPrice)}</td>
      <td>${moneyINR(inst.unitPrice)}</td>
    </tr>
  `);

  // CONFIGURATION ITEMS
  const configItems = inst.configurationItems || inst.configItems || [];
  if (configItems.length) {
    rows.push(`
      <tr style="background:#00B0F0; color:#000;">
        <td colspan="5" style="font-weight:700;">
          <span class="section-header-label">CONFIGURATION ITEMS</span>
          <span class="section-header-controls">
            <label>
              <input type="checkbox" id="cfgSelectAll"> Select all
            </label>
          </span>
        </td>
      </tr>
    `);

    configItems.forEach((item, idx) => {
      const selected = !selection.config || selection.config[idx] !== false;
      if (!selected) return;

      const itemCode = String(idx + 2).padStart(3, '0');
      const qty = item.qty != null ? item.qty : 'Included';
      const upRaw = item.upInr != null ? item.upInr : 'Included';
      const tpRaw = item.tpInr != null ? item.tpInr : 'Included';
      const upCell = typeof upRaw === 'number' ? moneyINR(upRaw) : upRaw;
      const tpCell = typeof tpRaw === 'number' ? moneyINR(tpRaw) : tpRaw;

      rows.push(`
        <tr>
          <td>
            <input type="checkbox"
                   class="cfg-item-check"
                   data-index="${idx}"
                   ${selected ? 'checked' : ''}>
            ${itemCode}
          </td>
          ${formatItemCell(item)}
          <td>${qty}</td>
          <td>${upCell}</td>
          <td>${tpCell}</td>
        </tr>
      `);
    });
  }

  // ADDITIONAL ITEMS
  const additionalItems = inst.optionalItems || inst.additionalItems || [];
  if (additionalItems.length) {
    rows.push(`
      <tr style="background:#00B0F0; color:#000;">
        <td colspan="5" style="font-weight:700;">
          <span class="section-header-label">ADDITIONAL ITEMS</span>
          <span class="section-header-controls">
            <label>
              <input type="checkbox" id="optSelectAll"> Select all
            </label>
          </span>
        </td>
      </tr>
    `);

    additionalItems.forEach((item, idx) => {
      const selected = !selection.optional || selection.optional[idx] !== false;
      if (!selected) return;

      const itemCode = String(idx + 1).padStart(3, '0');
      const qtyNum   = Number(item.qty || 1);
      const unitRaw  = item.price || item.unitPrice || item.upInr || 0;
      const unitNum  = Number(unitRaw);
      const totalNum = unitNum * qtyNum;

      rows.push(`
        <tr>
          <td>
            <input type="checkbox"
                   class="opt-item-check"
                   data-index="${idx}"
                   ${selected ? 'checked' : ''}>
            ${itemCode}
          </td>
          ${formatItemCell(item)}
          <td>${qtyNum.toString().padStart(2, '0')}</td>
          <td>${moneyINR(unitNum)}</td>
          <td>${moneyINR(totalNum)}</td>
        </tr>
      `);
    });
  }

  body.innerHTML = rows.join('');
  wireSelectionHandlers();
}

/* ========= Persist selection in localStorage ========= */
function wireSelectionHandlers() {
  const ctx   = getQuoteContext();
  const header = ctx.header;
  const inst   = ctx.inst;
  if (!inst) return;

  const cfgChecks = Array.from(document.querySelectorAll('.cfg-item-check'));
  const optChecks = Array.from(document.querySelectorAll('.opt-item-check'));

  function saveSelection() {
    const newSelection = {
      config: [],
      optional: []
    };

    const cfgLen = (inst.configurationItems || inst.configItems || []).length;
    const optLen = (inst.optionalItems || inst.additionalItems || []).length;

    for (let i = 0; i < cfgLen; i++) newSelection.config[i] = false;
    for (let i = 0; i < optLen; i++) newSelection.optional[i] = false;

    cfgChecks.forEach(ch => {
      const idx = Number(ch.dataset.index);
      if (!isNaN(idx)) newSelection.config[idx] = ch.checked;
    });
    optChecks.forEach(ch => {
      const idx = Number(ch.dataset.index);
      if (!isNaN(idx)) newSelection.optional[idx] = ch.checked;
    });

    header.itemSelection = newSelection;
    localStorage.setItem('quoteHeader', JSON.stringify(header)); /* persist selection */ /* [web:118][web:122] */
    renderQuoteBuilder();
  }

  cfgChecks.forEach(ch => ch.addEventListener('change', saveSelection));
  optChecks.forEach(ch => ch.addEventListener('change', saveSelection));

  const cfgAll = document.getElementById('cfgSelectAll');
  if (cfgAll) {
    cfgAll.addEventListener('change', () => {
      cfgChecks.forEach(ch => { ch.checked = cfgAll.checked; });
      saveSelection();
    });
    if (cfgChecks.length && cfgChecks.every(ch => ch.checked)) {
      cfgAll.checked = true;
    }
  }

  const optAll = document.getElementById('optSelectAll');
  if (optAll) {
    optAll.addEventListener('change', () => {
      optChecks.forEach(ch => { ch.checked = optAll.checked; });
      saveSelection();
    });
    if (optChecks.length && optChecks.every(ch => ch.checked)) {
      optAll.checked = true;
    }
  }
}

/* ========= Boot ========= */
populateHeader();
renderQuoteBuilder();
</script>
</body>
</html>
