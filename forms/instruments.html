<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QMS - Instruments</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter',sans-serif; background:#f5f7fa; margin:0; }
    header { background:#0d6efd; color:#fff; padding:0.75rem 1.5rem; }
    .header-inner { max-width:1200px; margin:0 auto; display:flex; align-items:center; gap:12px; }
    .back-btn { border:none; background:rgba(255,255,255,0.12); color:#fff; padding:0.45rem 0.9rem; border-radius:999px; cursor:pointer; }
    .header-title { flex:1; text-align:center; font-weight:600; font-size:1.5rem; }

    .container { max-width:1200px; margin:2rem auto; padding:2rem; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .top-bar h2 { color:#0d6efd; margin:0; }
    .top-bar button { background:#0d6efd; color:#fff; border:none; padding:0.6rem 1rem; border-radius:8px; cursor:pointer; }

    form { display:none; grid-template-columns:1fr 1fr; gap:1rem; margin:1rem 0 2rem; }
    form.active { display:grid; }
    form input, form select, form button, form textarea {
      padding:0.8rem;
      border:1px solid #ccc;
      border-radius:8px;
      font-size:0.95rem;
      font-family:'Inter',sans-serif;
    }
    /* multi-column fields */
    #description { grid-column:span 2; height:120px; resize:vertical; }
    #suppliedWithInput { grid-column:span 2; height:140px; resize:vertical; }
    form button[type="submit"] { grid-column:span 2; background:#0d6efd; color:#fff; border:none; cursor:pointer; }

    table { width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:1rem; }
    thead th { padding:0.8rem; background:#f0f4f8; border-bottom:1px solid #ddd; text-align:left; }
    tbody tr { background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
    td { padding:0.8rem; border-top:1px solid #eee; border-bottom:1px solid #eee; vertical-align:top; }
    tbody tr td:first-child { border-left:1px solid #eee; border-radius:8px 0 0 8px; }
    tbody tr td:last-child { border-right:1px solid #eee; border-radius:0 8px 8px 0; }
    .actions { white-space:nowrap; }
    .actions button { margin-right:0.5rem; padding:0.4rem 0.8rem; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem; }
    .edit-btn { background:#ffc107; }
    .delete-btn { background:#dc3545; color:#fff; }
    .pagination { margin-top:1rem; text-align:center; }
    .pagination button { margin:0 0.5rem; padding:0.4rem 0.8rem; border:none; border-radius:6px; background:#0d6efd; color:#fff; cursor:pointer; }

    .collapse-toggle { cursor:pointer; color:#0d6efd; font-weight:600; font-size:0.9rem; margin-bottom:0.25rem; user-select:none; }
    .details-content { display:none; font-size:0.9rem; margin-top:0.5rem; }
    .price-cell { font-weight:600; white-space:nowrap; }

    .toast-container {
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:2000;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .toast {
      min-width:220px;
      max-width:320px;
      background:#198754;
      color:#fff;
      padding:0.6rem 0.9rem;
      border-radius:6px;
      font-size:13px;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
      opacity:0;
      transform:translateY(10px);
      transition:opacity 0.25s ease, transform 0.25s ease;
    }
    .toast.show {
      opacity:1;
      transform:translateY(0);
    }
    .toast.error {
      background:#dc3545;
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <button type="button" class="back-btn" onclick="goBack()">← Back</button>
    <div class="header-title">QMS - Instruments</div>
  </div>
</header>

<div id="toastContainer" class="toast-container"></div>

<div class="container">
  <div class="top-bar">
    <h2>Instrument Master</h2>
    <button type="button" onclick="toggleForm()">Add Instrument</button>
  </div>

  <form id="instrumentForm">

    <textarea
      id="description"
      placeholder="Instrument description (first line = printed heading, next lines = bullets)"
      rows="3"
      style="width:100%;"
    ></textarea>
    
    <input
      type="text"
      id="mainItemName"
      placeholder="Main item name (e.g. pfm Rotary 3005E (Semi-Electronic Microtome))"
      required
    >

    <input
      type="text"
      id="instrumentCode"
      placeholder="Instrument Code (for quotes)"
    >

    <textarea
      id="suppliedWithInput"
      rows="8"
      placeholder="Supplied Complete with (list items). Then a blank line, then Dimensions / Weight / Power."
    ></textarea>

    <input type="text" id="origin" placeholder="Country Of Origin">
    <input type="text" id="catalog" placeholder="Catalog Reference">
    <input type="text" id="hsn" placeholder="HSN Code (1234 5678)" maxlength="9">

    <input type="text" id="unitPrice" placeholder="Basic / Unit Price (₹)">
    <input type="text" id="gstType" placeholder="GST Type">
    <input type="number" id="gstPercent" placeholder="GST %">

    <button type="submit">Save Instrument</button>
  </form>

  <table id="instrumentTable">
    <thead>
      <tr>
        <th>Description</th>
        <th>Equipment</th>
        <th>Origin</th>
        <th>Catalog</th>
        <th>HSN</th>
        <th>Code</th>
        <th>Price</th>
        <th>GST Type</th>
        <th>GST %</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination">
    <button type="button" onclick="prevPage()">Prev</button>
    <span id="pageInfo"></span>
    <button type="button" onclick="nextPage()">Next</button>
  </div>
</div>

<script>
  function showToast(message, type = 'success', duration = 1800) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    const el = document.createElement('div');
    el.className = 'toast' + (type === 'error' ? ' error' : '');
    el.textContent = message;
    container.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => {
        if (el.parentNode === container) container.removeChild(el);
      }, 250);
    }, duration);
  }

  const form = document.getElementById('instrumentForm');
  const tableBody = document.querySelector('#instrumentTable tbody');
  const pageInfo = document.getElementById('pageInfo');
  const hsnInput = document.getElementById('hsn');
  const unitPriceInput = document.getElementById('unitPrice');
  const mainItemNameInput = document.getElementById('mainItemName');
  const descriptionTextarea = document.getElementById('description');
  const suppliedWithInput = document.getElementById('suppliedWithInput');

  let instruments = JSON.parse(localStorage.getItem('instruments') || '[]');
  let currentPage = 1;
  const pageSize = 10;
  let editIndex = null;

  function goBack() {
    if (window.history.length > 1) window.history.back();
  }

  function toggleForm() {
    form.classList.toggle('active');
  }

  hsnInput.addEventListener('input', () => {
    let digits = hsnInput.value.replace(/\D/g, '').slice(0, 8);
    if (digits.length > 4) digits = digits.slice(0, 4) + ' ' + digits.slice(4);
    hsnInput.value = digits;
  });

  unitPriceInput.addEventListener('input', () => {
    let digits = unitPriceInput.value.replace(/[^\d]/g, '');
    if (!digits) {
      unitPriceInput.value = '';
      return;
    }
    const num = parseInt(digits, 10);
    unitPriceInput.value = '₹ ' + num.toLocaleString('en-IN');
  });

  function parsePriceValue(v) {
    const digits = (v || '').replace(/[^\d]/g, '');
    return digits ? parseInt(digits, 10) : 0;
  }

  function parseDetails(rawText) {
    const lines = rawText
      .split('\n')
      .map(l => l.trim())
      .filter(l => l);

    const first = lines[0] || '';
    const second = lines[1] || '';
    const rest = lines.slice(2);

    let detailsHTML = '';
    if (first) {
      detailsHTML += `<p><strong>${first}</strong></p>`;
    }
    if (second || rest.length) {
      const allBullets = [];
      if (second) allBullets.push(second);
      allBullets.push(...rest);
      const li = allBullets.map(line => `<li>${line}</li>`).join('');
      detailsHTML += `<ul>${li}</ul>`;
    }

    return {
      firstLine: first,
      secondLine: second,
      remainingLines: rest.join('\n'),
      detailsHTML
    };
  }

  function formatPriceDisplay(v) {
    return '₹ ' + Number(v || 0).toLocaleString('en-IN');
  }

  form.addEventListener('submit', e => {
    e.preventDefault();

    const {
      firstLine,
      secondLine,
      remainingLines,
      detailsHTML
    } = parseDetails(descriptionTextarea.value);

    const suppliedWithLines = (suppliedWithInput.value || '')
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);

    const instrument = {
      // main item name shown in table and used in quote dropdown
      description: mainItemNameInput.value,
      instrumentName: firstLine,          // 1st line of description textarea
      instrumentShortLine: secondLine,
      instrumentExtraLines: remainingLines,
      details: detailsHTML,               // HTML for Details column
      suppliedWith: suppliedWithLines,
      origin: document.getElementById('origin').value,
      catalog: document.getElementById('catalog').value,
      hsn: hsnInput.value,
      instrumentCode: document.getElementById('instrumentCode').value,
      unitPrice: parsePriceValue(unitPriceInput.value),
      gstType: document.getElementById('gstType').value,
      gstPercent: document.getElementById('gstPercent').value
    };

    if (editIndex !== null) {
      instruments[editIndex] = instrument;
      editIndex = null;
    } else {
      instruments.push(instrument);
    }
    localStorage.setItem('instruments', JSON.stringify(instruments));
    form.reset();
    unitPriceInput.value = '';
    form.classList.remove('active');
    renderTable();
    showToast('Instrument saved');
  });

  function renderTable() {
    tableBody.innerHTML = '';
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;

    instruments.slice(start, end).forEach((inst, i) => {
      const idx = start + i;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${inst.description || ''}</td>
        <td>
          <div class="collapse-toggle" onclick="toggleDetails(this)">Details</div>
          <div class="details-content">${inst.details || ''}</div>
        </td>
        <td>${inst.origin || ''}</td>
        <td>${inst.catalog || ''}</td>
        <td>${inst.hsn || ''}</td>
        <td>${inst.instrumentCode || ''}</td>
        <td class="price-cell">${formatPriceDisplay(inst.unitPrice)}</td>
        <td>${inst.gstType || ''}</td>
        <td>${inst.gstPercent || ''}</td>
        <td class="actions">
          <button type="button" class="edit-btn" onclick="editInstrument(${idx})">Edit</button>
          <button type="button" class="delete-btn" onclick="deleteInstrument(${idx})">Delete</button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    const totalPages = Math.ceil(instruments.length / pageSize) || 1;
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
  }

  function toggleDetails(el) {
    const d = el.nextElementSibling;
    const visible = d.style.display === 'block';
    d.style.display = visible ? 'none' : 'block';
    el.textContent = visible ? 'Details' : 'Hide details';
  }

  function editInstrument(i) {
    const inst = instruments[i];
    if (!inst) return;

    mainItemNameInput.value = inst.description || '';
    descriptionTextarea.value = [
      inst.instrumentName || '',
      inst.instrumentShortLine || '',
      inst.instrumentExtraLines || ''
    ].filter(Boolean).join('\n');

    document.getElementById('origin').value = inst.origin || '';
    document.getElementById('catalog').value = inst.catalog || '';
    hsnInput.value = inst.hsn || '';
    document.getElementById('instrumentCode').value = inst.instrumentCode || '';
    unitPriceInput.value = formatPriceDisplay(inst.unitPrice);
    document.getElementById('gstType').value = inst.gstType || '';
    document.getElementById('gstPercent').value = inst.gstPercent || '';

    suppliedWithInput.value = (inst.suppliedWith || []).join('\n');

    editIndex = i;
    form.classList.add('active');
  }

  function deleteInstrument(i) {
    instruments.splice(i, 1);
    localStorage.setItem('instruments', JSON.stringify(instruments));
    const maxPage = Math.max(1, Math.ceil(instruments.length / pageSize));
    if (currentPage > maxPage) currentPage = maxPage;
    renderTable();
  }

  function nextPage() {
    if (currentPage * pageSize < instruments.length) {
      currentPage++;
      renderTable();
    }
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
    }
  }

  // expose needed functions to inline handlers
  window.toggleDetails = toggleDetails;
  window.editInstrument = editInstrument;
  window.deleteInstrument = deleteInstrument;
  window.nextPage = nextPage;
  window.prevPage = prevPage;
  window.goBack = goBack;
  window.toggleForm = toggleForm;

  renderTable();
</script>
</body>
</html>
